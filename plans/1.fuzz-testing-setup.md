# Fuzz Testing Setup Plan

## Table of Contents
1. [Overview](#overview)
2. [Files to Create](#files-to-create)
3. [Files to Modify](#files-to-modify)
4. [Implementation Steps](#implementation-steps)
5. [Verification](#verification)

## Overview

We will set up coverage-guided fuzz testing using jsfuzz. The fuzz targets will be written in JavaScript and import the compiled TypeScript output from `out/parse/`.

## Files to Create

```
fuzz/
  scanner.fuzz.js       # Fuzz target for Scanner
  pipeline.fuzz.js      # Fuzz target for full parse pipeline
  corpus/
    scanner/            # Seed corpus for scanner
    pipeline/           # Seed corpus for full pipeline
```

## Files to Modify

- `package.json` (root) - Add jsfuzz dependency and fuzz scripts

## Implementation Steps

### Step 1: Install jsfuzz

Add jsfuzz as a dev dependency in the root package.json.

### Step 2: Create fuzz directory structure

```
mkdir -p fuzz/corpus/scanner fuzz/corpus/pipeline
```

### Step 3: Create scanner fuzz target

`fuzz/scanner.fuzz.js`:
```javascript
const { Scanner, ABCContext, AbcErrorReporter } = require('./out/parse/index.js')

module.exports.fuzz = function(buf) {
  const input = buf.toString('utf-8')
  const reporter = new AbcErrorReporter()
  const ctx = new ABCContext(reporter)
  Scanner(input, ctx)
}
```

### Step 4: Create full pipeline fuzz target

`fuzz/pipeline.fuzz.js`:
```javascript
const { Scanner, parse, ABCContext, AbcErrorReporter } = require('./out/parse/index.js')

module.exports.fuzz = function(buf) {
  const input = buf.toString('utf-8')
  const reporter = new AbcErrorReporter()
  const ctx = new ABCContext(reporter)

  const tokens = Scanner(input, ctx)
  parse(tokens, ctx)
}
```

### Step 5: Populate seed corpus

Copy existing ABC test fixtures to corpus directories:
- `parse/tests/interpreter-comparison/fixtures/**/*.abc` -> `fuzz/corpus/scanner/` and `fuzz/corpus/pipeline/`

### Step 6: Add npm scripts

In root `package.json`, add:
```json
{
  "scripts": {
    "fuzz:scanner": "npm run build -w parse && jsfuzz fuzz/scanner.fuzz.js fuzz/corpus/scanner",
    "fuzz:pipeline": "npm run build -w parse && jsfuzz fuzz/pipeline.fuzz.js fuzz/corpus/pipeline"
  },
  "devDependencies": {
    "jsfuzz": "^1.0.15"
  }
}
```

## Verification

1. Run `npm install` to install jsfuzz
2. Run `npm run build -w parse` to compile TypeScript
3. Run `npm run fuzz:scanner` - should start fuzzing and show executions/second
4. Let it run for 30-60 seconds to verify no immediate crashes
5. Press Ctrl+C to stop
6. Check that new corpus files were created in `fuzz/corpus/scanner/`
