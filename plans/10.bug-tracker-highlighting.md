# Bug Tracker: Syntax Highlighting Issues from diff-comments

## Table of Contents
- [Category 1: Decoration Handling Issues](#category-1-decoration-handling-issues)
- [Category 2: Grace Note Parsing Issues](#category-2-grace-note-parsing-issues)
- [Category 3: Inline Field and Voice Declaration Issues](#category-3-inline-field-and-voice-declaration-issues)
- [Category 4: Notes/Pitches Incorrectly Identified in Non-Note Contexts](#category-4-notespitches-incorrectly-identified-in-non-note-contexts)
- [Category 5: Line Continuation / Multi-line Issues](#category-5-line-continuation--multi-line-issues)
- [Category 6: Chord/Tie Combination Issues](#category-6-chordtie-combination-issues)
- [Category 7: Highlighting Style/Cosmetic Issues](#category-7-highlighting-stylecosmetic-issues)
- [Category 8: Header Field Value Parsing](#category-8-header-field-value-parsing)
- [Category 9: Unclear / Noise](#category-9-unclear--noise)
- [Category 10: Open Design Questions](#category-10-open-design-questions)
- [Root Cause Analysis](#root-cause-analysis)

---

## Category 1: Decoration Handling Issues

Because the `pDeco` pattern in `parse/parsers/scan_tunebody.ts:42` is defined as `/[\~\.HJLMOPRSTuv]/`, it does not include `k`, `K`, or `n`. Additionally, because the `decoration()` function (line 180) requires a lookahead matching a pitch/rest/chord immediately after the decoration characters, any `!symbol!` long-form decoration placed between shorthand decorations and the note breaks the scanner.

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/decoration_placement.abc` | 5 | `TL!tenuto!.c'2` - `!symbol!` between shorthand decorations and note breaks the scanner |
| `example_scores/visual/KeySignatureAccidentalsAndDecorations.abc` | 9 | `kA kg KA Kg` - `k` and `K` decorations are not in `pDeco` |
| `example_scores/visual/alternate_heads.abc` | 8 | `nG nB nA` - `n` decoration is not in `pDeco` |
| `example_scores/visual/Perc_749_1.abc` | 14 | `u` accent in drum map without an attached note - decoration lookahead fails |
| `example_scores/visual/abcplus_Predefined_symbols.abc` | 8 | Predefined symbol sequences (`ha`, `ia`, `ja`, etc.) - not recognized as valid tokens |
| `example_scores/visual/vertical_placement.abc` | 11 | Complex decoration sequences intermixed with inline fields |

## Category 2: Grace Note Parsing Issues

Because the `pGraceGrp` pattern (line 53) only allows `pitch + optional_duration + optional_whitespace` inside the braces, it rejects ties (`-`) and slurs (`(`, `)`) within grace notes. When the test pattern fails, `grace_grp()` returns false and the `{` becomes an INVALID token.

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/tie-test3.abc` | 5 | `{G-G}`, `{CD-DE}` - ties inside grace groups |
| `example_scores/visual/slurs_and_graces.abc` | 5 | `{c(de)g}` - slurs inside grace groups |
| `example_scores/visual/graces_with_durations_spaces_an.abc` | 6 | `{_c/2(^de)- eg4}` - combination of slurs, ties, accidentals, durations |
| `example_scores/visual/scotland.abc` | 12 | Multi-note grace groups in bagpipe notation (this one may work since `{GdGe}` fits the pattern) |

## Category 3: Inline Field and Voice Declaration Issues

The inline field pattern `/\[[ \t]*[a-zA-Z][ \t]*:[^\]]*\]/` matches correctly, but the semantic token types assigned to the brackets may be confused with chord brackets. Inline `V:` without brackets is a voice header at the start of a line, not an inline field.

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/LaMourisque_1.abc` | 23 | `V:3` and `V:4` at start of lines - these are standard voice headers, not inline fields (question of legality) |
| `example_scores/audio/voices_one_staff.abc` | 7 | `[V:1]` bracket highlighting - brackets colored as chord brackets instead of inline field brackets |
| `example_scores/audio/chords_on_multipart.abc` | 7 | `[V:Trumpet]` brackets mis-highlighted |
| `example_scores/visual/QT_3.abc` | 8 | `K:D_/E_/B^/G^/c` - quarter-tone accidentals (`_/`, `^/`) not parsed correctly in key signature |

## Category 4: Notes/Pitches Incorrectly Identified in Non-Note Contexts

When the scanner encounters pitch letters (a-g, A-G) in contexts where they are not pitches (free text, MIDI parameters, macro references), it incorrectly tokenizes them as notes.

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/phil_taylor01_02.abc` | 89 | Free text between tunes incorrectly highlighted as notation |
| `example_scores/visual/abcplus_formatting_parameters_MIDI_voic.abc` | 75 | `D` and `F` in voice/MIDI parameters highlighted as pitches |
| `example_scores/audio/band-Bb-F-and-snare.abc` | 12 | `F2` in a transposition context mis-highlighted |
| `example_scores/visual/macro-in-chord.abc` | 8 | `[ng2F2]` - macro reference `n` confused with note/decoration |
| `example_scores/audio/bad_ties_instead_of_slurs.abc` | 9 | `{A/4}` grace note with fractional duration |

## Category 5: Line Continuation / Multi-line Issues

The lyric scanner does support line continuation (`\` at end of line), but some cases still fail. Text blocks and multiline voice name parameters with `\n` escapes are not fully supported.

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/Cont_SheneiZeitim.abc` | 8 | Missing line continuation in lyric (`w:`) lines |
| `example_scores/visual/abcplus_text_inserted.abc` | 29 | Second line of text in `%%begintext` block not highlighted |
| `example_scores/visual/grand-staff-name-multiline-name.abc` | 7, 9 | `nm=Viola\nAlto` and `nm=Secundo` - multiline names in V: header `nm=` parameter |

## Category 6: Chord/Tie Combination Issues

Because the chord scanner and the tie scanner operate separately, patterns where ties appear inside chord brackets or between slurs/chords may not be properly tokenized.

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/Drone.abc` | 8 | `[DD-][ED-]` - chords with tied notes inside |
| `example_scores/visual/slurs_errors_and_combo.abc` | 8 | `(cd)-(df)` - tie between slurred groups |

## Category 7: Highlighting Style/Cosmetic Issues

These are not parsing failures, but the wrong semantic token type is applied to tokens that are correctly scanned.

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/rest1.abc` | 9 | `y` spacers should be highlighted the same color as pitches |
| `example_scores/audio/octave-clefs.abc` | 5 | `-` sign in `[K: treble-8]` not highlighted same as `+` in `[K: treble+8]` |

## Category 8: Header Field Value Parsing

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/trio.abc` | 18 | `Q:"Adagio"` - quoted strings should be allowed in Q: tempo field |
| `example_scores/visual/Wachet.abc` | 11 | `K:Eb % 3 flats` - inline comment after key signature |

## Category 9: Unclear / Noise

| File | Line | Issue |
|------|------|-------|
| `example_scores/visual/AthollHighlanders_Ahjz.abc` | 13 | Duplicate entry (same file/line listed twice) |
| `example_scores/audio/bad_ties_instead_of_slurs.abc` | 9 | Content "blalba" - test/noise entry |
| `example_scores/visual/Bad_BangMiddle.abc` | 5 | "No highlight. Are we parsing?" - unclear if the file should parse at all |

## Category 10: Open Design Questions

| Question | File | Line |
|----------|------|------|
| Should ties be allowed inside grace groups? | `example_scores/visual/tie-test3.abc` | 5 |
| Should slurs be allowed inside grace groups? | `example_scores/visual/slurs_and_graces.abc` | 5 |

---

## Root Cause Analysis

### Root Cause A: `pDeco` character class is incomplete

Location: `parse/parsers/scan_tunebody.ts:42`

The pattern `/[\~\.HJLMOPRSTuv]/` defines which characters are recognized as shorthand decorations. According to the ABC standard, `k`, `K`, and `n` are also valid shorthand decorations, but they are missing from this character class.

Affected bugs: Category 1 items for `k`, `K`, `n` decorations.

### Root Cause B: Decoration lookahead is too strict

Location: `parse/parsers/scan_tunebody.ts:180-189`

The `decoration()` function builds a regex `pDeco+(?=(pitch|rest|chord))` that requires the decoration character(s) to be immediately followed by a pitch, rest, or chord. This means:

1. If a `!symbol!` long-form decoration appears between shorthand decorations and the note (e.g., `TL!tenuto!.c'2`), the lookahead fails because `!` is not a pitch.
2. If a decoration stands alone (e.g., `u` in percussion context without a following pitch), the lookahead fails.

The scanner does not support interleaving shorthand and long-form decorations before a note.

### Root Cause C: Grace group pattern rejects ties and slurs

Location: `parse/parsers/scan_tunebody.ts:53`

The `pGraceGrp` test pattern is:
```
{\/?(pitch(duration)?[ \t]*)+}
```

This only allows the characters that are part of a pitch (accidentals + note letter + octave marks) and optional duration. Ties (`-`) and slurs (`(`, `)`) are not included, so grace groups containing them (like `{G-G}` or `{c(de)g}`) fail the initial test and the scanner never enters the grace group tokenization logic.

### Root Cause D: No semantic distinction between chord brackets and inline field brackets

Location: `parse/parsers/scan_tunebody.ts:440-477` (inline_field) vs. `parse/parsers/scan_tunebody.ts:350-414` (chord)

Both chords and inline fields use square brackets `[...]`. While the scanner correctly distinguishes them at the token level (`TT.CHRD_LEFT_BRKT` vs. `TT.INLN_FLD_LFT_BRKT`), the semantic token provider (used by the editor for highlighting) may not be mapping these distinct token types to different highlight colors.

### Root Cause E: Free text between tunes is not properly tokenized

Location: `parse/parsers/scan2.ts:147-152`

Text between tunes is captured as `TT.FREE_TXT`, but in some cases (like `phil_taylor01_02.abc`), the file structure scanner may not correctly identify where one tune ends and the free text begins, causing subsequent lines to be parsed as tune body content.

### Root Cause F: Lyric line continuation is incomplete

Location: `parse/parsers/scan_tunebody.ts:860-869`

While the lyric scanner does handle `\` line continuation, there may be edge cases where the continuation is not triggered (e.g., when the backslash is preceded by specific characters, or when the continuation spans into different field types).

### Root Cause G: `scanInfoLine2` does not recognize all valid header value formats

The Q: (tempo) field and V: (voice) field scanners do not handle all valid value formats:
- Q: does not support quoted strings like `"Adagio"`
- V: `nm=` parameter does not recognize `\n` escape sequences for multiline names

### Root Cause H: Macro references not handled in chord context

Location: `parse/parsers/scan_tunebody.ts:350-414` (chord function)

When macros (defined via `U:n=!style=x!`) are used inside chord brackets `[ng2F2]`, the chord scanner tries to parse `n` as a pitch (which fails since `n` is not in `[a-gA-G]`) or as a string, but it does not check for user-defined macro invocations inside chords.
