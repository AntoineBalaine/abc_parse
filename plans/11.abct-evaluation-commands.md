# Plan 11: ABCT Evaluation Commands

## Table of Contents

1. [Overview](#overview)
2. [Workflow](#workflow)
3. [LSP Server Changes](#lsp-server-changes)
4. [VS Code Extension Changes](#vs-code-extension-changes)
5. [Neovim Extension Changes](#neovim-extension-changes)
6. [Files to Modify/Create](#files-to-modifycreate)
7. [Implementation Order](#implementation-order)
8. [Verification](#verification)

## Related Plans

This plan focuses on the execution/evaluation flow. Other LSP capabilities are covered in separate plans:

- Plan 12: ABCT Diagnostics (unknown functions, validation)
- Plan 13: ABCT Hover Documentation (JSDoc display)
- Plan 14: ABCT Auto-completion (utility suggestions on `.`)
- Plan 15: ABCT Formatter (code formatting rules)

Note: The LSP client for ABCT is already under development. This plan defines the server-side interface.

---

## Overview

Integrate ABCT language support into the existing LSP server and editor extensions. Users will:

1. Write `.abc` files containing music
2. Write `.abct` files that import and transform ABC files
3. Execute ABCT expressions via editor commands
4. See results in both:
   - ABC output panel (text)
   - Rendered preview (sheet music)

---

## Workflow

### User Flow

```
1. User creates song.abc         (ABC music file)
2. User creates arrange.abct     (ABCT transformation script)

   # arrange.abct
   source = song.abc
   result = source | @chords |= transpose 2
   result

3. User runs "ABCT: Evaluate File" command
4. LSP server:
   a. Parses the .abct file
   b. Loads referenced .abc files from disk
   c. Executes transforms using abct/src/runtime
   d. Returns ABC string output
5. Editor shows:
   a. ABC text in output panel
   b. Rendered sheet music in preview panel
6. Optional: User runs "ABCT: Export to File" to save output
```

### Evaluation Commands (from plan #9)

| Command                  | Behavior                                      |
| ------------------------ | --------------------------------------------- |
| `abct.evaluate`          | Evaluate entire .abct file                    |
| `abct.evaluateToLine`    | Evaluate up to cursor line (for debugging)   |
| `abct.evaluateSelection` | Evaluate only selected expression             |
| `abct.exportToFile`      | Evaluate and prompt for output file path      |

---

## LSP Server Changes

### 1. Document Type Detection

Currently the LSP handles `.abc` files. Add support for `.abct` files:

```typescript
// AbcLspServer.ts
function getDocumentType(uri: string): "abc" | "abct" {
  return uri.endsWith(".abct") ? "abct" : "abc";
}
```

### 2. ABCT Document Class

Create `AbctDocument.ts` alongside existing `AbcDocument.ts`:

```typescript
class AbctDocument {
  uri: string;
  content: string;
  ast: AbctProgram | null;        // Parsed ABCT AST
  diagnostics: Diagnostic[];

  // Parse ABCT content
  parse(): void;

  // Evaluate and return ABC output
  evaluate(options: EvalOptions): EvalResult;
}

interface EvalOptions {
  toLine?: number;           // For evaluateToLine
  selection?: Range;         // For evaluateSelection
}

interface EvalResult {
  abc: string;               // ABC output text
  diagnostics: Diagnostic[]; // Errors/warnings during evaluation
}
```

### 3. File Loading for References

ABCT expressions reference external files. The LSP needs to resolve and load them:

```typescript
// File resolver
class FileResolver {
  baseDir: string;  // Directory of the .abct file

  async loadAbc(path: string): Promise<AbcDocument> {
    const fullPath = resolve(this.baseDir, path);
    const content = await readFile(fullPath, "utf-8");
    return new AbcDocument(fullPath, content);
  }
}
```

### 4. Custom Request Handlers

Add to `server.ts`:

```typescript
// Evaluate entire ABCT file
connection.onRequest("abct.evaluate", async (params: AbctEvalParams) => {
  const doc = documents.get(params.uri);
  const result = await doc.evaluate({});
  return { abc: result.abc, diagnostics: result.diagnostics };
});

// Evaluate up to specific line
connection.onRequest("abct.evaluateToLine", async (params: AbctEvalToLineParams) => {
  const doc = documents.get(params.uri);
  const result = await doc.evaluate({ toLine: params.line });
  return { abc: result.abc, diagnostics: result.diagnostics };
});

// Evaluate selection
connection.onRequest("abct.evaluateSelection", async (params: AbctEvalSelectionParams) => {
  const doc = documents.get(params.uri);
  const result = await doc.evaluate({ selection: params.selection });
  return { abc: result.abc, diagnostics: result.diagnostics };
});
```

### 5. Integration with Runtime

Bridge between LSP and the abct/src/runtime module:

```typescript
// abctEvaluator.ts
import { parse as parseAbct } from "abct/src/parser";
import { ABCTRuntime, formatSelection } from "abct/src/runtime";
import { Parser2 as parseAbc } from "parse/parsers/parse2";

async function evaluateAbct(
  abctContent: string,
  fileResolver: FileResolver,
  options: EvalOptions
): Promise<EvalResult> {
  // 1. Parse ABCT
  const abctAst = parseAbct(abctContent);

  // 2. Create runtime
  const runtime = new ABCTRuntime();

  // 3. Execute statements (respecting toLine/selection options)
  for (const stmt of abctAst.statements) {
    // Load file refs, apply selectors, execute transforms
    // ... (detailed in implementation)
  }

  // 4. Format final result to ABC
  return { abc: formatSelection(result), diagnostics };
}
```

---

## VS Code Extension Changes

### 1. Language Configuration

Register `.abct` as a new language in `package.json`:

```json
{
  "contributes": {
    "languages": [{
      "id": "abct",
      "extensions": [".abct"],
      "aliases": ["ABCT", "ABC Transform"]
    }]
  }
}
```

### 2. Commands

Add to `package.json`:

```json
{
  "contributes": {
    "commands": [
      { "command": "abct.evaluate", "title": "ABCT: Evaluate File" },
      { "command": "abct.evaluateToLine", "title": "ABCT: Evaluate to Cursor" },
      { "command": "abct.evaluateSelection", "title": "ABCT: Evaluate Selection" },
      { "command": "abct.exportToFile", "title": "ABCT: Export to ABC File" }
    ]
  }
}
```

### 3. Command Handlers

```typescript
// abctCommands.ts
export function registerAbctCommands(context: ExtensionContext, client: LanguageClient) {

  context.subscriptions.push(
    commands.registerCommand("abct.evaluate", async () => {
      const editor = window.activeTextEditor;
      if (!editor || !editor.document.uri.path.endsWith(".abct")) return;

      const result = await client.sendRequest("abct.evaluate", {
        uri: editor.document.uri.toString()
      });

      // Show ABC output in panel
      showAbcOutput(result.abc);

      // Render preview
      renderPreview(result.abc);
    })
  );

  // Similar handlers for evaluateToLine, evaluateSelection, exportToFile
}
```

### 4. Output Panel

Create a dedicated output channel for ABCT results:

```typescript
const abctOutput = window.createOutputChannel("ABCT Output");

function showAbcOutput(abc: string) {
  abctOutput.clear();
  abctOutput.appendLine(abc);
  abctOutput.show(true);
}
```

### 5. Export to File

```typescript
commands.registerCommand("abct.exportToFile", async () => {
  const result = await client.sendRequest("abct.evaluate", { uri });

  // Prompt for filename
  const saveUri = await window.showSaveDialog({
    defaultUri: Uri.file(suggestedPath),
    filters: { "ABC files": ["abc"] }
  });

  if (saveUri) {
    await workspace.fs.writeFile(saveUri, Buffer.from(result.abc));
  }
});
```

---

## Neovim Extension Changes

### 1. New Commands

Add to `lua/abc-lsp/commands.lua`:

```lua
M.abct_evaluate = function()
  local uri = vim.uri_from_bufnr(0)
  client.request("abct.evaluate", { uri = uri }, function(err, result)
    if result then
      -- Show in floating window or quickfix
      show_abc_output(result.abc)
      -- Trigger preview
      trigger_preview(result.abc)
    end
  end)
end

M.abct_evaluate_to_line = function()
  local line = vim.api.nvim_win_get_cursor(0)[1]
  -- Similar to above with toLine parameter
end

M.abct_evaluate_selection = function()
  -- Get visual selection range
  -- Similar to above with selection parameter
end

M.abct_export_to_file = function()
  vim.ui.input({ prompt = "Export to: " }, function(filename)
    -- Evaluate and write to file
  end)
end
```

### 2. User Commands

```lua
vim.api.nvim_create_user_command("AbctEvaluate", M.abct_evaluate, {})
vim.api.nvim_create_user_command("AbctEvaluateToLine", M.abct_evaluate_to_line, {})
vim.api.nvim_create_user_command("AbctEvaluateSelection", M.abct_evaluate_selection, { range = true })
vim.api.nvim_create_user_command("AbctExport", M.abct_export_to_file, {})
```

---

## Files to Modify/Create

### LSP Server (`abc-lsp-server/src/`)

| File | Action | Purpose |
|------|--------|---------|
| `AbctDocument.ts` | Create | ABCT document parsing and evaluation |
| `abctEvaluator.ts` | Create | Bridge between LSP and abct runtime |
| `fileResolver.ts` | Create | Load referenced .abc files |
| `server.ts` | Modify | Add abct.* request handlers |
| `AbcLspServer.ts` | Modify | Handle .abct document type |

### VS Code Extension (`vscode-extension/src/`)

| File | Action | Purpose |
|------|--------|---------|
| `abctCommands.ts` | Create | ABCT command handlers |
| `extension.ts` | Modify | Register ABCT commands |
| `package.json` | Modify | Add language, commands |

### Neovim Extension (`abc-lsp.nvim/`)

| File | Action | Purpose |
|------|--------|---------|
| `lua/abc-lsp/commands.lua` | Modify | Add ABCT commands |
| `lua/abc-lsp/init.lua` | Modify | Register user commands |

---

## Implementation Order

### Phase 1: LSP Core

1. Create `AbctDocument.ts` with parsing (using existing abct parser)
2. Create `fileResolver.ts` for loading ABC files
3. Create `abctEvaluator.ts` connecting parser to runtime
4. Add `abct.evaluate` handler to `server.ts`
5. Test with simple .abct files

### Phase 2: VS Code Extension

6. Add ABCT language registration to `package.json`
7. Create `abctCommands.ts` with evaluate command
8. Add output panel for ABC results
9. Connect to existing preview renderer

### Phase 3: Full Command Set

10. Implement `abct.evaluateToLine` (partial evaluation)
11. Implement `abct.evaluateSelection`
12. Implement `abct.exportToFile`

### Phase 4: Neovim Extension

13. Add ABCT commands to Neovim plugin
14. Test integration with preview server

---

## Verification

### Unit Tests

1. `AbctDocument` parses ABCT files correctly
2. `fileResolver` loads referenced ABC files
3. `abctEvaluator` executes transforms and returns ABC

### Integration Tests

1. LSP request handlers return expected ABC output
2. Partial evaluation (evaluateToLine) stops at correct statement
3. Selection evaluation processes only selected text

### Manual Testing

1. Create test.abc with simple melody
2. Create test.abct that transposes the melody
3. Run "ABCT: Evaluate File" in VS Code
4. Verify ABC output panel shows transposed result
5. Verify preview panel renders the transposed music
6. Run "ABCT: Export to File" and verify file is written

### Error Cases

1. Missing referenced file shows clear error
2. Parse errors in .abct file show diagnostics
3. Transform errors (e.g., invalid arguments) reported properly
