# Plan 13: ABCT Hover Documentation

## Table of Contents

1. [Overview](#overview)
2. [Hover Content](#hover-content)
3. [Implementation](#implementation)
4. [Files to Modify/Create](#files-to-modifycreate)
5. [Verification](#verification)

## Related Plans

- Plan 11: ABCT Evaluation Commands
- Plan 12: ABCT Diagnostics
- Plan 14: ABCT Auto-completion
- Plan 15: ABCT Formatter

---

## Overview

Display documentation when the user hovers over transforms, selectors, and other ABCT constructs. The hover shows JSDoc-style documentation from the transform registry.

---

## Hover Content

### Transform Hover

When hovering over a transform name (e.g., `transpose`):

```
transpose

Shift all pitches by n semitones.

Arguments:
  n (integer, required) - Number of semitones to shift.
                          Positive = up, negative = down.

Examples:
  transpose 2      # Up a whole step
  transpose -5     # Down a perfect fourth

See also: octave, invert
```

### Selector Hover

When hovering over a selector (e.g., `@chords`):

```
@chords (short: @c)

Select all chord nodes in the current context.

A chord is a group of notes enclosed in brackets [CEG].
Single notes are not selected by this selector.

Example:
  song.abc | @chords |= transpose 2

See also: @notes, @bars
```

### Operator Hover

When hovering over operators:

```
|= (update operator)

Focus on selected nodes, apply transform, reintegrate into original context.

The result is the full document with only the selected nodes modified.

Contrast with | (pipe) which extracts and loses context.

Example:
  file.abc | @chords |= transpose 2
  # Result: entire file with chords transposed
```

### Variable Hover

When hovering over a variable reference:

```
source (variable)

Defined at line 1:
  source = song.abc

Type: ABC file reference
```

---

## Implementation

### 1. Extend Transform Registry

Add documentation fields to transform info:

```typescript
interface TransformInfo {
  name: string;
  description: string;        // Short description
  documentation: string;      // Full markdown documentation
  args: ArgSpec[];
  examples: string[];
  seeAlso: string[];
}

interface ArgSpec {
  name: string;
  type: string;
  required: boolean;
  description: string;
  default?: string;
}
```

### 2. Hover Provider

Implement LSP hover handler:

```typescript
// abctHoverProvider.ts
export function provideHover(
  document: AbctDocument,
  position: Position
): Hover | null {
  const node = document.getNodeAtPosition(position);
  if (!node) return null;

  if (isIdentifier(node) && isInApplicationPosition(node)) {
    return getTransformHover(node.name);
  }

  if (isSelector(node)) {
    return getSelectorHover(node.path.id);
  }

  if (isOperator(node)) {
    return getOperatorHover(node.operator);
  }

  if (isIdentifier(node) && isVariableReference(node, document)) {
    return getVariableHover(node.name, document);
  }

  return null;
}
```

### 3. Markdown Formatting

Format hover content as markdown:

```typescript
function getTransformHover(name: string): Hover | null {
  const info = transformRegistry.get(name);
  if (!info) return null;

  const markdown = [
    `**${info.name}**`,
    "",
    info.description,
    "",
    "**Arguments:**",
    ...info.args.map(arg =>
      `- \`${arg.name}\` (${arg.type}${arg.required ? "" : ", optional"}) - ${arg.description}`
    ),
    "",
    "**Examples:**",
    "```abct",
    ...info.examples,
    "```"
  ];

  if (info.seeAlso.length > 0) {
    markdown.push("", `**See also:** ${info.seeAlso.join(", ")}`);
  }

  return {
    contents: {
      kind: "markdown",
      value: markdown.join("\n")
    }
  };
}
```

### 4. Position to Node Mapping

Map cursor position to AST node:

```typescript
// AbctDocument.ts
class AbctDocument {
  getNodeAtPosition(position: Position): AstNode | null {
    if (!this.ast) return null;

    // Walk AST to find node containing position
    return findNodeAtPosition(this.ast, position);
  }
}

function findNodeAtPosition(node: AstNode, position: Position): AstNode | null {
  // Check if position is within node's range
  if (!containsPosition(node.range, position)) {
    return null;
  }

  // Check children for more specific match
  for (const child of getChildren(node)) {
    const found = findNodeAtPosition(child, position);
    if (found) return found;
  }

  return node;
}
```

### 5. LSP Handler Registration

Register hover handler in server:

```typescript
// server.ts
connection.onHover((params) => {
  const doc = getAbctDocument(params.textDocument.uri);
  if (!doc) return null;

  return provideHover(doc, params.position);
});
```

---

## Files to Modify/Create

### LSP Server (`abc-lsp-server/src/`)

| File | Action | Purpose |
|------|--------|---------|
| `abct/transformRegistry.ts` | Modify | Add documentation fields |
| `abct/selectorRegistry.ts` | Modify | Add documentation fields |
| `abct/operatorDocs.ts` | Create | Documentation for operators |
| `abct/AbctHoverProvider.ts` | Create | Hover logic |
| `AbctDocument.ts` | Modify | Add getNodeAtPosition() |
| `server.ts` | Modify | Register onHover handler |

---

## Verification

### Unit Tests

1. Transform names show correct documentation
2. Selectors show correct documentation
3. Operators show correct documentation
4. Variables show definition location
5. Unknown identifiers return null (no hover)
6. Position mapping finds correct AST node

### Integration Tests

1. Hover appears after brief delay in editor
2. Hover content is formatted as markdown
3. Code examples in hover are syntax highlighted

### Manual Testing

1. Hover over `transpose`, verify documentation appears
2. Hover over `@chords`, verify selector doc appears
3. Hover over `|=`, verify operator doc appears
4. Hover over variable name, verify definition shown
5. Hover over whitespace, verify no hover
