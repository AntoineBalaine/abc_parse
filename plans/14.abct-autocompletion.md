# Plan 14: ABCT Auto-completion

## Table of Contents

1. [Overview](#overview)
2. [Completion Contexts](#completion-contexts)
3. [Implementation](#implementation)
4. [Files to Modify/Create](#files-to-modifycreate)
5. [Verification](#verification)

## Related Plans

- Plan 11: ABCT Evaluation Commands
- Plan 12: ABCT Diagnostics
- Plan 13: ABCT Hover Documentation
- Plan 15: ABCT Formatter

---

## Overview

Provide auto-completion suggestions for ABCT code. Completions are triggered by typing `.` (for method-like access) or automatically as the user types transform/selector names.

---

## Completion Contexts

### 1. Transform Names (after `|` or `|=`)

When typing after a pipe operator:

```
song.abc | @chords |= tr|
                      ~~~
Suggestions:
  transpose   Shift pitches by semitones
  truncate    Remove notes beyond duration
```

### 2. Selector Names (after `@`)

When typing after the `@` symbol:

```
song.abc | @ch|
           ~~~
Suggestions:
  @chords      Select chord nodes
  @c           (short form of @chords)
```

### 3. File Paths

When in a position expecting a file reference:

```
|
Suggestions:
  song.abc
  melody.abc
  chords.abc
  (files in current directory with .abc extension)
```

### 4. Variable Names

When typing an identifier that could be a variable:

```
result = source | @chords
output = res|
         ~~~
Suggestions:
  result   (defined at line 1)
```

### 5. Selector Arguments (after `:`)

When typing after a selector with arguments:

```
song.abc | @V:|
             ~
Suggestions:
  V:melody    (from file voices)
  V:bass
  V:1
  V:2
```

### 6. Trigger Character: `.`

The `.` character triggers completion for method-like patterns:

```
song.abc.|
        ~
Suggestions:
  (No completions - . is part of filename)

result.|
       ~
Suggestions:
  (No completions - variables don't have methods)
```

Note: In ABCT, `.` is primarily used in filenames, so `.` trigger may have limited utility. The main completions are context-triggered.

---

## Implementation

### 1. Completion Provider

```typescript
// abctCompletionProvider.ts
export function provideCompletions(
  document: AbctDocument,
  position: Position,
  triggerCharacter?: string
): CompletionItem[] {
  const context = getCompletionContext(document, position);

  switch (context.type) {
    case "transform":
      return getTransformCompletions(context.prefix);
    case "selector":
      return getSelectorCompletions(context.prefix);
    case "file":
      return getFileCompletions(document, context.prefix);
    case "variable":
      return getVariableCompletions(document, context.prefix);
    case "selectorArg":
      return getSelectorArgCompletions(document, context);
    default:
      return [];
  }
}
```

### 2. Context Detection

Determine what kind of completion is appropriate:

```typescript
interface CompletionContext {
  type: "transform" | "selector" | "file" | "variable" | "selectorArg" | "none";
  prefix: string;
  selector?: string;  // For selectorArg context
}

function getCompletionContext(
  document: AbctDocument,
  position: Position
): CompletionContext {
  const lineText = document.getLineText(position.line);
  const textBefore = lineText.substring(0, position.character);

  // After @ -> selector completion
  const selectorMatch = textBefore.match(/@(\w*)$/);
  if (selectorMatch) {
    return { type: "selector", prefix: selectorMatch[1] };
  }

  // After @selector: -> selector argument completion
  const selectorArgMatch = textBefore.match(/@(\w+):(\w*)$/);
  if (selectorArgMatch) {
    return {
      type: "selectorArg",
      selector: selectorArgMatch[1],
      prefix: selectorArgMatch[2]
    };
  }

  // After | or |= -> transform completion
  const pipeMatch = textBefore.match(/\|\s*=?\s*(\w*)$/);
  if (pipeMatch) {
    return { type: "transform", prefix: pipeMatch[1] };
  }

  // At line start or after = -> could be file or variable
  const assignMatch = textBefore.match(/=\s*(\w*)$/);
  if (assignMatch) {
    return { type: "file", prefix: assignMatch[1] };
  }

  // Default: check if we're typing an identifier
  const identMatch = textBefore.match(/(\w+)$/);
  if (identMatch) {
    return { type: "variable", prefix: identMatch[1] };
  }

  return { type: "none", prefix: "" };
}
```

### 3. Transform Completions

```typescript
function getTransformCompletions(prefix: string): CompletionItem[] {
  const items: CompletionItem[] = [];

  for (const [name, info] of transformRegistry) {
    if (name.startsWith(prefix)) {
      items.push({
        label: name,
        kind: CompletionItemKind.Function,
        detail: info.description,
        documentation: {
          kind: "markdown",
          value: info.documentation
        },
        insertText: name,
        sortText: name  // Alphabetical sorting
      });
    }
  }

  return items;
}
```

### 4. Selector Completions

```typescript
function getSelectorCompletions(prefix: string): CompletionItem[] {
  const items: CompletionItem[] = [];

  for (const [name, info] of selectorRegistry) {
    // Full form
    if (name.startsWith(prefix)) {
      items.push({
        label: `@${name}`,
        kind: CompletionItemKind.Field,
        detail: info.description,
        insertText: name,  // @ already typed
      });
    }
    // Short form
    if (info.shortForm && info.shortForm.startsWith(prefix)) {
      items.push({
        label: `@${info.shortForm}`,
        kind: CompletionItemKind.Field,
        detail: `${info.description} (short form)`,
        insertText: info.shortForm,
      });
    }
  }

  return items;
}
```

### 5. File Completions

```typescript
async function getFileCompletions(
  document: AbctDocument,
  prefix: string
): Promise<CompletionItem[]> {
  const dir = path.dirname(document.uri);
  const files = await fs.readdir(dir);

  return files
    .filter(f => f.endsWith(".abc") && f.startsWith(prefix))
    .map(f => ({
      label: f,
      kind: CompletionItemKind.File,
      detail: "ABC file",
      insertText: f
    }));
}
```

### 6. LSP Handler

```typescript
// server.ts
connection.onCompletion((params) => {
  const doc = getAbctDocument(params.textDocument.uri);
  if (!doc) return [];

  return provideCompletions(
    doc,
    params.position,
    params.context?.triggerCharacter
  );
});

// Advertise completion capability
capabilities.completionProvider = {
  triggerCharacters: [".", "@", "|"],
  resolveProvider: false
};
```

---

## Files to Modify/Create

### LSP Server (`abc-lsp-server/src/`)

| File | Action | Purpose |
|------|--------|---------|
| `abct/AbctCompletionProvider.ts` | Create | Completion logic |
| `abct/completionContext.ts` | Create | Context detection |
| `server.ts` | Modify | Register onCompletion handler |

---

## Verification

### Unit Tests

1. Transform completions filter by prefix
2. Selector completions include short forms
3. File completions list .abc files in directory
4. Variable completions include defined variables
5. Context detection identifies correct completion type
6. Empty prefix returns all options

### Integration Tests

1. Completions appear after typing `|`
2. Completions appear after typing `@`
3. File completions update when files change
4. Selecting completion inserts correct text

### Manual Testing

1. Type `| tr` and verify `transpose` suggested
2. Type `@ch` and verify `@chords` and `@c` suggested
3. At line start, verify .abc files suggested
4. Define variable, reference it elsewhere, verify completion
5. Press `.` and verify appropriate behavior
