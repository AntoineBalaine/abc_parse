# Plan: Fix Parsing Errors in Example Scores

## Table of Contents
1. [Summary](#summary)
2. [Phase 1: P: Info Line Support](#phase-1-p-info-line-support)
3. [Phase 2: Score/Staves Directive Fixes](#phase-2-scorestaves-directive-fixes)
4. [Phase 3: Directive Parameter Fixes](#phase-3-directive-parameter-fixes)
5. [Phase 4: Other Fixes](#phase-4-other-fixes)
6. [Verification](#verification)

## Summary

197 of 807 example score files have errors. This plan addresses all major categories:

| Category | Files Affected | Root Cause |
|----------|---------------|------------|
| Unknown info line key (P:) | 100 | Missing case in analyzer switch |
| Score/staves directive parsing | 26 | NUMBER tokens not handled |
| Directive parameter issues | ~15 | Spec mismatches |
| Invalid meter format | 30 | Meter parsing gaps |
| Unknown voice properties | 31 | Missing property handlers |
| Lyrics before music | 8 | Interpreter validation |

## Phase 1: P: Info Line Support

The P: (Parts) info line is not recognized because it's missing from the analyzer switch statement.

### Files to Modify

1. `parse/analyzers/info-line-analyzer.ts`
   - Add case "P" to switch statement (around line 77)
   - Add `analyzePartsInfo()` function

2. `parse/types/Expr2.ts`
   - Add `| { type: "parts"; data: string }` to `InfoLineUnion` type

### Implementation

```
Add to info-line-analyzer.ts:

case "P":
  return analyzePartsInfo(expr, analyzer);

function analyzePartsInfo(expr, analyzer):
  extract text from expr.value/value2
  return { type: "parts", data: partsString }
```

## Phase 2: Score/Staves Directive Fixes

The `parseStaffDirective()` function in directive-analyzer.ts has a switch statement that does not handle NUMBER tokens.

### Files to Modify

1. `parse/analyzers/directive-analyzer.ts` (lines 1038-1175)
   - Add case for TT.NUMBER in the switch statement
   - Numbers in score/staves are typically voice indices - handle or skip them gracefully

### Implementation

```
In parseStaffDirective() switch statement, add:

case TT.NUMBER:
  // Numbers in score/staves syntax are non-standard but some tools use them
  // Skip with warning or treat as voice reference
  continue;
```

## Phase 3: Directive Parameter Fixes

Several directives have parameter handling issues.

### Files to Modify

1. `parse/types/directive-specs.ts`
   - Update specs for: map, sep, font, topmargin, botmargin, titlecaps, landscape, flatbeams, measurebox

2. `parse/analyzers/directive-analyzer.ts`
   - Fix parameter parsing for affected directives

### Specific Fixes

| Directive | Current Issue | Fix |
|-----------|--------------|-----|
| map | "expects only one parameter" | Allow multiple parameters (note mapping syntax) |
| sep | "expects number parameters" | Handle text/mixed parameters |
| font | "expects no parameters, but got 1" | Font directive can take font name |
| topmargin/botmargin | "expects only one parameter" | Handle measurement with unit |
| titlecaps/landscape/flatbeams/measurebox | "expects no parameters" | These are boolean flags that some tools pass with values |

### Implementation Approach

For boolean directives (titlecaps, landscape, flatbeams, measurebox, jazzchords, bagpipes):

According to abcjs's implementation (abc_parse_directive.js lines 746-770), these directives simply set a boolean to `true` and ignore any trailing tokens completely. abcjs does not parse or validate parameters for these directives - it just consumes the directive name. Example from abcjs:
```javascript
case "flatbeams":tune.formatting.flatbeams = true;break;
case "landscape":multilineVars.landscape = true;break;
case "titlecaps":multilineVars.titlecaps = true;break;
case "measurebox":tune.formatting.measurebox = true;break;
```

Our implementation should match this behavior:
- Set the boolean flag to true when the directive is encountered
- Silently ignore any trailing parameters (do not parse them, do not error on them)
- This differs from directives like `graceslurs`, `partsbox`, `printtempo` which properly parse 0/1/true/false values via `addMultilineVarBool()`

For measurement directives (topmargin, botmargin):
- Accept "value unit" format (e.g., "1.5 cm")

For map directive:
- Update spec to allow multiple parameters for the mapping syntax

## Phase 4: Other Fixes

### Invalid Meter Format (30 files)

Files like `BlankStaff_*.abc` have meter issues. According to abcjs's implementation (abc_parse_header.js lines 27-140), the setMeter function supports:

1. Special symbols:
   - `C` - common time (4/4)
   - `C|` - cut time (2/2)
   - `o` - tempus perfectum (mensural notation)
   - `c` - tempus imperfectum (mensural notation)
   - `o.` - tempus perfectum prolatio
   - `c.` - tempus imperfectum prolatio
   - `none` or empty string - no meter

2. Complex meters:
   - Standard fractions: `3/4`, `6/8`
   - Compound numerators with `+`: `(3+2)/8`, `2+3/8`
   - Compound numerators with `.`: not clear from code, but tokens are allowed
   - Multiple fractions in sequence

Investigation needed:
- Determine which specific meter formats are failing in our parser
- Compare against abcjs's supported formats
- Add support for missing valid formats

### Unknown Voice Properties (31 files)

According to abcjs's implementation (abc_parse_key_voice.js lines 729-889), the following voice properties are supported:

| Property | Aliases | Description |
|----------|---------|-------------|
| clef | cl | Clef specification |
| staves | stave, stv | Staff assignment |
| brace | brc | Brace grouping |
| bracket | brk | Bracket grouping |
| name | nm | Voice/staff name |
| subname | sname, snm | Subsequent line name |
| merge | - | Merge with previous staff |
| stem/stems | - | Stem direction (up/down) |
| up/down | - | Shorthand for stem direction |
| middle | m | Middle note for clef |
| gchords | gch | Suppress chord symbols |
| space | spc | Spacing below staff |
| scale | - | Voice scale factor |
| score | - | Score transposition |
| transpose | - | Transposition |
| stafflines | - | Number of staff lines |
| staffscale | - | Staff scale factor |
| octave | - | Octave shift |
| volume | - | Volume level |
| cue | - | Cue notes (sets scale to 0.6) |
| style | - | Note head style (normal/harmonic/rhythm/x/triangle) |

Unknown voice properties in abcjs are silently ignored (no error is thrown). Our implementation should:
1. Add handlers for missing supported properties
2. Consider silently ignoring unknown properties instead of erroring (to match abcjs behavior)

Investigation needed:
- Identify which specific voice properties are causing errors in our parser
- Determine if they are standard properties we should support or non-standard extensions

### Lyrics Before Music (8 files)
- This is an interpreter-level validation
- Consider whether this should be a warning instead of an error

## Verification

1. Run the example score scanner script after each phase:
```bash
node -e "
const fs = require('fs');
const path = require('path');
const { Scanner, parse, ABCContext, AbcErrorReporter } = require('./out/parse/index.js');
const { SemanticAnalyzer } = require('./out/parse/analyzers/semantic-analyzer.js');
const { TuneInterpreter } = require('./out/parse/interpreter/TuneInterpreter.js');

// ... scan all files and count errors
"
```

2. Target metrics:
   - Phase 1: Reduce errors by ~100 files (P: info line)
   - Phase 2: Reduce errors by ~26 files (score/staves)
   - Phase 3: Reduce errors by ~15 files (directive params)
   - Phase 4: Address remaining ~50 files

3. Run test suite:
```bash
npm run test
```

4. Ensure no regressions in existing tests.
