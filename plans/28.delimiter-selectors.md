# Delimiter Selectors: Inside and Around

## Table of Contents

1. [Goal](#goal)
2. [Delimiter Types Covered](#delimiter-types-covered)
3. [Semantics](#semantics)
4. [Phase 1: Parent Map Utility](#phase-1-parent-map-utility)
5. [Phase 2: Generic Delimiter Selection Core](#phase-2-generic-delimiter-selection-core)
6. [Phase 3: Specific Delimiter Selectors](#phase-3-specific-delimiter-selectors)
7. [Phase 4: Tests](#phase-4-tests)
8. [Implementation Checklist](#implementation-checklist)

---

## Goal

We are adding "inside" and "around" selectors for delimiter-paired constructs in the CS tree. These selectors work analogously to vim text objects (`i[`, `a[`, `i{`, `a{`, `i(`, `a(`): given a cursor, they find the enclosing delimited construct and select either its inner content or the entire node.

Because plan 24 preserves delimiter tokens as children of their respective CSNodes, these selectors can identify delimiter boundaries by inspecting token types in the child list.

The selectors support two usage modes:
- Narrowing mode: the input cursor already points at a delimiter-pair node (e.g., after `selectChords`). The selector narrows to content or selects the node itself.
- Search-outward mode: the input cursor points at any descendant node (e.g., a Note inside a Chord). The selector walks up the parent chain to find the enclosing delimiter-pair node, then applies inside/around logic.

Both modes are unified in a single function: if the cursor node IS the target type, it uses that node directly; otherwise, it walks ancestors until it finds one.

---

## Delimiter Types Covered

| Type | Open token type | Close token type | Tag | Inside content |
|------|----------------|-----------------|-----|----------------|
| Chord | `TT.CHRD_LEFT_BRKT` | `TT.CHRD_RIGHT_BRKT` | `TAGS.Chord` | Notes, annotations, tokens between `[` and `]` (excludes rhythm, tie) |
| Grace group | `TT.GRC_GRP_LEFT_BRACE` | `TT.GRC_GRP_RGHT_BRACE` | `TAGS.Grace_group` | Slash and notes between `{` and `}` |
| Inline field | `TT.INLN_FLD_LFT_BRKT` | `TT.INLN_FLD_RGT_BRKT` | `TAGS.Inline_field` | Field header and text tokens between `[` and `]` |
| Grouping | `TT.LPAREN` | `TT.RPAREN` | `TAGS.Grouping` | The expression between `(` and `)` |

Tuplet and Macro/UserSymbol are excluded because they lack a wrapping open/close delimiter pair.

---

## Semantics

### "Around"

Selects the entire delimiter-pair CSNode. The result is one single-ID cursor per matched node. For a Chord `[CEG]2-`, "around" includes the brackets, the contents, the rhythm, and the tie.

### "Inside"

Selects the children between the opening and closing delimiter tokens, excluding the delimiters themselves and any trailing elements (rhythm, tie for Chords). The result is one multi-ID cursor per matched node, where the cursor's `Set<number>` contains the IDs of all content children.

If the opening or closing delimiter is missing (because the node was constructed programmatically or because of a parse error), the selector falls back to collecting all children that are not of the known delimiter token type.

### Deduplication

When multiple cursor IDs in the input resolve to the same enclosing delimiter node, only one output cursor is produced for that node. We deduplicate by the enclosing node's ID.

---

## Phase 1: Parent Map Utility

### 1.1 Location

`abct2/src/selectors/treeWalk.ts` (new file)

### 1.2 Functions

```typescript
export function buildIdMap(root: CSNode): Map<number, CSNode>
export function buildParentMap(root: CSNode): Map<number, CSNode>
export function findEnclosingByTag(
  nodeId: number,
  idMap: Map<number, CSNode>,
  parentMap: Map<number, CSNode>,
  targetTag: string
): CSNode | null
```

---

## Phase 2: Generic Delimiter Selection Core

### 2.1 Location

`abct2/src/selectors/delimiterSelectors.ts` (new file)

### 2.2 Core Functions

```typescript
interface DelimiterConfig {
  targetTag: string;
  openTokenType: TT;
  closeTokenType: TT;
}

function selectInsideDelimited(input: Selection, config: DelimiterConfig): Selection
function selectAroundDelimited(input: Selection, config: DelimiterConfig): Selection
function collectInsideIds(node: CSNode, config: DelimiterConfig): Set<number>
```

---

## Phase 3: Specific Delimiter Selectors

8 exported functions: selectInsideChord, selectAroundChord, selectInsideGraceGroup, selectAroundGraceGroup, selectInsideInlineField, selectAroundInlineField, selectInsideGrouping, selectAroundGrouping.

---

## Phase 4: Tests

Test file: `abct2/tests/delimiterSelectors.spec.ts`
Tree walk tests: `abct2/tests/treeWalk.spec.ts`

---

## Implementation Checklist

- [ ] Phase 1: Add buildParentMap and findEnclosingByTag to treeWalk.ts. Add tests. Commit.
- [ ] Phase 2: Create delimiterSelectors.ts with generic core. Commit.
- [ ] Phase 3: Add all 8 specific selectors. Commit.
- [ ] Phase 4: Create delimiterSelectors.spec.ts with all tests. Commit.
- [ ] Final verification: npm run build and npm run test both pass.
