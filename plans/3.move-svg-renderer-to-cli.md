# Plan: Move SVG Renderer from LSP Server to CLI

## Table of Contents
1. Problem Statement
2. Proposed Changes
   - 2.1 Move svg-renderer.ts to abc-cli
   - 2.2 Move svgdom dependency to abc-cli
   - 2.3 Remove LSP SVG rendering endpoint
   - 2.4 Update CLI render command import
   - 2.5 Add graceful error handling in CLI
3. Files to Modify
4. Error Handling Strategy
   - 4.1 svgdom import failure
   - 4.2 Rendering failure (getBBox, DOM errors)
   - 4.3 Font warnings
5. Verification

## 1. Problem Statement

The svg-renderer module and its svgdom dependency currently live in abc-lsp-server, but:
- The LSP server does not need headless SVG rendering (VSCode/nvim have browser environments)
- svgdom gets bundled into the VSCode extension unnecessarily
- If svgdom fails to load, it crashes the entire LSP server
- The `abc/renderSvg` LSP endpoint has no real use case for editor clients

SVG rendering is only needed for CLI usage: `abcls render file.abc > output.svg`

## 2. Proposed Changes

### 2.1 Move svg-renderer.ts to abc-cli

Move `/workspace/abc_parse/abc-lsp-server/src/svg-renderer.ts` to `/workspace/abc_parse/abc-cli/svg-renderer.ts`

### 2.2 Move svgdom dependency to abc-cli

Remove from `abc-lsp-server/package.json`:
- `svgdom`
- `@types/svgdom`

Add to `abc-cli/package.json`:
- `svgdom: "^0.1.23"`
- `@types/svgdom: "^0.1.2"` (devDependencies)

### 2.3 Remove LSP SVG rendering endpoint

In `abc-lsp-server/src/AbcLspServer.ts`:
- Remove `import type { SvgRenderResult } from "./svg-renderer"`
- Remove `SvgRenderParams` interface
- Remove `onRenderSvg` method

In `abc-lsp-server/src/server.ts`:
- Remove `abc/renderSvg` request handler

### 2.4 Update CLI render command import

In `abc-cli/commands/render.ts`:
- Change import from `../../abc-lsp-server/src/svg-renderer` to `../svg-renderer`

### 2.5 Add graceful error handling in CLI

Wrap the svgdom import in svg-renderer.ts with try/catch:
- If svgdom fails to load, throw a clear error message
- If fonts cannot be loaded, use fallback or warn the user

## 3. Files to Modify

| Action | File |
|--------|------|
| Move | `abc-lsp-server/src/svg-renderer.ts` -> `abc-cli/svg-renderer.ts` |
| Edit | `abc-lsp-server/package.json` (remove svgdom) |
| Edit | `abc-cli/package.json` (add svgdom) |
| Edit | `abc-lsp-server/src/AbcLspServer.ts` (remove onRenderSvg) |
| Edit | `abc-lsp-server/src/server.ts` (remove endpoint) |
| Edit | `abc-cli/commands/render.ts` (update import path) |

## 4. Error Handling Strategy

The CLI render command should handle failures gracefully with specific, actionable messages.

### 4.1 svgdom import failure

If svgdom cannot be imported, catch the error and print:

```
Error: Failed to load SVG rendering library.

Details: <actual error message from the import>

This usually means the 'svgdom' package is not installed or failed to build.
If you installed abcls globally, try reinstalling:
  npm uninstall -g abcls && npm install -g abcls

If you're running from source:
  cd <path-to-abc_parse>/abc-cli && npm install
```

Exit with code 1.

### 4.2 Rendering failure (getBBox, DOM errors)

If rendering fails after svgdom loads:

```
Error: SVG rendering failed.

Details: <actual error message>

The ABC content may be valid but contains elements that cannot be rendered
in a headless environment. Try rendering in a browser instead.
```

Exit with code 1.

### 4.3 Font warnings

If svgdom warns about missing fonts, let it pass through to stderr but continue rendering. The output may have positioning issues but will still be usable.

## 5. Verification

1. Build all packages: `npm run build`
2. Run tests: `npm run test`
3. Test CLI rendering: `node out/abc-cli/abcls-cli.js render example_scores/all/after_youve_gone.abc > test.svg`
4. Verify SVG output is valid
5. Build and package VSCode extension: `npm run package:vscode`
6. Verify extension loads without svgdom errors
7. Verify extension size is smaller (no svgdom bundled)
