# Integrate abcjs-vscode Renderer into ABCLS Extension

## Table of Contents

1. [Overview](#overview)
2. [Git Subtree Integration](#git-subtree-integration)
3. [Directory Structure](#directory-structure)
4. [Files to Keep vs Discard](#files-to-keep-vs-discard)
5. [Implementation Steps](#implementation-steps)
6. [ABCx Conversion Hook](#abcx-conversion-hook)
7. [Package.json Updates](#packagejson-updates)
8. [License Attribution](#license-attribution)
9. [Verification](#verification)

---

## Overview

Pull the abcjs-vscode renderer code into abc_parse's vscode-extension via git subtree, preserving commit history and author attribution. The key feature is adding an ABCx-to-ABC conversion hook before rendering.

Current state:
- abc_parse/vscode-extension has LSP client, MIDI input, rhythm transforms
- It declares `alensiljak.abcjs-vscode` as external dependency
- abcjs-vscode has rendering logic (460 lines), HTML templates, grammar file

Target state:
- Single extension with all functionality integrated
- ABCx files converted to ABC before rendering
- GPL-3.0 attribution preserved

---

## Git Subtree Integration

Create branch and pull subtree:

```
cd /workspace/abc_parse
git checkout -b feature/integrate-abcjs-renderer
git subtree add --prefix=vscode-extension/renderer ../abcjs-vscode main
```

This places abcjs-vscode content under `vscode-extension/renderer/` with full history preserved.

---

## Directory Structure

After integration:

```
vscode-extension/
  src/
    extension.ts              # Modified: add renderer initialization
    extensionCommands.ts      # Existing: transform + MIDI commands
    renderer/
      AbcRenderer.ts          # NEW: preview panel + ABCx conversion
      rendererCommands.ts     # NEW: preview/export command handlers
      viewerHtml.ts           # NEW: HTML template builder
  renderer/                   # Subtree from abcjs-vscode
    res/
      viewer.html             # Keep: core template
      print.html              # Keep: print template
      export.html             # Keep: export wrapper
    abc.tmGrammar.json        # Keep: syntax highlighting
    snippets.json             # Keep: ABC snippets
    LICENSE.md                # Keep: GPL attribution
    src/extension.ts          # Reference only, logic extracted
    package.json              # Reference only, config merged
```

---

## Files to Keep vs Discard

From `renderer/` (subtree):

Keep:
- `res/viewer.html` - core rendering template
- `res/print.html` - print template
- `res/export.html` - export wrapper
- `abc.tmGrammar.json` - syntax highlighting (abc_parse has none)
- `snippets.json` - useful ABC snippets
- `LICENSE.md` - required for GPL

Discard after extracting logic:
- `src/` - logic moved to `src/renderer/`
- `package.json` - config merged into parent
- `tsconfig.json` - use parent config
- `.vscode/` - dev settings
- `node_modules/` - not in subtree
- Test files - will write new tests

---

## Implementation Steps

### Phase 1: Subtree and Branch Setup

1. Create feature branch
2. Run git subtree add
3. Verify subtree content

### Phase 2: Create New Source Files

Create in a single operation:
- `src/renderer/AbcRenderer.ts`
- `src/renderer/rendererCommands.ts`
- `src/renderer/viewerHtml.ts`

### Phase 3: Extract and Adapt Logic

From `renderer/src/extension.ts`, extract into new modules:

AbcRenderer.ts:
- Panel creation and management
- Content change handling
- Configuration reading
- ABCx conversion hook (the key addition)

rendererCommands.ts:
- showPreview command
- exportHtml command
- exportSvg command
- printPreview command

viewerHtml.ts:
- HTML template loading
- Template variable substitution

### Phase 4: Modify Entry Point

Update `src/extension.ts`:
- Import renderer modules
- Call `registerRendererCommands(context)` in activate()
- Initialize AbcRenderer

### Phase 5: Update package.json

- Add renderer commands
- Add renderer configuration options
- Remove `extensionDependencies` on abcjs-vscode
- Add grammar file reference
- Update license to GPL-3.0-or-later

### Phase 6: Update Build

- Copy `renderer/res/` to output directory in esbuild.js
- Ensure HTML templates are included

### Phase 7: Cleanup

- Remove unused files from renderer/
- Run tests
- Verify rendering works for .abc and .abcx files

---

## ABCx Conversion Hook

The conversion happens in AbcRenderer before sending content to the webview:

```
class AbcRenderer
  getContentForPreview(document)
    content = document.getText()

    if document.fileName.endsWith('.abcx')
      return this.convertAbcxToAbc(content)

    return content

  convertAbcxToAbc(content)
    ctx = new ABCContext(new AbcErrorReporter())
    tokens = Scanner(content, ctx)
    ast = parse(tokens, ctx)

    converter = new AbcxToAbcConverter(ctx)
    abcAst = converter.convert(ast)

    formatter = new AbcFormatter(ctx)
    return formatter.stringify(abcAst)  // stringify preserves original formatting
```

Critical files for conversion:
- `/workspace/abc_parse/parse/Visitors/AbcxToAbcConverter.ts` - existing converter
- `/workspace/abc_parse/parse/Visitors/Formatter2.ts` - AbcFormatter with stringify()

---

## Package.json Updates

Commands to add:

```json
{
  "command": "abc.showPreview",
  "title": "ABC: Show Preview"
},
{
  "command": "abc.exportHtml",
  "title": "ABC: Export as HTML"
},
{
  "command": "abc.exportSvg",
  "title": "ABC: Export as SVG"
},
{
  "command": "abc.printPreview",
  "title": "ABC: Print Preview"
}
```

Configuration to add:

```json
"abc.renderer.responsive": { "type": "string", "default": "resize" },
"abc.renderer.jazzchords": { "type": "boolean", "default": false },
"abc.renderer.tablature": { "type": "string", "enum": ["", "Violin", "Guitar"] },
"abc.renderer.visualTranspose": { "type": "integer", "default": 0 }
```

Remove:

```json
"extensionDependencies": ["alensiljak.abcjs-vscode"]
```

Add grammar:

```json
"grammars": [{
  "language": "abc",
  "scopeName": "source.abc",
  "path": "./renderer/abc.tmGrammar.json"
}]
```

---

## License Attribution

abc_parse is LGPL-3.0. Incorporating GPL-3.0 code requires:

1. Keep `renderer/LICENSE.md` in place
2. Update root LICENSE or add NOTICE file mentioning GPL components
3. Update package.json license field if needed
4. Add attribution in README:

```
## Attribution

The renderer component is based on abcjs-vscode by Alen Siljak,
licensed under GPL-3.0-or-later.
```

---

## Verification

1. Build the extension: `npm run build`
2. Open a .abc file, run "ABC: Show Preview" - should render
3. Open a .abcx file, run "ABC: Show Preview" - should convert and render
4. Test export commands (HTML, SVG)
5. Test print preview
6. Run test suite: `npm run test`
7. Verify syntax highlighting works
8. Package extension: `vsce package`
