# Music-Theory Module Refactor

## Table of Contents

1. [Problem Statement](#problem-statement)
2. [Current State Analysis](#current-state-analysis)
3. [Design](#design)
4. [Implementation Plan](#implementation-plan)
5. [Files to Modify](#files-to-modify)
6. [Verification](#verification)
7. [To Do List](#to-do-list)

---

## Problem Statement

The music-theory module on `feature/chord-symbol-parser` creates parallel infrastructure that duplicates the main scanner:

| Main Scanner | Music-Theory Module |
|--------------|---------------------|
| `TT` enum | `ChordTT` enum |
| `Token` class | `ChordToken` interface |
| `Ctx` context | `ChordScanCtx` context |

This parallel infrastructure:
- Cannot integrate with the main scanner pipeline
- Requires conversion between token types
- Adds unnecessary complexity

The current flow is:
```
string → scanChordSymbol() → ChordToken[] → parseChordSymbol() → ParsedChord
```

We should simplify to:
```
string → parseChordString() → ParsedChord
```

---

## Current State Analysis

### Files on feature/chord-symbol-parser Branch

| File | Purpose |
|------|---------|
| `types.ts` | Defines ChordTT, ChordToken, ChordQuality, ChordAlteration, ParsedChord |
| `scanChordSymbol.ts` | Tokenizes chord string to ChordToken[] |
| `parseChordSymbol.ts` | Converts ChordToken[] to ParsedChord |
| `chordPitches.ts` | Converts ParsedChord to MIDI pitch numbers |
| `index.ts` | Exports analyzeChordSymbol() and all types |

### ChordTT Enum (to be removed)
```typescript
enum ChordTT {
  ROOT,        // A-G
  ACCIDENTAL,  // # or b
  QUALITY,     // maj, min, dim, aug, etc.
  EXTENSION,   // 5, 6, 7, 9, 11, 13, 69
  ALTERATION,  // #5, b9, #11, etc.
  BASS_SLASH   // /
}
```

### Current Two-Step Process
1. `scanChordSymbol(str)` returns `{ tokens: ChordToken[], consumed: number }`
2. `parseChordSymbol(tokens)` returns `ParsedChord | null`

### Consumer: backtrackSelector.ts
```typescript
import { scanChordSymbol, parseChordSymbol } from "parse/music-theory";
// ...
const scanResult = scanChordSymbol(text);
const parsed = parseChordSymbol(scanResult.tokens);
```

---

## Design

Merge scanning and parsing into a single function that directly produces ParsedChord:

```typescript
function parseChordString(input: string): ParsedChord | null
```

This function will:
1. Use regex patterns to extract components (root, accidental, quality, extensions, alterations, bass)
2. Build ParsedChord directly without intermediate tokens
3. Return null for invalid input

The `consumed` field from the current `ScanResult` is dropped. The current consumer (`backtrackSelector.ts`) does not use it - it only checks if the result is null and uses the parsed chord.

Benefits:
- No parallel token infrastructure
- Simpler API for consumers
- Easier to maintain and test

---

## Implementation Plan

1. **Remove parallel infrastructure from `types.ts`**
   - REMOVE: `ChordTT` enum
   - REMOVE: `ChordToken` interface
   - KEEP: `ChordQuality`, `ChordAlteration`, `ParsedChord`

2. **Rename `scanChordSymbol.ts` to `parseChordString.ts`**
   - Rename file
   - Rewrite function to parse directly to ParsedChord
   - Remove `ChordScanCtx` and `ScanResult` types
   - New signature: `parseChordString(input: string): ParsedChord | null`

3. **Delete `parseChordSymbol.ts`**
   - Functionality merged into parseChordString.ts
   - Keep the quality inference logic (applyQualityInference)

4. **Update `chordPitches.ts`**
   - No changes needed (already uses ParsedChord)
   - Consider extracting ROOT_TO_SEMITONE to shared pitchUtils.ts (optional)

5. **Update `index.ts`**
   - Export `parseChordString` instead of `scanChordSymbol` + `parseChordSymbol`
   - Update `analyzeChordSymbol()` to use `parseChordString()`
   - Remove ChordTT, ChordToken from exports

6. **Update consumer: `backtrackSelector.ts`**
   - Import `parseChordString` instead of `scanChordSymbol` + `parseChordSymbol`
   - Simplify: `const parsed = parseChordString(text)`

7. **Update tests**
   - Rename `scanChordSymbol.spec.ts` to `parseChordString.spec.ts`
   - Update test imports and assertions
   - Tests verify ParsedChord output directly (no token assertions)

---

## Files to Modify

| File | Action |
|------|--------|
| `parse/music-theory/types.ts` | Remove ChordTT, ChordToken; keep ParsedChord, ChordQuality, ChordAlteration |
| `parse/music-theory/scanChordSymbol.ts` | Rename to `parseChordString.ts`, rewrite to parse directly |
| `parse/music-theory/parseChordSymbol.ts` | DELETE (merge into parseChordString.ts) |
| `parse/music-theory/chordPitches.ts` | No changes (or optional: extract pitch utilities) |
| `parse/music-theory/index.ts` | Update exports |
| `parse/index.ts` | Verify re-exports from music-theory work correctly |
| `abct2/src/selectors/backtrackSelector.ts` | Update deep import paths (currently uses `abc-parser/dist/music-theory/scanChordSymbol`), simplify to use parseChordString |
| `abct2/tests/backtrackSelector.spec.ts` | Verify ChordQuality import still works; run tests |
| `parse/tests/scanChordSymbol.spec.ts` | Rename to `parseChordString.spec.ts`, update assertions |
| `parse/tests/parseChordSymbol.spec.ts` | DELETE or merge into parseChordString.spec.ts |
| `parse/tests/chordPitches.spec.ts` | Update `getPitches()` helper to use parseChordString |

---

## Verification

1. **parseChordString produces correct ParsedChord**:
   - `parseChordString("C")` → `{ root: KeyRoot.C, quality: ChordQuality.Major, ... }`
   - `parseChordString("Am7")` → `{ root: KeyRoot.A, quality: ChordQuality.Minor, extension: 7, ... }`
   - `parseChordString("Cmaj7#11")` → includes alteration `{ degree: 11, type: Sharp }`
   - `parseChordString("G/B")` → includes bass `{ root: KeyRoot.B, accidental: None }`

2. **chordToPitches still works**:
   - `chordToPitches(parseChordString("C"))` → `[60, 64, 67]` (C major triad)
   - `chordToPitches(parseChordString("Am7"))` → `[57, 60, 64, 67]` (A minor 7th)

3. **backtrackSelector still works**:
   - Can find chord symbols in AST
   - Returns correct ParsedChord

4. **No parallel infrastructure**:
   - ChordTT enum removed
   - ChordToken interface removed
   - ChordScanCtx removed

---

## To Do List

1. Create worktree from `feature/chord-symbol-parser` branch
2. Remove `ChordTT` and `ChordToken` from `parse/music-theory/types.ts`
3. Rename `scanChordSymbol.ts` to `parseChordString.ts`
4. Rewrite `parseChordString()` to parse directly to ParsedChord
5. Delete `parseChordSymbol.ts` (merge logic into parseChordString.ts)
6. Update `index.ts` exports
7. Update `backtrackSelector.ts` to use `parseChordString()`
8. Rename and update tests
9. Run `npm run test` to verify all tests pass
10. Final verification: build and tests both pass.
11. Call the code review agent. Address any feedback.
12. Commit once the build passes and all tests pass.
