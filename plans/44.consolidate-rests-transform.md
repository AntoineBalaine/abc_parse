# Consolidate Rests Transform

## Table of Contents

1. [Overview](#overview)
2. [Phase 1: Core Transform Implementation](#phase-1-core-transform-implementation)
3. [Phase 2: Unit Tests](#phase-2-unit-tests)
4. [Phase 3: Language Server Integration](#phase-3-language-server-integration)
5. [Phase 4: VS Code Extension Integration](#phase-4-vs-code-extension-integration)
6. [Phase 5: Final Verification](#phase-5-final-verification)
7. [To Do List](#to-do-list)

## Overview

This plan implements a `consolidateRests` transform for abct2 that combines consecutive identical rests into a single rest with doubled duration. The transform uses a conservative approach: it only performs "safe" consolidations where both rests have identical duration and the result is a power-of-two duration (no dotted rests).

### Conservative Consolidation Rules

Valid consolidations (assuming same rest type z/x):
- `z/8 + z/8` becomes `z/4`
- `z/4 + z/4` becomes `z/2`
- `z/2 + z/2` becomes `z`
- `z/16 + z/16` becomes `z/8`

Invalid (skipped):
- `z/8 + z/4` would yield `z3/8` (different durations)
- `z/8 + z/8 + z/8` would yield `z3/8` (result is dotted, not power-of-2)
- `z + x` (different rest types)

Consolidation stops at:
- Bar lines
- Voice-changing inline fields

The user controls what gets consolidated through their selection. No time signature awareness or beat position tracking is performed.

---

## Phase 1: Core Transform Implementation

### Goal

Implement `consolidateRests` transform in `abct2/src/transforms/consolidateRests.ts`.

### Algorithm

```
function consolidateRests(selection, ctx):
  consumedIds = new Set()

  for each cursor in selection.cursors
    nodes = findNodesById(root, cursor)
    restNodes = filter to Rest only

    for each restNode in restNodes
      if consumedIds.has(restNode.id), skip

      restType = getRestType(restNode)  // 'z' or 'x'
      rhythm1 = getNodeRhythm(restNode)

      next = nextMeaningfulSibling(restNode)  // skip whitespace

      if next == null, continue
      if isBarLine(next) or isVoiceChangingField(next), continue
      if not isRest(next), continue
      if getRestType(next) != restType, continue

      rhythm2 = getNodeRhythm(next)
      if not equalRational(rhythm1, rhythm2), continue

      summed = addRational(rhythm1, rhythm2)
      if not isPowerOfTwoRational(summed), continue

      // Consolidate
      newRhythm = rationalToRhythm(summed, ctx)
      replaceRhythm(restNode, newRhythm)
      removeNodeFromParent(root, next)
      consumedIds.add(next.id)
      cursor.delete(next.id)

  return selection
```

### Helper Functions

```typescript
// Extract 'z' or 'x' from rest token
function getRestType(restNode: CSNode): string {
  // Walk children to find the rest token, return its lexeme
}

// Check if rational is 2^n / 2^m for integers n, m >= 0
function isPowerOfTwoRational(r: IRational): boolean {
  return isPowerOfTwo(r.numerator) && isPowerOfTwo(r.denominator);
}

function isPowerOfTwo(n: number): boolean {
  return n > 0 && (n & (n - 1)) === 0;
}

// Compare two rationals for equality
function equalRational(a: IRational, b: IRational): boolean {
  return a.numerator === b.numerator && a.denominator === b.denominator;
}

// Skip whitespace nodes to find next meaningful sibling
function nextMeaningfulSibling(node: CSNode): CSNode | null {
  let current = node.nextSibling;
  while (current !== null) {
    if (!isWhitespace(current)) return current;
    current = current.nextSibling;
  }
  return null;
}

// Check if node is an inline field containing voice directive [V:...]
function isVoiceChangingField(node: CSNode): boolean {
  // Check if node is InlineField and contains V: directive
}
```

### Files to Create/Modify

| File | Action |
|------|--------|
| `abct2/src/transforms/consolidateRests.ts` | Create |
| `abct2/src/transforms/index.ts` | Add export |

### Function Signature

```typescript
export function consolidateRests(selection: Selection, ctx: ABCContext): Selection
```

### Imports

From `abc-parser`:
- `ABCContext`
- `IRational`
- `addRational`
- `createRational`
- `TT`

From local modules:
- `Selection` from `../selection`
- `CSNode`, `TAGS`, `isRest`, `isBarLine`, `isTokenNode`, `getTokenData` from `../csTree/types`
- `findNodesById` from `./types`
- `getNodeRhythm`, `rationalToRhythm` from `./rhythm`
- `findParent`, `removeChild`, `replaceRhythm` from `./treeUtils`

---

## Phase 2: Unit Tests

### Goal

Write tests for the `consolidateRests` transform following the existing test patterns (example-based and property-based with mocha + fast-check).

### Test File

`abct2/tests/consolidateRests.spec.ts`

### Example-Based Tests

| Test Case | Input | Expected Output |
|-----------|-------|-----------------|
| Two eighth rests to quarter | `z/2 z/2 \|` | `z \|` |
| Two quarter rests to half | `z z \|` | `z2 \|` |
| Two half rests to whole | `z2 z2 \|` | `z4 \|` |
| Different durations: no change | `z z/2 \|` | `z z/2 \|` |
| Different types: no change | `z x \|` | `z x \|` |
| Invisible rests consolidate | `x x \|` | `x2 \|` |
| Bar line stops consolidation | `z \| z` | `z \| z` |
| Three identical rests: first two consolidate | `z z z \|` | `z2 z \|` |
| Non-power-of-two result: no change | `z/3 z/3 \|` | `z/3 z/3 \|` |
| Note between rests: no change | `z C z \|` | `z C z \|` |
| Selection of only first rest: no change | select first `z` in `z z \|` | `z z \|` |

### Property-Based Tests

1. Idempotence: Applying `consolidateRests` twice yields same result as once.

2. Total duration preserved: Sum of rest durations before equals sum after.

3. Rest count non-increasing: Number of rests after <= number before.

4. Type preservation: No `z` becomes `x` or vice versa.

### Imports

```typescript
import { expect } from "chai";
import { describe, it } from "mocha";
import * as fc from "fast-check";
import { toCSTreeWithContext, formatSelection, findByTag } from "./helpers";
import { TAGS } from "../src/csTree/types";
import { Selection } from "../src/selection";
import { consolidateRests } from "../src/transforms/consolidateRests";
import { sumRhythm } from "../src/transforms/sumRhythm";
```

---

## Phase 3: Language Server Integration

### Goal

Register `consolidateRests` in the language server's transform lookup and allow zero-argument transforms.

### Files to Modify

| File | Action |
|------|--------|
| `abc-lsp-server/src/transformLookup.ts` | Add consolidateRests to TRANSFORM_MAP |
| `abc-lsp-server/src/server.ts` | Remove args requirement check |

### Changes to transformLookup.ts

```typescript
import { Selection } from "../../abct2/src/selection";
import { ABCContext } from "abc-parser";
import { harmonize } from "../../abct2/src/transforms/harmonize";
import { consolidateRests } from "../../abct2/src/transforms/consolidateRests";

type TransformFn = (sel: Selection, ctx: ABCContext, ...args: number[]) => Selection;

const TRANSFORM_MAP: Record<string, TransformFn> = {
  harmonize: (sel, ctx, steps) => harmonize(sel, steps, ctx),
  consolidateRests: (sel, ctx) => consolidateRests(sel, ctx),
};

export function lookupTransform(name: string): TransformFn | null {
  return TRANSFORM_MAP[name] ?? null;
}
```

### Changes to server.ts

Remove the args requirement check (lines 357-359):

```typescript
// Remove these lines:
// if (!params.args || params.args.length === 0) {
//   throw new ResponseError(-1, `Transform "${params.transform}" requires arguments`);
// }

// Change to:
const resultSelection = transformFn(inputSelection, doc.ctx, ...(params.args ?? []));
```

---

## Phase 4: VS Code Extension Integration

### Goal

Add `consolidateRests` command following the existing pattern, with tag-based node selection for rests.

### Files to Modify

| File | Action |
|------|--------|
| `abc-lsp-server/src/selectionRangeResolver.ts` | Add generic `findNodesInRange` |
| `abc-lsp-server/src/server.ts` | Add `TRANSFORM_NODE_TAGS`, use `findNodesInRange` |
| `vscode-extension/src/transformCommands.ts` | Add consolidateRests to `transformCommands` array |
| `vscode-extension/package.json` | Register command |

### Changes to selectionRangeResolver.ts

Add generic `findNodesInRange` function:

```typescript
function collectNodesInRange(
  node: CSNode,
  editorRange: EditorRange,
  tags: Set<string>,
  result: number[]
): void {
  if (tags.has(node.tag)) {
    const nodeRange = computeNodeRange(node);
    if (nodeRange && rangesOverlap(editorRange, nodeRange)) {
      result.push(node.id);
    }
  }
  let child = node.firstChild;
  while (child) {
    collectNodesInRange(child, editorRange, tags, result);
    child = child.nextSibling;
  }
}

export function findNodesInRange(
  root: CSNode,
  editorRange: EditorRange,
  tags: string[]
): number[] {
  const result: number[] = [];
  const tagSet = new Set(tags);
  collectNodesInRange(root, editorRange, tagSet, result);
  return result;
}

// Backwards compatibility
export function findNotesAndChordsInRange(root: CSNode, editorRange: EditorRange): number[] {
  return findNodesInRange(root, editorRange, [TAGS.Note, TAGS.Chord]);
}
```

### Changes to server.ts

Add tag lookup table and update handler:

```typescript
import { findNodesInRange } from "./selectionRangeResolver";
import { TAGS } from "../../abct2/src/csTree/types";

const TRANSFORM_NODE_TAGS: Record<string, string[]> = {
  harmonize: [TAGS.Note, TAGS.Chord],
  consolidateRests: [TAGS.Rest],
};

// In the handler, replace:
//   nodeIds = findNotesAndChordsInRange(root, params.selection);
// with:
const tags = TRANSFORM_NODE_TAGS[params.transform] ?? [TAGS.Note, TAGS.Chord];
nodeIds = findNodesInRange(root, params.selection, tags);
```

### Changes to transformCommands.ts

Add consolidateRests to the existing `transformCommands` array:

```typescript
const transformCommands: Array<[string, string, number[], string]> = [
  ["abc.harmonize3rdUp", "harmonize", [2], "3rd up"],
  ["abc.harmonize3rdDown", "harmonize", [-2], "3rd down"],
  ["abc.harmonize4thUp", "harmonize", [3], "4th up"],
  ["abc.harmonize4thDown", "harmonize", [-3], "4th down"],
  ["abc.harmonize5thUp", "harmonize", [4], "5th up"],
  ["abc.harmonize5thDown", "harmonize", [-4], "5th down"],
  ["abc.harmonize6thUp", "harmonize", [5], "6th up"],
  ["abc.harmonize6thDown", "harmonize", [-5], "6th down"],
  ["abc.consolidateRests", "consolidateRests", [], "Consolidate rests"],
];
```

### Changes to package.json

Add to `contributes.commands` array:

```json
{
  "command": "abc.consolidateRests",
  "title": "ABC: Consolidate Rests"
}
```

---

## Phase 5: Final Verification

### Goal

Ensure the build passes, all tests pass, and the feature is properly integrated.

### Verification Steps

1. Run `npm run build` from repo root - verify success
2. Run `npm run test` from repo root - verify all tests pass
3. Manual testing in VS Code:
   - Select consecutive identical rests
   - Invoke "ABC: Consolidate Rests" command
   - Verify rests are consolidated correctly
   - Verify bar lines stop consolidation
   - Verify different rest types are not merged

---

## To Do List

1. Create `abct2/src/transforms/consolidateRests.ts` with the transform implementation
2. Export the transform from `abct2/src/transforms/index.ts`
3. Create `abct2/tests/consolidateRests.spec.ts` with example-based and property-based tests
4. Add `consolidateRests` to `abc-lsp-server/src/transformLookup.ts`
5. Add `findNodesInRange` to `abc-lsp-server/src/selectionRangeResolver.ts`
6. Update `abc-lsp-server/src/server.ts`:
   - Add `TRANSFORM_NODE_TAGS` lookup table
   - Update handler to use tag-based node finding
   - Remove the args requirement check
7. Add consolidateRests to `transformCommands` array in `vscode-extension/src/transformCommands.ts`
8. Register command in `vscode-extension/package.json`
9. Final verification: build and tests both pass
10. Call the code review agent. Address any feedback.
11. Commit once the build passes and all tests pass.

### Commit Message Format

```
abct2: implement consolidateRests transform

Adds a new transform that consolidates consecutive identical rests
into a single rest with doubled duration. Only performs "safe"
consolidations where the result is a power-of-two duration.

Includes:
- Core transform in abct2/src/transforms/consolidateRests.ts
- Unit tests with example-based and property-based coverage
- Language server integration via abct2.applyTransform
- VS Code command abc.consolidateRests
- Generic findNodesInRange for tag-based node selection
```
