# Transform API Simplification

## Table of Contents

1. [Overview](#overview)
2. [Phase 1: Server-Side API Changes](#phase-1-server-side-api-changes)
3. [Phase 2: VS Code Extension Changes](#phase-2-vs-code-extension-changes)
4. [Phase 3: Final Verification and Cleanup](#phase-3-final-verification-and-cleanup)
5. [To Do List](#to-do-list)

## Overview

This refactor removes the `cursorNodeIds` state mechanism from the transform API. Instead of maintaining cursor state between transform invocations, we:

1. Accept `selections` (plural) from the IDE - supporting multi-cursor natively
2. Convert each selection range to node IDs on every call
3. Return `ranges` for the IDE to update its selections
4. Let the IDE manage selection state natively

### Benefits

- Simpler client code (no state management)
- Multi-cursor support is first-class
- No state synchronization issues between client and server
- IDE's native selection handling works naturally

---

## Phase 1: Server-Side API Changes

### Goal

Modify the `abct2.applyTransform` handler to:
1. Accept `selections` (array of ranges) instead of single `selection`
2. Remove `cursorNodeIds` from request params
3. Remove `cursorNodeIds` from response
4. Create one cursor per selection range

### Current Interface

```typescript
interface ApplyTransformParams {
  uri: string;
  transform: string;
  args?: number[];
  cursorNodeIds: number[];
  selection: {
    start: { line: number; character: number };
    end: { line: number; character: number };
  };
}

interface ApplyTransformResult {
  text: string;
  ranges: Array<{ start: { line: number; character: number }; end: { line: number; character: number } }>;
  cursorNodeIds: number[];
}
```

### New Interface

```typescript
interface ApplyTransformParams {
  uri: string;
  transform: string;
  args?: number[];
  selections: Array<{
    start: { line: number; character: number };
    end: { line: number; character: number };
  }>;
}

interface ApplyTransformResult {
  text: string;
  ranges: Array<{ start: { line: number; character: number }; end: { line: number; character: number } }>;
}
```

### Handler Logic Changes

```typescript
connection.onRequest("abct2.applyTransform", (params: ApplyTransformParams): ApplyTransformResult => {
  const doc = abcServer.abcDocuments.get(params.uri);
  if (!doc || !(doc instanceof AbcDocument) || !doc.AST || !doc.ctx) {
    return { text: "", ranges: [] };
  }

  const root = getCsTree(doc.AST);
  const tags = TRANSFORM_NODE_TAGS[params.transform] ?? [TAGS.Note, TAGS.Chord];

  if (!params.selections || params.selections.length === 0) {
    return { text: "", ranges: [] };
  }

  // Convert each editor selection to a cursor
  const cursors = params.selections
    .map((sel) => {
      const nodeIds = findNodesInRange(root, sel, tags);
      return new Set(nodeIds);
    })
    .filter((c) => c.size > 0);

  if (cursors.length === 0) {
    return { text: "", ranges: [] };
  }

  const inputSelection = { root, cursors };

  const transformFn = lookupTransform(params.transform);
  if (!transformFn) {
    throw new ResponseError(-1, `Unknown transform: "${params.transform}"`);
  }

  const resultSelection = transformFn(inputSelection, doc.ctx, ...(params.args ?? []));

  const modifiedAst = toAst(resultSelection.root) as File_structure;
  const formatter = new AbcFormatter(doc.ctx);
  const text = formatter.stringify(modifiedAst);

  const ranges = resolveSelectionRanges(resultSelection);

  return { text, ranges };
});
```

### Files to Modify

| File | Action |
|------|--------|
| `abc-lsp-server/src/server.ts` | Update `ApplyTransformParams`, `ApplyTransformResult`, and handler logic |

---

## Phase 2: VS Code Extension Changes

### Goal

Update `transformCommands.ts` to:
1. Send `selections` (plural) using all of `editor.selections`
2. Remove `cursorNodeIds` from request
3. Remove `cursorStateByUri` state management
4. Remove `applyingTransform` guard (no longer needed without state)
5. Silently return if no selection (no error notification)

### Current Code Structure

```typescript
const cursorStateByUri = new Map<string, number[]>();
const applyingTransform = new Set<string>();

// Event listeners to clear cursor state
context.subscriptions.push(
  vscode.window.onDidChangeTextEditorSelection((event) => { ... })
);
context.subscriptions.push(
  vscode.workspace.onDidChangeTextDocument((event) => { ... })
);

// Command sends cursorNodeIds and single selection
const result = await client.sendRequest<ApplyTransformResult>("abct2.applyTransform", {
  uri,
  transform: transformName,
  args,
  cursorNodeIds,
  selection: { ... },
});

// Result handling updates cursorStateByUri
if (result.cursorNodeIds.length > 0) {
  cursorStateByUri.set(uri, result.cursorNodeIds);
}
```

### New Code Structure

```typescript
// Helper to convert VS Code selections to API format
function selectionsToRanges(selections: readonly vscode.Selection[]) {
  return selections.map((sel) => ({
    start: { line: sel.start.line, character: sel.start.character },
    end: { line: sel.end.line, character: sel.end.character },
  }));
}

// Updated result interface (no cursorNodeIds)
interface ApplyTransformResult {
  text: string;
  ranges: Array<{ start: { line: number; character: number }; end: { line: number; character: number } }>;
}

// Command sends selections (plural), no cursorNodeIds
for (const [commandId, transformName, args] of transformCommands) {
  context.subscriptions.push(
    vscode.commands.registerCommand(commandId, async () => {
      const editor = vscode.window.activeTextEditor;
      if (!editor || editor.document.languageId !== "abc") return;

      const selections = editor.selections;
      if (selections.every((s) => s.isEmpty)) {
        // Silently return - no error notification
        return;
      }

      const uri = editor.document.uri.toString();

      try {
        const result = await client.sendRequest<ApplyTransformResult>("abct2.applyTransform", {
          uri,
          transform: transformName,
          args,
          selections: selectionsToRanges(selections),
        });

        if (result.text) {
          const fullRange = new vscode.Range(
            new vscode.Position(0, 0),
            editor.document.lineAt(editor.document.lineCount - 1).range.end
          );
          await editor.edit((editBuilder) => {
            editBuilder.replace(fullRange, result.text);
          });

          // Update editor selections to match result ranges
          if (result.ranges.length > 0) {
            editor.selections = result.ranges.map((r) => {
              const start = new vscode.Position(r.start.line, r.start.character);
              const end = new vscode.Position(r.end.line, r.end.character);
              return new vscode.Selection(start, end);
            });
            editor.revealRange(editor.selections[0], vscode.TextEditorRevealType.InCenterIfOutsideViewport);
          }
        }
      } catch (error) {
        vscode.window.showErrorMessage(`Transform failed: ${error}`);
      }
    })
  );
}
```

### Code to Remove

1. `cursorStateByUri` map declaration (line 62)
2. `applyingTransform` set declaration (line 64)
3. `onDidChangeTextEditorSelection` listener (lines 66-77)
4. `onDidChangeTextDocument` listener (lines 79-87)
5. All references to `cursorNodeIds` in request params
6. All references to `result.cursorNodeIds` in response handling
7. All `cursorStateByUri.get/set/delete` calls
8. All `applyingTransform.add/delete/has` calls
9. The `vscode.window.showInformationMessage` call for empty selections

### Files to Modify

| File | Action |
|------|--------|
| `vscode-extension/src/transformCommands.ts` | Remove state management, use `selections` plural, silent return on empty selection |

---

## Phase 3: Final Verification and Cleanup

### Goal

Ensure the refactored API works correctly, update any tests, and verify the build passes.

### Tests to Check/Update

Check if there are any existing tests for the `applyTransform` handler that reference `cursorNodeIds`:

| Location | Action |
|----------|--------|
| `abc-lsp-server/tests/` | Search for tests using `cursorNodeIds`, update if found |
| `vscode-extension/tests/` | Search for tests using `cursorNodeIds`, update if found |

### Unaffected Code

The `abc.wrapDynamic` endpoint uses a different interface and is not affected by this refactor. It can remain unchanged.

### Verification Steps

1. Run `npm run build` from repo root - verify success
2. Run `npm run test` from repo root - verify all tests pass
3. Manual testing in VS Code:
   - Single selection: select notes, invoke harmonize, verify transform works
   - Multi-cursor: create multiple selections (Ctrl+click), invoke harmonize, verify all selections are transformed
   - Chained transforms: invoke harmonize twice in succession, verify second invocation works on the updated selection positions
   - consolidateRests: select rests, invoke consolidate, verify consolidation works
   - Empty selection: invoke transform with no selection, verify silent return (no notification)

### Files to Potentially Modify

| File | Action |
|------|--------|
| `abc-lsp-server/tests/*.ts` | Update if tests reference old API |
| `vscode-extension/tests/*.ts` | Update if tests reference old API |

---

## To Do List

1. Update `ApplyTransformParams` interface in `abc-lsp-server/src/server.ts`:
   - Change `selection` to `selections` (array)
   - Remove `cursorNodeIds` field
2. Update `ApplyTransformResult` interface in `abc-lsp-server/src/server.ts`:
   - Remove `cursorNodeIds` field
3. Update `applyTransform` handler logic to iterate over `selections` array
4. Update `vscode-extension/src/transformCommands.ts`:
   - Remove `cursorStateByUri` map
   - Remove `applyingTransform` set
   - Remove selection change event listeners
   - Add `selectionsToRanges` helper
   - Update all commands to send `selections` array
   - Remove all `cursorNodeIds` handling
   - Change empty selection handling to silent return
5. Update `ApplyTransformResult` interface in `transformCommands.ts`
6. Search for and update any tests referencing the old API
7. Final verification: build and tests both pass
8. Call the code review agent. Address any feedback.
9. Commit once the build passes and all tests pass.

### Commit Message Format

```
abct2: simplify transform API to use selections only

Removes the cursorNodeIds state mechanism from the transform API.
The IDE now sends all selections as text ranges on every request,
and the server computes node positions fresh each time.

This simplifies the client code by removing state management
and makes multi-cursor support first-class.

Changes:
- Server accepts selections[] instead of single selection
- Server no longer returns cursorNodeIds
- Client removes cursorStateByUri and event listeners
- Client sends editor.selections directly
- Empty selection silently returns instead of showing notification
```
