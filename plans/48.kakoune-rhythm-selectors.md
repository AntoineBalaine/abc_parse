# Plan 48: Integrate Rhythm Selectors in Kakoune Plugin

## Table of Contents

1. [Overview](#overview)
2. [Current State](#current-state)
3. [Changes Required](#changes-required)
4. [To Do List](#to-do-list)

## Overview

The rhythm selectors (`selectRhythm` and `selectRhythmParent`) were implemented on the `abc-grammar` branch and are now available on `feature/kakoune-selectors` after the rebase. The selectors are fully functional in the core library and registered in the LSP server, but they are not yet exposed as Kakoune commands.

## Current State

The following components are already complete:

- Core selector functions in `abct2/src/selectors/typeSelectors.ts` (lines 25-31)
- Predicate functions in `abct2/src/csTree/types.ts` (`isRhythm`, `isRhythmParent`, `hasRhythmChild`)
- LSP server registration in `abc-lsp-server/src/selectorLookup.ts` (lines 27-28)
- Tests in `abct2/tests/typeSelectors.spec.ts`

The missing pieces are:

- Kakoune command definitions in `abc-kak/rc/abc-selectors.kak`
- Documentation in `abc-kak/README.md`
- Kakoune-specific tests in `abc-kak/spec/abc-selectors.kak-spec`

## Changes Required

### 1. Add Commands to `abc-kak/rc/abc-selectors.kak`

Insert a new "Rhythm Selectors" section after the Type Selectors section (after line 99, before Structure Selectors). The commands follow the existing pattern:

```kak
# ============================================================================
# Rhythm Selectors
# ============================================================================

define-command abc-select-rhythm \
    -docstring "Select all rhythm expressions (e.g., /2, 3, 3/2)" %{
    abc-select-impl selectRhythm
}

define-command abc-select-rhythm-parent \
    -docstring "Select notes, chords, rests, or spacers with explicit rhythm" %{
    abc-select-impl selectRhythmParent
}
```

### 2. Update Documentation in `abc-kak/README.md`

Add a new "Rhythm Selectors" subsection after Type Selectors (after line 45):

```markdown
### Rhythm Selectors

- `abc-select-rhythm`: Select all rhythm expressions (e.g., /2, 3, 3/2)
- `abc-select-rhythm-parent`: Select notes, chords, rests, or spacers with explicit rhythm
```

### 3. Add Tests to `abc-kak/spec/abc-selectors.kak-spec`

Add test cases for the new commands after the existing tests:

```kak
# Test: abc-select-rhythm returns rhythm expressions
kak-spec -title "abc-select-rhythm returns rhythm positions" \
    -input "X:1\nK:C\nC2 D E/4" \
    -eval %{
        set-option buffer filetype abc
        abc-select-rhythm
    } \
    -expect-%val(selections_desc) "1.2,1.2 1.7,1.8"

# Test: abc-select-rhythm-parent returns parent elements
kak-spec -title "abc-select-rhythm-parent returns parent positions" \
    -input "X:1\nK:C\nC2 D E/4" \
    -eval %{
        set-option buffer filetype abc
        abc-select-rhythm-parent
    } \
    -expect-%val(selections_desc) "1.1,1.2 1.6,1.8"
```

Note: The mock client test framework may need to be extended to support the rhythm selector mocks. The exact selection descriptors in the tests above are placeholders that will need to be verified against actual selector output.

## To Do List

1. Add rhythm selector commands to `abc-kak/rc/abc-selectors.kak`
2. Update `abc-kak/README.md` with the new rhythm selector documentation
3. Add tests to `abc-kak/spec/abc-selectors.kak-spec` (verify with actual selector output)
4. Final verification: build and tests both pass
5. Call the code review agent. Address any feedback
6. Commit once the build passes and all tests pass
