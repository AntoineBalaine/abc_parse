# ABCL Linear Style Support

## Table of Contents

1. [Overview](#overview)
2. [Phase 1: File Detection and Document Routing](#phase-1-file-detection-and-document-routing)
3. [Phase 2: Linear Parsing Integration](#phase-2-linear-parsing-integration)
4. [Phase 3: AbclToAbcConverter](#phase-3-abcltoabcconverter)
5. [Phase 4: ABCT Selectors and Transforms Compatibility](#phase-4-abct-selectors-and-transforms-compatibility)
6. [Phase 5: LSP and Preview Integration](#phase-5-lsp-and-preview-integration)
7. [Phase 6: Integration Tests and Final Verification](#phase-6-integration-tests-and-final-verification)

---

## Overview

This plan implements support for `.abcl` files, which use "linear writing style" for multi-voice ABC notation. In linear style, voice changes within the file represent actual system breaks, as opposed to "deferred style" where ABCJS pieces voices together at render time.

The conversion from linear to deferred style inserts silenced lines (with `X` rests) for voices missing from each system, allowing ABCJS to render the score correctly.

---

## Phase 1: File Detection and Document Routing

This phase establishes the infrastructure for recognizing `.abcl` files and routing them to appropriate handlers, following the ABCX pattern.

### Changes

1. `abc-lsp-server/src/AbcLspServer.ts`
   - Add `isAbclFile(uri: string): boolean` method that returns `uri.toLowerCase().endsWith(".abcl")`
   - Update `onDidChangeContent` to check for `.abcl` and create `AbclDocument` instances

2. `abc-lsp-server/src/AbclDocument.ts` (new file)
   - Create `AbclDocument` class similar to `AbcDocument`
   - Uses standard `Scanner` and `parse` from abc-parser (not custom scanner like ABCX)
   - The difference from `AbcDocument`: passes a `linear: true` flag to parsing (to be implemented in Phase 2)

3. `vscode-extension/src/renderer/AbcRenderer.ts`
   - Add extension check for `.abcl` in `getCurrentEditorContent()`
   - Call `convertAbclToAbc(content)` when detected (converter to be implemented in Phase 3)

4. `vscode-extension/package.json`
   - Add `.abcl` to file associations for the ABC language

### To do

- Create `AbclDocument.ts` file
- Add `isAbclFile()` to `AbcLspServer.ts`
- Update `onDidChangeContent()` routing in `AbcLspServer.ts`
- Add `.abcl` extension check in `AbcRenderer.ts`
- Update `package.json` file associations
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

---

## Phase 2: Linear Parsing Integration

This phase modifies the parsing pipeline to support linear-style system detection, including dynamic voice discovery.

### Changes

1. `parse/parsers/voices2.ts`
   - Update `parseSystemsWithVoices` signature to accept an optional `linear?: boolean` parameter
   - When `linear` is true and there are multiple voices, call `parseVoices(ctx)` instead of `parseVoicesWithBarOverlap(lines)`
   - Modify `parseVoices` (or `isNewSystem`) to handle dynamic voice discovery:

     ```
     when encountering a voice marker:
       voice = stringifyVoice(current)
       if voice not in ctx.voices:
         ctx.voices.push(voice)  â† add to end of voice list

       // now proceed with system boundary detection
       lastVoiceIndex = ctx.voices.indexOf(ctx.lastVoice)
       currentVoiceIndex = ctx.voices.indexOf(voice)
       if lastVoiceIndex > currentVoiceIndex:
         // new system
     ```

   This ensures that when V:3 appears for the first time, it gets index 2. When V:1 appears next, index 0 < index 2, so `lastVoiceIndex > currentVoiceIndex` triggers a new system.

2. `parse/parsers/parse2.ts`
   - Update `prsSystems` to accept and forward the `linear` parameter to `parseSystemsWithVoices`
   - Update `prsBody` to accept and forward the `linear` parameter to `prsSystems`
   - Update `parseTune` to accept an optional `linear` parameter in its options/config

3. `parse/index.ts`
   - Export the linear parsing option (either via `parseLinear` function or options parameter)

### To do

- Add `linear?: boolean` parameter to `parseSystemsWithVoices` in `voices2.ts`
- Modify `parseVoices` or `isNewSystem` to add unknown voices to `ctx.voices`
- Update conditional logic to use `parseVoices` when linear is true
- Propagate the parameter through `prsSystems` in `parse2.ts`
- Propagate the parameter through `prsBody` in `parse2.ts`
- Propagate the parameter through `parseTune` in `parse2.ts`
- Export the linear parsing option from `parse/index.ts`
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

---

## Phase 3: AbclToAbcConverter

This phase implements the converter that transforms linear-parsed ABC into deferred-style ABC by inserting silenced lines for missing voices.

### Changes

1. `parse/Visitors/AbclToAbcConverter.ts` (new file)
   - Create `AbclToAbcConverter` class that processes a linear-parsed `Tune`

   - Helper functions with single purpose:
     - `getSystemVoices(system)`: returns voice IDs present in the system
     - `findMusicLine(system)`: finds a line with music content to use as template
     - `copyMusicLine(line)`: deep copies the line's elements
     - `silence(line)`: removes time events, grace groups, and tuplet markers; replaces with `X` rests at bar boundaries; keeps barlines and other elements
     - `insertVoicePrefix(line, voiceId)`: prepends voice marker to the line

   - Reuse existing `isTimeEvent` from `parse/Visitors/fmt2/fmt_timeMap.ts`
   - The `silence` function removes:
     - Time events (via `isTimeEvent`): Note, Beam, MultiMeasureRest, Chord, Rest
     - Grace groups (via `isGraceGroup`)
     - Tuplet markers (via `isTuplet`)

   - Main conversion flow:
     ```
     for each system:
       presentVoices = getSystemVoices(system)
       missingVoices = allVoices - presentVoices

       for each missingVoice:
         originalLine = findMusicLine(system)
         copiedLine = copyMusicLine(originalLine)
         silencedLine = silence(copiedLine)
         completeLine = insertVoicePrefix(silencedLine, missingVoice)
         system.append(completeLine)
     ```

2. `parse/abcl/index.ts` (new file)
   - Export `abclToAbc(source: string, ctx: ABCContext): string`
   - Export `abclToAbcAst(source: string, ctx: ABCContext): File_structure`
   - Export `parseAbcl` (calls parse with linear: true)

3. `parse/index.ts`
   - Export the abcl module contents

4. `parse/tests/abcl2abc.spec.ts` (new file)

   Example-based tests:
   - Single voice input passes through unchanged
   - Two voices, both present in all systems, passes through unchanged
   - Two voices, V:2 missing from system 1, inserts silenced V:2 line
   - Three voices, V:3 appears mid-tune, backfills V:3 skeleton in earlier systems
   - Barlines are preserved in silenced lines
   - Comments and annotations are preserved in silenced lines
   - Grace groups are removed in silenced lines
   - Tuplet markers are removed in silenced lines

   Property-based tests (reuse existing generators from `parse/tests/`):
   - Output voice count per system equals total voice count (every system has all voices)
   - Barline count in silenced line equals barline count in template line
   - No time events remain in silenced lines (only `X` rests)
   - No grace groups remain in silenced lines
   - No tuplet markers remain in silenced lines
   - Converted output parses as valid ABC

### To do

- Create `AbclToAbcConverter.ts` with the converter class
- Import `isTimeEvent` from `fmt_timeMap.ts`
- Import `isGraceGroup` and `isTuplet` from helpers
- Implement `getSystemVoices`
- Implement `findMusicLine`
- Implement `copyMusicLine`
- Implement `silence` (removes time events, grace groups, tuplet markers; inserts `X` rests)
- Implement `insertVoicePrefix`
- Create `parse/abcl/index.ts` with exports
- Update `parse/index.ts` to export abcl module
- Create `parse/tests/abcl2abc.spec.ts` with example and property-based tests
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback
- Commit once the build passes and all tests pass

---

## Phase 4: ABCT Selectors and Transforms Compatibility

This phase ensures that `.abcl` files work with ABCT selectors and transforms.

### Changes

1. `abc-lsp-server/src/AbclDocument.ts`
   - Make `AbclDocument` extend `AbcDocument` instead of being a standalone class
   - Override the `analyze()` method to call parsing with `linear: true`
   - This ensures `instanceof AbcDocument` checks in `server.ts` pass for `.abcl` files

2. `vscode-extension/package.json`
   - Add `.abcl` to the "abc" language extensions array (alongside `.abc` and `.abcx`)
   - This ensures `languageId === "abc"` for `.abcl` files, enabling selector/transform commands

3. `abc-lsp-server/src/server.ts`
   - No changes needed if `AbclDocument extends AbcDocument`
   - The existing `instanceof AbcDocument` checks will work for `.abcl` files

### Verification

- Selector commands (`abct2.applySelector`) work on `.abcl` files
- Transform commands (`abct2.applyTransform`) work on `.abcl` files
- All existing ABC selector/transform tests pass

### To do

- Update `AbclDocument` to extend `AbcDocument`
- Override `analyze()` method to use linear parsing
- Add `.abcl` to "abc" language extensions in `package.json`
- Verify selector commands work on `.abcl` files
- Verify transform commands work on `.abcl` files
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback
- Commit once the build passes and all tests pass

---

## Phase 5: LSP and Preview Integration

This phase wires up the ABCL conversion in the language server and VSCode renderer for preview functionality.

### Changes

1. `abc-lsp-server/src/AbcLspServer.ts`
   - Add `isAbclFile(uri: string): boolean` method
   - Update `onDidChangeContent()` to create `AbclDocument` for `.abcl` files

2. `vscode-extension/src/renderer/AbcRenderer.ts`
   - Import `abclToAbc` from `abc-parser`
   - In `getCurrentEditorContent()`, add check for `.abcl` extension
   - Call `abclToAbc(content, ctx)` when `.abcl` is detected, similar to ABCX handling

   ```
   getCurrentEditorContent():
     ...
     if fileName.endsWith(".abcl"):
       return convertAbclToAbc(content)
     ...
   ```

3. `vscode-extension/src/renderer/AbcRenderer.ts`
   - Add `convertAbclToAbc(content: string): string` helper function
   - Creates `ABCContext` and `AbcErrorReporter`
   - Calls `abclToAbc(content, ctx)` from abc-parser
   - Returns converted ABC string for ABCJS rendering
   - Handles errors gracefully (falls back to original content)

### To do

- Add `isAbclFile()` to `AbcLspServer.ts`
- Update `onDidChangeContent()` routing in `AbcLspServer.ts`
- Import `abclToAbc` in `AbcRenderer.ts`
- Add `.abcl` extension check in `getCurrentEditorContent()`
- Implement `convertAbclToAbc()` helper in `AbcRenderer.ts`
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback
- Commit once the build passes and all tests pass

---

## Phase 6: Integration Tests and Final Verification

This phase adds end-to-end integration tests and ensures all components work together.

### Changes

1. `abc-lsp-server/tests/abcl-integration.spec.ts` (new file)

   Integration tests for the LSP server:
   - `.abcl` file opens without errors
   - `.abcl` file produces correct diagnostics
   - `.abcl` file returns semantic tokens
   - Selector commands return valid selections on `.abcl` files
   - Transform commands produce valid output on `.abcl` files

2. `vscode-extension/src/test/abcl-preview.spec.ts` (new file)

   Integration tests for the renderer:
   - `.abcl` file preview renders without errors
   - Linear-style multi-voice `.abcl` converts correctly for ABCJS
   - Missing voice skeletons appear in rendered output

3. Manual verification checklist:
   - Create sample `.abcl` file with linear multi-voice content
   - Open in VSCode, verify syntax highlighting works
   - Open preview panel, verify rendering shows all voices aligned
   - Apply a selector (e.g., select all notes), verify it works
   - Apply a transform (e.g., transpose), verify it works
   - Verify no regressions in `.abc` and `.abcx` file handling

### To do

- Create `abc-lsp-server/tests/abcl-integration.spec.ts`
- Create `vscode-extension/src/test/abcl-preview.spec.ts`
- Run manual verification checklist
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback
- Commit once the build passes and all tests pass
