# Plan: Remove ABCT Language Implementation

## Table of Contents

1. [Overview](#overview)
2. [Phase 1: Rename abct2 to editor](#phase-1-rename-abct2-to-editor)
3. [Phase 2: Implement selectMeasures selector](#phase-2-implement-selectmeasures-selector)
4. [Phase 3: Remove ABCT-specific code from LSP server](#phase-3-remove-abct-specific-code-from-lsp-server)
5. [Phase 4: Remove ABCT-specific code from VSCode extension](#phase-4-remove-abct-specific-code-from-vscode-extension)
6. [Phase 5: Delete the abct directory](#phase-5-delete-the-abct-directory)
7. [Phase 6: Update request method names and final cleanup](#phase-6-update-request-method-names-and-final-cleanup)

---

## Overview

This plan removes the abct language (DSL for `.abct` files) from the codebase while preserving all transforms, selectors, and score-editing capabilities. The abct2 module will be renamed to "editor" to reflect its purpose as the score-editing runtime.

### What will be removed:
- The `abct/` directory (scanner, parser, AST, runtime)
- ABCT language support in the LSP server (validation, completion, hover, formatting, evaluation)
- ABCT commands in the VSCode extension

### What will be preserved:
- All 17 selectors from abct2/editor
- All 11+ transforms from abct2/editor
- The `abc-kak` plugin (which uses the LSP server for selectors/transforms)
- VSCode extension selector and transform commands

### New feature:
- `selectMeasures(start, end)` selector ported from abct v1 to the editor module

---

## Phase 1: Rename abct2 to editor

### Rationale

Because the abct2 module will be the sole module for selectors and transforms after abct is removed, we are renaming it to "editor" to better reflect its purpose.

### File Operations (single batch)

```bash
mv abc_parse/abct2 abc_parse/editor
```

### Files to Update

#### 1. `/abc_parse/package.json`

Update workspaces array:
```json
// Change:
"abct2"
// To:
"editor"
```

Update scripts:
```json
// Change:
"build:abct2": "npm run build -w abct2"
// To:
"build:editor": "npm run build -w editor"

// In "build" script, change:
"npm run build:abct2"
// To:
"npm run build:editor"

// In "test" script, change:
"npm run test -w abct2"
// To:
"npm run test -w editor"
```

#### 2. `/abc_parse/editor/package.json`

```json
// Change:
"name": "abct2"
// To:
"name": "editor"

// Change:
"main": "../out/abct2/src/selection.js"
// To:
"main": "../out/editor/src/selection.js"
```

#### 3. `/abc_parse/editor/tsconfig.json`

```json
// Change:
"outDir": "../out/abct2"
// To:
"outDir": "../out/editor"
```

#### 4. LSP Server import updates

All imports from `../../abct2/` must change to `../../editor/`:

- `/abc_parse/abc-lsp-server/src/server.ts` (lines 35-38)
- `/abc_parse/abc-lsp-server/src/selectorLookup.ts`
- `/abc_parse/abc-lsp-server/src/transformLookup.ts`
- `/abc_parse/abc-lsp-server/src/socketHandler.ts`
- `/abc_parse/abc-lsp-server/src/selectionRangeResolver.ts`
- `/abc_parse/abc-lsp-server/src/cursorPreservation.ts`
- `/abc_parse/abc-lsp-server/src/csTreeSerializer.ts`

### To Do

1. Rename `abc_parse/abct2/` directory to `abc_parse/editor/`
2. Update `abc_parse/package.json` (workspaces, scripts, test command)
3. Update `abc_parse/editor/package.json` (name, main)
4. Update `abc_parse/editor/tsconfig.json` (outDir)
5. Update all import paths in LSP server files (7 files)
6. Run `npm install` to update workspace links
7. Run `npm run build` to verify build succeeds
8. Run `npm run test` to verify tests pass
9. Final verification: build and tests both pass
10. Call the code review agent. Address any feedback.
11. Commit once the build passes and all tests pass.

---

## Phase 2: Implement selectMeasures selector

### Rationale

Because the abct v1 module has a `selectMeasures(start, end)` selector that we want to preserve, we need to port its logic to the editor module. The original implementation is in `/abc_parse/abct/src/runtime/selectors.ts` (lines 81-105).

### New File to Create

`/abc_parse/editor/src/selectors/measureSelector.ts`

### Implementation

The selector walks the CSTree and tracks measure numbers by counting bar lines. It collects nodes that fall within the specified measure range.

```typescript
import { Selection } from "../selection";
import { CSNode, TAGS, isBarLine } from "../csTree/types";
import { treeWalk } from "./treeWalk";

export function selectMeasures(
  input: Selection,
  start: number,
  end: number
): Selection {
  // start and end are 1-indexed, inclusive
  // Validate parameters
  if (start < 1 || end < start) {
    throw new Error(`Invalid measure range: ${start}-${end}`);
  }

  const newCursors: Set<number>[] = [];

  // Walk the tree from each cursor
  for (const cursor of input.cursors) {
    // Track current measure (starts at 1)
    let currentMeasure = 1;

    treeWalk(input.root, cursor, (node) => {
      // Increment measure on bar lines
      if (isBarLine(node)) {
        currentMeasure++;
        return; // Don't select bar lines themselves
      }

      // Check if we're in the target range
      if (currentMeasure >= start && currentMeasure <= end) {
        // Select music nodes: Notes, Chords, Rests, Beam, Grace_group
        if (
          node.tag === TAGS.Note ||
          node.tag === TAGS.Chord ||
          node.tag === TAGS.Rest ||
          node.tag === TAGS.Beam ||
          node.tag === TAGS.Grace_group
        ) {
          newCursors.push(new Set([node.id]));
        }
      }
    });
  }

  return { root: input.root, cursors: newCursors };
}
```

### Update Selector Export

Add export to `/abc_parse/editor/src/selectors/index.ts`:
```typescript
export { selectMeasures } from "./measureSelector";
```

### Register in LSP Server

Update `/abc_parse/abc-lsp-server/src/selectorLookup.ts`:

```typescript
// Add import:
import { selectMeasures } from "../../editor/src/selectors/measureSelector";

// Add to SELECTOR_MAP:
selectMeasures: (sel, start, end) => selectMeasures(sel, start as number, end as number),
```

### Test File to Create

`/abc_parse/editor/tests/measureSelector.spec.ts`

Test cases:
1. Single measure selection (start = end = 1)
2. Multiple measure range (start = 1, end = 3)
3. Middle measures (start = 2, end = 3)
4. Invalid parameters (start < 1, end < start) should throw errors
5. Empty result when range exceeds tune length

### To Do

1. Create `/abc_parse/editor/src/selectors/measureSelector.ts`
2. Update `/abc_parse/editor/src/selectors/index.ts` to export selectMeasures
3. Create `/abc_parse/editor/tests/measureSelector.spec.ts`
4. Update `/abc_parse/abc-lsp-server/src/selectorLookup.ts` to register selectMeasures
5. Run `npm run test -w editor` to verify selector tests pass
6. Run `npm run build` to verify build succeeds
7. Run `npm run test` to verify all tests pass
8. Final verification: build and tests both pass
9. Call the code review agent. Address any feedback.
10. Commit once the build passes and all tests pass.

---

## Phase 3: Remove ABCT-specific code from LSP server

### Rationale

Because the ABCT language is being removed, we need to remove all ABCT-specific handling from the LSP server while preserving the selector and transform functionality.

### Files to Delete (single batch)

```bash
rm abc_parse/abc-lsp-server/src/AbctDocument.ts
rm abc_parse/abc-lsp-server/src/abctEvaluator.ts
rm abc_parse/abc-lsp-server/src/abctEvaluator.spec.ts
rm abc_parse/abc-lsp-server/src/fileResolver.ts
rm -rf abc_parse/abc-lsp-server/src/abct/
```

### Files to Update

#### 1. `/abc_parse/abc-lsp-server/src/server.ts`

Remove imports (lines 23, 27-28):
```typescript
// DELETE:
import { AbctDocument } from "./AbctDocument";
import { provideHover } from "./abct/AbctHoverProvider";
import { provideAbctCompletions } from "./abct/AbctCompletionProvider";
```

Remove ABCT types and interfaces (lines 74-118):
```typescript
// DELETE entire interfaces:
// AbctEvalParams, AbctEvalToLineParams, AbctEvalSelectionParams, AbctEvalResult
```

Update onInitialize (lines 228-231):
```typescript
// Change triggerCharacters from:
triggerCharacters: ["!", "@", "|"],
// To:
triggerCharacters: ["!"],
```

Remove ABCT folding early return (lines 274-276):
```typescript
// DELETE:
if (uri.toLowerCase().endsWith(".abct")) {
  return [];
}
```

Remove onHover ABCT handling (lines 286-300):
```typescript
// REPLACE entire handler with:
connection.onHover((_params: TextDocumentPositionParams): Hover | null => {
  return null;
});
```

Remove ABCT completion branch (lines 486-491):
```typescript
// DELETE:
if (uri.toLowerCase().endsWith(".abct")) {
  const doc = documents.get(uri);
  if (!doc) {
    return [];
  }
  return provideAbctCompletions(doc, textDocumentPosition.position);
}
```

Remove getAbctDocument helper (lines 536-542):
```typescript
// DELETE entire function
```

Remove ABCT evaluation handlers (lines 547-635):
```typescript
// DELETE all three handlers:
// connection.onRequest("abct.evaluate", ...)
// connection.onRequest("abct.evaluateToLine", ...)
// connection.onRequest("abct.evaluateSelection", ...)
```

#### 2. `/abc_parse/abc-lsp-server/src/AbcLspServer.ts`

Remove imports:
```typescript
// DELETE (if present):
import { AbctFormatter } from "./abct/AbctFormatter";
import { AbctDocument } from "./AbctDocument";
// And any imports from "../../abct/..."
```

Remove AbctDocument from DocumentType union:
```typescript
// Change from:
type DocumentType = AbcDocument | AbcxDocument | AbclDocument | AbctDocument;
// To:
type DocumentType = AbcDocument | AbcxDocument | AbclDocument;
```

Remove isAbctFile method and all references to it.

Remove AbctDocument handling in onDidChangeContent, onSemanticTokens, onFormat methods.

#### 3. `/abc_parse/abc-lsp-server/src/socketHandler.ts`

Remove AbctDocument import and update DocumentGetter type:
```typescript
// Change from:
type DocumentGetter = (uri: string) => AbcDocument | AbcxDocument | AbctDocument | undefined;
// To:
type DocumentGetter = (uri: string) => AbcDocument | AbcxDocument | undefined;
```

### To Do

1. Delete files: AbctDocument.ts, abctEvaluator.ts, abctEvaluator.spec.ts, fileResolver.ts
2. Delete directory: abc-lsp-server/src/abct/
3. Update abc-lsp-server/src/server.ts (remove imports, types, handlers)
4. Update abc-lsp-server/src/AbcLspServer.ts (remove AbctDocument handling)
5. Update abc-lsp-server/src/socketHandler.ts (remove AbctDocument from types)
6. Run `npm run build` to verify build succeeds
7. Run `npm run test` to verify tests pass
8. Final verification: build and tests both pass
9. Call the code review agent. Address any feedback.
10. Commit once the build passes and all tests pass.

---

## Phase 4: Remove ABCT-specific code from VSCode extension

### Rationale

Because the ABCT language is being removed from the LSP server, we need to remove corresponding ABCT evaluation commands and language support from the VSCode extension.

### Files to Delete (single batch)

```bash
rm abc_parse/vscode-extension/src/abctCommands.ts
rm -rf abc_parse/vscode-extension/src/abct/
```

### Files to Update

#### 1. `/abc_parse/vscode-extension/src/extension.ts`

Remove imports (line 14):
```typescript
// DELETE:
import { registerAbctCommands, disposeAbctCommands } from "./abctCommands";
```

Remove from documentSelector (lines 51, 53):
```typescript
// DELETE:
{ scheme: "file", language: "abct" },
{ scheme: "abct-eval", language: "abc" },
```

Remove ABCT registration (line 73):
```typescript
// DELETE:
registerAbctCommands(context, client);
```

Remove ABCT disposal (line 92):
```typescript
// DELETE:
disposeAbctCommands();
```

#### 2. `/abc_parse/vscode-extension/package.json`

Remove from activationEvents:
```json
// DELETE:
"onLanguage:abct"
```

Remove ABCT commands (all commands with "abct." prefix):
```json
// DELETE commands:
// abct.evaluate, abct.evaluateToLine, abct.evaluateSelection
// abct.exportToFile, abct.openEvaluatedOutput, abct.refreshEvaluatedOutput
```

Remove ABCT configuration:
```json
// DELETE:
"[abct]": { "editor.semanticHighlighting.enabled": true }
```

Remove ABCT language definition from languages array:
```json
// DELETE the entire ABCT language entry
```

### To Do

1. Delete file: vscode-extension/src/abctCommands.ts
2. Delete directory: vscode-extension/src/abct/
3. Update vscode-extension/src/extension.ts (remove imports, registrations, documentSelector entries)
4. Update vscode-extension/package.json (remove commands, language, configuration)
5. Run `npm run build` to verify build succeeds
6. Run `npm run test` to verify tests pass
7. Final verification: build and tests both pass
8. Call the code review agent. Address any feedback.
9. Commit once the build passes and all tests pass.

---

## Phase 5: Delete the abct directory

### Rationale

Because all ABCT language functionality has been removed from consumers, we can safely delete the entire abct module.

### Files to Delete (single batch)

```bash
rm -rf abc_parse/abct/
rm -rf abc_parse/out/abct/
```

### Files to Update

#### `/abc_parse/package.json`

Remove from workspaces:
```json
// DELETE:
"abct"
```

Remove from scripts:
```json
// DELETE:
"build:abct": "npm run build -w abct",

// In "build" and "build:production" scripts, remove:
"npm run build:abct &&"

// In "test" script, remove:
"npm run test -w abct ||"
```

### To Do

1. Delete directory: abc_parse/abct/
2. Delete directory: abc_parse/out/abct/ (if exists)
3. Update abc_parse/package.json (workspaces, scripts)
4. Run `npm install` to update workspace links
5. Run `npm run build` to verify build succeeds
6. Run `npm run test` to verify tests pass
7. Final verification: build and tests both pass
8. Call the code review agent. Address any feedback.
9. Commit once the build passes and all tests pass.

---

## Phase 6: Update request method names and final cleanup

### Rationale

Because the abct2 module has been renamed to editor, we should update the LSP request method names from `abct2.*` to `abc.*` for consistency. This also requires updating the abc-kak plugin and VSCode extension.

### Files to Update

#### 1. `/abc_parse/abc-lsp-server/src/server.ts`

```typescript
// Line 306, change:
connection.onRequest("abct2.applySelector", ...)
// To:
connection.onRequest("abc.applySelector", ...)

// Line 417, change:
connection.onRequest("abct2.applyTransform", ...)
// To:
connection.onRequest("abc.applyTransform", ...)
```

#### 2. `/abc_parse/abc-lsp-server/src/socketHandler.ts`

Update method name handling:
```typescript
// Change references from:
"abct2.applySelector"
"abct2.applyTransform"
// To:
"abc.applySelector"
"abc.applyTransform"
```

#### 3. `/abc_parse/abc-kak/bin/abc-kak-client.js`

Update request method names:
```typescript
// Change from:
"abct2.applySelector"
"abct2.applyTransform"
// To:
"abc.applySelector"
"abc.applyTransform"
```

#### 4. `/abc_parse/vscode-extension/src/selectorCommands.ts`

Update request method names:
```typescript
// Change from:
"abct2.applySelector"
// To:
"abc.applySelector"
```

#### 5. `/abc_parse/vscode-extension/src/transformCommands.ts`

Update request method names:
```typescript
// Change from:
"abct2.applyTransform"
// To:
"abc.applyTransform"
```

### Final Verification

1. Search codebase for remaining "abct" references:
```bash
grep -r "abct" --include="*.ts" --include="*.json" --include="*.js" abc_parse/
```

2. Search codebase for remaining "abct2" references:
```bash
grep -r "abct2" --include="*.ts" --include="*.json" --include="*.js" abc_parse/
```

### To Do

1. Update server.ts request method names
2. Update socketHandler.ts request method names
3. Update abc-kak-client.js request method names
4. Update selectorCommands.ts request method names
5. Update transformCommands.ts request method names
6. Search for any remaining abct/abct2 references and address them
7. Run `npm run build` to verify build succeeds
8. Run `npm run test` to verify all tests pass
9. Final verification: build and tests both pass
10. Call the code review agent. Address any feedback.
11. Commit once the build passes and all tests pass.
