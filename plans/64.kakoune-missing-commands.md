# Kakoune Missing Commands Integration

## Table of Contents

1. [Outline](#outline)
2. [Phase 1: Voice Marker Transform Commands](#phase-1-voice-marker-transform-commands)
3. [Phase 2: Wrap Dynamic Commands](#phase-2-wrap-dynamic-commands)
4. [Phase 3: Convenience Transpose and Harmonize Commands](#phase-3-convenience-transpose-and-harmonize-commands)

---

## Outline

### Overview

Multiple commands available in VS Code are not yet exposed in Kakoune.

### Full List of Commands to Integrate

Transforms (require server calls):

| VS Code Command | Kakoune Command | Server Transform/Request |
|-----------------|-----------------|--------------------------|
| `abc.wrapCrescendo` | `abc-wrap-crescendo` | Native Kakoune |
| `abc.wrapDecrescendo` | `abc-wrap-decrescendo` | Native Kakoune |
| `abc.voiceInfoLineToInline` | `abc-voice-info-to-inline` | `voiceInfoLineToInline` transform |
| `abc.voiceInlineToInfoLine` | `abc-voice-inline-to-info` | `voiceInlineToInfoLine` transform |

Convenience Commands (wrappers around existing commands):

| VS Code Command | Kakoune Command | Implementation |
|-----------------|-----------------|----------------|
| `abc.transposeOctaveUp` | `abc-transpose-octave-up` | `abc-transpose 12` |
| `abc.transposeOctaveDown` | `abc-transpose-octave-down` | `abc-transpose -12` |
| `abc.transposeHalfStepUp` | `abc-transpose-halfstep-up` | `abc-transpose 1` |
| `abc.transposeHalfStepDown` | `abc-transpose-halfstep-down` | `abc-transpose -1` |
| `abc.harmonize3rdUp` | `abc-harmonize-3rd-up` | `abc-harmonize 4` |
| `abc.harmonize3rdDown` | `abc-harmonize-3rd-down` | `abc-harmonize -4` |
| `abc.harmonize4thUp` | `abc-harmonize-4th-up` | `abc-harmonize 5` |
| `abc.harmonize4thDown` | `abc-harmonize-4th-down` | `abc-harmonize -5` |
| `abc.harmonize5thUp` | `abc-harmonize-5th-up` | `abc-harmonize 7` |
| `abc.harmonize5thDown` | `abc-harmonize-5th-down` | `abc-harmonize -7` |
| `abc.harmonize6thUp` | `abc-harmonize-6th-up` | `abc-harmonize 9` |
| `abc.harmonize6thDown` | `abc-harmonize-6th-down` | `abc-harmonize -9` |

### Phases

- Phase 1: Add voice marker transform commands (2 commands)
- Phase 2: Add wrap dynamic commands (2 commands) - native Kakoune implementation
- Phase 3: Add convenience transpose/harmonize commands (12 commands) - simple wrappers

---

## Phase 1: Voice Marker Transform Commands

### Goal

Add two commands to convert between voice info line format (`V:1`) and inline format (`[V:1]`).

### Commands to Add

| Kakoune Command | Server Transform | Arguments |
|-----------------|------------------|-----------|
| `abc-voice-info-to-inline` | `voiceInfoLineToInline` | none |
| `abc-voice-inline-to-info` | `voiceInlineToInfoLine` | none |

### Implementation

Both transforms are already registered in `abc-lsp-server/src/transformLookup.ts` (lines 49-50) and take no additional arguments beyond the selection and context.

File to modify: `abc-kak/rc/abc-transforms.kak`

Add a new section after the Explode Transform Commands section:

```
# ============================================================================
# Voice Marker Transform Commands
# ============================================================================

define-command abc-voice-info-to-inline \
    -docstring "Convert voice info line (V:1) to inline format ([V:1])" %{
    abc-transform-impl voiceInfoLineToInline
}

define-command abc-voice-inline-to-info \
    -docstring "Convert inline voice marker ([V:1]) to info line format (V:1)" %{
    abc-transform-impl voiceInlineToInfoLine
}
```

### Testing

Testing must be done with a real Kakoune daemon session because `kak -ui dummy` does not support `execute-keys` (it hangs).

```sh
# Start a real headless daemon
kak -d -s "$session" &
sleep 0.3

# Send commands via kak -p
kak -p "$session" << 'CMDS'
edit /path/to/file.abc
evaluate-commands -buffer /path/to/file.abc %{
    execute-keys '...'
    nop %sh{ echo "$kak_selection" > /tmp/output }
}
quit!
CMDS

# Read output from file (kak -p is one-way, no stdout)
cat /tmp/output
```

Key points:
- `kak -d -s session` starts a real daemon (not `-ui dummy`)
- `evaluate-commands -buffer <file>` provides the context needed for `execute-keys`
- Output must be written to a file because `kak -p` cannot return data

Test cases:
1. Select a `V:1` line, run `abc-voice-info-to-inline`, verify it becomes `[V:1]`
2. Select a `[V:1]` marker, run `abc-voice-inline-to-info`, verify it becomes `V:1`

### To Do

- Add the two voice marker transform commands to `abc-transforms.kak`
- Test both commands manually in Kakoune using `kak -d`
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

---

## Phase 2: Wrap Dynamic Commands

### Goal

Add commands to wrap selections in crescendo or decrescendo dynamic markers using native Kakoune commands.

### Commands to Add

| Kakoune Command | Markers |
|-----------------|---------|
| `abc-wrap-crescendo` | `!<(!` ... `!<)!` |
| `abc-wrap-decrescendo` | `!>(!` ... `!>)!` |

### Implementation

File to modify: `abc-kak/rc/abc-transforms.kak`

Add a new section after Voice Marker Transform Commands:

```
# ============================================================================
# Dynamic Wrap Commands
# ============================================================================

define-command abc-wrap-crescendo \
    -docstring "Wrap selection in crescendo markers (!<(! ... !<)!)" %{
    execute-keys "i!<(!<esc>a!<)!<esc>"
}

define-command abc-wrap-decrescendo \
    -docstring "Wrap selection in decrescendo markers (!>(! ... !>)!)" %{
    execute-keys "i!>(!<esc>a!>)!<esc>"
}
```

### Testing

Using `kak -d` daemon session:

1. Select a note sequence, run `abc-wrap-crescendo`, verify `!<(!` appears before and `!<)!` appears after the selection
2. Select a note sequence, run `abc-wrap-decrescendo`, verify `!>(!` appears before and `!>)!` appears after the selection

### To Do

- Add the Dynamic Wrap Commands section to `abc-transforms.kak`
- Add `abc-wrap-crescendo` command
- Add `abc-wrap-decrescendo` command
- Test both commands manually in Kakoune using `kak -d`
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

---

## Phase 3: Convenience Transpose and Harmonize Commands

### Goal

Add shortcut commands for common transpose and harmonize operations that wrap the existing `abc-transpose` and `abc-harmonize` commands with preset arguments.

### Commands to Add

| Kakoune Command | Implementation |
|-----------------|----------------|
| `abc-transpose-octave-up` | `abc-transpose 12` |
| `abc-transpose-octave-down` | `abc-transpose -12` |
| `abc-transpose-halfstep-up` | `abc-transpose 1` |
| `abc-transpose-halfstep-down` | `abc-transpose -1` |
| `abc-harmonize-3rd-up` | `abc-harmonize 4` |
| `abc-harmonize-3rd-down` | `abc-harmonize -4` |
| `abc-harmonize-4th-up` | `abc-harmonize 5` |
| `abc-harmonize-4th-down` | `abc-harmonize -5` |
| `abc-harmonize-5th-up` | `abc-harmonize 7` |
| `abc-harmonize-5th-down` | `abc-harmonize -7` |
| `abc-harmonize-6th-up` | `abc-harmonize 9` |
| `abc-harmonize-6th-down` | `abc-harmonize -9` |

### Implementation

File to modify: `abc-kak/rc/abc-transforms.kak`

Add two new sections:

```
# ============================================================================
# Convenience Transpose Commands
# ============================================================================

define-command abc-transpose-octave-up \
    -docstring "Transpose selection up one octave" %{
    abc-transpose 12
}

define-command abc-transpose-octave-down \
    -docstring "Transpose selection down one octave" %{
    abc-transpose -12
}

define-command abc-transpose-halfstep-up \
    -docstring "Transpose selection up one half step" %{
    abc-transpose 1
}

define-command abc-transpose-halfstep-down \
    -docstring "Transpose selection down one half step" %{
    abc-transpose -1
}

# ============================================================================
# Convenience Harmonize Commands
# ============================================================================

define-command abc-harmonize-3rd-up \
    -docstring "Harmonize selection a third up" %{
    abc-harmonize 4
}

define-command abc-harmonize-3rd-down \
    -docstring "Harmonize selection a third down" %{
    abc-harmonize -4
}

define-command abc-harmonize-4th-up \
    -docstring "Harmonize selection a fourth up" %{
    abc-harmonize 5
}

define-command abc-harmonize-4th-down \
    -docstring "Harmonize selection a fourth down" %{
    abc-harmonize -5
}

define-command abc-harmonize-5th-up \
    -docstring "Harmonize selection a fifth up" %{
    abc-harmonize 7
}

define-command abc-harmonize-5th-down \
    -docstring "Harmonize selection a fifth down" %{
    abc-harmonize -7
}

define-command abc-harmonize-6th-up \
    -docstring "Harmonize selection a sixth up" %{
    abc-harmonize 9
}

define-command abc-harmonize-6th-down \
    -docstring "Harmonize selection a sixth down" %{
    abc-harmonize -9
}
```

### Testing

Using `kak -d` daemon session:

1. Select notes, run `abc-transpose-octave-up`, verify notes move up 12 semitones
2. Select notes, run `abc-transpose-halfstep-down`, verify notes move down 1 semitone
3. Select notes, run `abc-harmonize-3rd-up`, verify a note 4 semitones higher is added
4. Select notes, run `abc-harmonize-5th-down`, verify a note 7 semitones lower is added

### To Do

- Add Convenience Transpose Commands section to `abc-transforms.kak`
- Add Convenience Harmonize Commands section to `abc-transforms.kak`
- Test transpose commands manually in Kakoune using `kak -d`
- Test harmonize commands manually in Kakoune using `kak -d`
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.
