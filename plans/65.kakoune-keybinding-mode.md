# Kakoune ABC Keybinding Mode Design

## Table of Contents

1. [Overview](#overview)
2. [Design Principles](#design-principles)
3. [Mode Structure](#mode-structure)
4. [Selection Mode](#selection-mode)
5. [Transform Mode](#transform-mode)
6. [Count Prefix Behavior](#count-prefix-behavior)
7. [Commands Requiring Prompts](#commands-requiring-prompts)
8. [To Do](#to-do)
9. [Workflow Examples](#workflow-examples)

---

## Overview

This document describes the design for a keybinding scheme that exposes ABC selectors and transforms through Kakoune user-modes. The design follows Kakoune's select-then-act paradigm, providing two entry points: one for making ABC-aware selections, and one for applying transforms to the current selection.

The prefix keys for entering ABC mode are left to user configuration.

---

## Design Principles

1. Selectors and transforms work in tandem: select first, then transform.
2. Flat structure preferred over nested submenus where possible.
3. Case indicates direction: lowercase = up/forward, uppercase = down/backward.
4. Alt modifier indicates variant: `p` = transpose, `<a-p>` = harmonize.
5. Count prefix for repetition: `2o` = transpose 2 octaves up.
6. Mnemonics from ABC notation where applicable: `z` for rests, `x` for tune (X: header).

---

## Mode Structure

```
<abc-select-prefix>   →  enters ABC selection mode
<abc-transform-prefix>  →  enters ABC transform mode
```

The user configures these prefix keys. Typical choices might be:
- Keys within an existing user-mode (e.g., `,s` and `,t`)
- Dedicated keys for ABC files via filetype hooks

---

## Selection Mode

```
<select-prefix>
  │
  ├── Type selectors
  │   ├── c: chords
  │   ├── n: notes
  │   ├── N: non-chord notes
  │   ├── C: chord notes (notes inside chords)
  │   └── z: rests
  │
  ├── Rhythm
  │   ├── r: rhythm expressions
  │   └── R: rhythm parent
  │
  ├── Structure
  │   ├── x: tune
  │   ├── m: measures
  │   ├── s: system
  │   └── v: voices (prompts)
  │
  ├── Chord position
  │   ├── t: top note
  │   ├── T: all but top
  │   ├── b: bottom note
  │   ├── B: all but bottom
  │   └── 1-9: nth from top
  │
  └── Inside/Around
      ├── i/a + c: inside/around chord
      ├── i/a + g: inside/around grace group
      ├── i/a + f: inside/around inline field
      └── i/a + p: inside/around grouping
```

### Type Selectors

| Key | Command | Description |
|-----|---------|-------------|
| `c` | `abc-select-chords` | Select all chord nodes |
| `n` | `abc-select-notes` | Select all note nodes |
| `N` | `abc-select-non-chord-notes` | Select notes not inside chords |
| `C` | `abc-select-chord-notes` | Select notes inside chords |
| `z` | `abc-select-rests` | Select all rest nodes |

### Rhythm Selectors

| Key | Command | Description |
|-----|---------|-------------|
| `r` | `abc-select-rhythm` | Select rhythm expressions (e.g., /2, 3, 3/2) |
| `R` | `abc-select-rhythm-parent` | Select notes/chords/rests with explicit rhythm |

### Structure Selectors

| Key | Command | Description |
|-----|---------|-------------|
| `x` | `abc-select-tune` | Select individual tunes (X: header) |
| `m` | `abc-select-measures` | Select all measures |
| `s` | `abc-select-system` | Expand selection to entire system(s) |
| `v` | `abc-select-voices` | Select notes/chords in specified voices (prompts for IDs) |

### Chord Position Selectors

These selectors filter the current selection to specific notes within chords.

| Key | Command | Description |
|-----|---------|-------------|
| `t` | `abc-select-top` | Select top note of each chord |
| `T` | `abc-select-all-but-top` | Select all notes except top |
| `b` | `abc-select-bottom` | Select bottom note of each chord |
| `B` | `abc-select-all-but-bottom` | Select all notes except bottom |
| `1-9` | `abc-select-nth-from-top` | Select nth note from top |

### Inside/Around Selectors

These follow Kakoune's text object paradigm.

| Keys | Command | Description |
|------|---------|-------------|
| `ic` | `abc-select-inside-chord` | Select contents inside chord brackets |
| `ac` | `abc-select-around-chord` | Select entire chord including brackets |
| `ig` | `abc-select-inside-grace-group` | Select contents inside grace braces |
| `ag` | `abc-select-around-grace-group` | Select entire grace group including braces |
| `if` | `abc-select-inside-inline-field` | Select contents inside inline field |
| `af` | `abc-select-around-inline-field` | Select entire inline field |
| `ip` | `abc-select-inside-grouping` | Select contents inside grouping parens |
| `ap` | `abc-select-around-grouping` | Select entire grouping including parens |

---

## Transform Mode

```
<transform-prefix>  (fully flat)
  │
  ├── Pitch
  │   ├── [count] o: transpose octave up
  │   ├── [count] O: transpose octave down
  │   ├── [count] <a-o>: harmonize octave up
  │   ├── [count] <a-O>: harmonize octave down
  │   ├── [count] p: transpose up (semitones)
  │   ├── [count] P: transpose down
  │   ├── [count] <a-p>: harmonize up (diatonic steps)
  │   ├── [count] <a-P>: harmonize down
  │   ├── +: add sharp accidental
  │   ├── -: add flat accidental
  │   └── e: enharmonize
  │
  ├── Rhythm
  │   ├── [count] *: multiply length (default 2)
  │   └── [count] /: divide length (default 2)
  │
  ├── Voice
  │   ├── v: info-to-inline (V:1 → [V:1])
  │   ├── V: inline-to-info ([V:1] → V:1)
  │   ├── <a-v>: insert-voice-line (prompts)
  │   └── <a-V>: add-voice (prompts)
  │
  ├── Dynamics
  │   ├── <: wrap crescendo
  │   └── >: wrap decrescendo
  │
  ├── Explode
  │   └── [count] x: explode (count = parts, default 2)
  │
  └── Convert
      ├── r: to-rest
      └── R: consolidate-rests
```

### Pitch Commands

| Key | Command | Description |
|-----|---------|-------------|
| `[count] o` | `abc-transpose-octave-up` | Transpose up by count octaves (default 1) |
| `[count] O` | `abc-transpose-octave-down` | Transpose down by count octaves |
| `[count] <a-o>` | `abc-harmonize-octave-up` | Harmonize up by count octaves |
| `[count] <a-O>` | `abc-harmonize-octave-down` | Harmonize down by count octaves |
| `[count] p` | `abc-transpose` | Transpose up by count semitones (default 1) |
| `[count] P` | `abc-transpose` | Transpose down by count semitones |
| `[count] <a-p>` | `abc-harmonize` | Harmonize up by count diatonic steps (default 1) |
| `[count] <a-P>` | `abc-harmonize` | Harmonize down by count diatonic steps |
| `+` | add-sharp | Add sharp accidental to selected notes |
| `-` | add-flat | Add flat accidental to selected notes |
| `e` | `abc-enharmonize` | Convert to enharmonic equivalent |

### Rhythm Commands

| Key | Command | Description |
|-----|---------|-------------|
| `[count] *` | multiply-length | Multiply note length by count (default 2) |
| `[count] /` | divide-length | Divide note length by count (default 2) |

### Voice Commands

| Key | Command | Description |
|-----|---------|-------------|
| `v` | `abc-voice-info-to-inline` | Convert V:1 to [V:1] |
| `V` | `abc-voice-inline-to-info` | Convert [V:1] to V:1 |
| `<a-v>` | `abc-insert-voice-line` | Insert voice line (prompts for ID) |
| `<a-V>` | `abc-add-voice` | Add new voice (prompts for ID) |

### Dynamics Commands

| Key | Command | Description |
|-----|---------|-------------|
| `<` | `abc-wrap-crescendo` | Wrap selection in crescendo markers |
| `>` | `abc-wrap-decrescendo` | Wrap selection in decrescendo markers |

### Explode Commands

| Key | Command | Description |
|-----|---------|-------------|
| `[count] x` | `abc-explode` | Explode chords into count parts (default 2) |

### Convert Commands

| Key | Command | Description |
|-----|---------|-------------|
| `r` | `abc-to-rest` | Convert selected notes to rests |
| `R` | `abc-consolidate-rests` | Consolidate consecutive rests |

---

## Count Prefix Behavior

Commands supporting count prefix use the count as follows:

| Command           | Count Meaning                   | Default |
|-------------------|---------------------------------|---------|
| `o` / `O`         | Number of octaves               | 1       |
| `<a-o>` / `<a-O>` | Number of octaves to harmonize  | 1       |
| `p` / `P`         | Number of semitones             | 1       |
| `<a-p>` / `<a-P>` | Number of diatonic steps        | 1       |
| `*`               | Multiply factor                 | 2       |
| `/`               | Divide factor                   | 2       |
| `x`               | Number of parts to explode into | 2       |

Examples:
- `2o` → transpose 2 octaves up
- `5p` → transpose 5 semitones up
- `3<a-p>` → harmonize a third up (3 diatonic steps)
- `4/` → divide note length by 4

---

## Commands Requiring Prompts

These commands cannot use count prefix and require interactive prompts:

| Key          | Command                 | Prompt                      |
|--------------|-------------------------|-----------------------------|
| `v` (select) | `abc-select-voices`     | Voice IDs (comma-separated) |
| `<a-v>`      | `abc-insert-voice-line` | Voice ID                    |
| `<a-V>`      | `abc-add-voice`         | Voice ID                    |

---

## To Do

Commands not yet implemented in the server or Kakoune plugin:

| Command               | Key     | Status                        |
|-----------------------|---------|-------------------------------|
| Add sharp accidental  | `+`     | Not in server                 |
| Add flat accidental   | `-`     | Not in server                 |
| Multiply length       | `*`     | In server, not exposed in kak |
| Divide length         | `/`     | In server, not exposed in kak |
| Harmonize octave up   | `<a-o>` | Convenience wrapper needed    |
| Harmonize octave down | `<a-O>` | Convenience wrapper needed    |

---

## Workflow Examples

### Transpose all notes up an octave

```
<select-prefix> n    → select all notes
<transform-prefix> o → transpose octave up
```

### Transpose 2 octaves down

```
<select-prefix> n     → select all notes
<transform-prefix> 2O → transpose 2 octaves down
```

### Harmonize top notes of chords a third up

```
<select-prefix> c        → select all chords
<select-prefix> t        → narrow to top notes
<transform-prefix> 3<a-p> → harmonize 3 steps up
```

### Double the length of selected notes

```
(make selection)
<transform-prefix> *  → multiply length by 2
```

### Halve the length, then halve again

```
(make selection)
<transform-prefix> /  → divide by 2
<transform-prefix> /  → divide by 2 again
```

Or equivalently:

```
<transform-prefix> 4/ → divide by 4
```

### Convert chord notes (except top) to rests

```
<select-prefix> c       → select all chords
<select-prefix> T       → all but top
<transform-prefix> r    → convert to rest
```

### Wrap a passage in crescendo

```
(make selection manually or via selectors)
<transform-prefix> <  → wrap crescendo
```

### Explode chords into 3 voice parts

```
<select-prefix> c      → select chords
<transform-prefix> 3x  → explode into 3 parts
```
