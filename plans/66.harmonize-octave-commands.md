# Plan 66: Add Harmonize Octave Commands to Kakoune Plugin

## Table of Contents

1. [Outline](#outline)
2. [Phase 1: Add Harmonize Octave Commands](#phase-1-add-harmonize-octave-commands)

---

## Outline

### Overview

The Kakoune plugin has transpose octave commands (`abc-transpose-octave-up`, `abc-transpose-octave-down`) but lacks the corresponding harmonize octave commands. We need to add `abc-harmonize-octave-up` and `abc-harmonize-octave-down` as convenience wrappers around `abc-harmonize`.

### Background

The `abc-harmonize` command takes diatonic steps as its argument:
- 3rd = 2 steps
- 4th = 3 steps
- 5th = 4 steps
- 6th = 5 steps
- Octave (8th) = 7 steps

### Commands to Add

| Command | Implementation | Description |
|---------|----------------|-------------|
| `abc-harmonize-octave-up` | `abc-harmonize 7` | Harmonize selection an octave up |
| `abc-harmonize-octave-down` | `abc-harmonize -7` | Harmonize selection an octave down |

### Phases

- Phase 1: Add the two harmonize octave commands to `abc-kak/rc/abc-transforms.kak`, test manually, commit.

### Files to Modify

- `abc-kak/rc/abc-transforms.kak`

### Testing Approach

Manual testing with a Kakoune daemon session. Verify that selecting notes and running the commands produces the expected harmonized output (original note plus a note one octave above/below).

---

## Phase 1: Add Harmonize Octave Commands

### Goal

Add two convenience commands that wrap `abc-harmonize` with octave intervals.

### Implementation

File to modify: `abc-kak/rc/abc-transforms.kak`

Add after the existing Convenience Harmonize Commands section (after `abc-harmonize-6th-down`):

```kak
define-command abc-harmonize-octave-up \
    -docstring "Harmonize selection an octave up" %{
    abc-harmonize 7
}

define-command abc-harmonize-octave-down \
    -docstring "Harmonize selection an octave down" %{
    abc-harmonize -7
}
```

### Testing

#### Running Kakoune commands from the shell (CI/testing)

Because `kak -ui dummy` does not support `execute-keys` (it hangs), we must use a real headless daemon session instead:

```sh
# Start a real headless daemon
kak -d -s "$session" &
sleep 0.3

# Send commands via kak -p
kak -p "$session" << 'CMDS'
edit /path/to/file.kak
evaluate-commands -buffer /path/to/file.kak %{
    execute-keys '...'
    nop %sh{ echo "$kak_selection" > /tmp/output }
}
quit!
CMDS

# Read output from file (kak -p is one-way, no stdout)
cat /tmp/output
```

Key points:
- `kak -d -s session` starts a real daemon (not `-ui dummy`)
- `evaluate-commands -buffer <file>` provides the context needed for `execute-keys`
- Output must be written to a file because `kak -p` cannot return data

#### Test Cases

1. Select a note `C`, run `abc-harmonize-octave-up`, verify result is `[Cc]` (chord with C and c, an octave apart)
2. Select a note `c`, run `abc-harmonize-octave-down`, verify result is `[Cc]` (chord with c and C)
3. Select multiple notes, verify each gets harmonized

### To Do

- Add `abc-harmonize-octave-up` command to `abc-transforms.kak`
- Add `abc-harmonize-octave-down` command to `abc-transforms.kak`
- Test both commands manually in Kakoune using `kak -d`
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.
