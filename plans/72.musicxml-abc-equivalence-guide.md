# MusicXML and ABC Equivalence Guide

This document provides a conceptual mapping between ABC notation semantic elements and MusicXML constructs, along with a primer on MusicXML for those unfamiliar with the format.

## Table of Contents

1. MusicXML Primer
2. Equivalence Table: ABC Interpreter Semantic Elements to MusicXML
3. ABC Constructs Missing from MusicXML
4. MusicXML Constructs Missing from ABC
5. Summary of Conversion Feasibility

---

## MusicXML Primer

MusicXML is an XML-based format for representing Western music notation. Unlike ABC which is text-oriented and human-readable, MusicXML is verbose and machine-oriented. The key structural concepts are:

### Document structure

A MusicXML file has two possible root organizations:
- `<score-partwise>`: organized by part first, then measures within parts (most common)
- `<score-timewise>`: organized by measure first, then parts within measures

Most files use `<score-partwise>`, which maps conceptually to "one instrument/voice plays its full piece, then the next instrument/voice plays its full piece."

### Core hierarchy

```xml
<score-partwise>
  <part-list>           -- declares all parts/instruments
    <score-part id="P1">
      <part-name>Violin</part-name>
    </score-part>
  </part-list>

  <part id="P1">        -- actual music for one part
    <measure number="1">
      <attributes>      -- key, meter, clef, divisions
      <note>            -- individual notes/rests
      <direction>       -- dynamics, tempo, text
      <barline>         -- bar style, repeats, volta
    </measure>
  </part>
</score-partwise>
```

### The "divisions" concept

MusicXML uses integer divisions to represent time. The `<divisions>` element specifies how many divisions equal one quarter note. For example, if `divisions=480`, then:
- quarter note = 480
- eighth note = 240
- half note = 960
- dotted quarter = 720

This is different from ABC's fractional approach (L:1/8 means eighth note is unit).

### Note representation

```xml
<note>
  <pitch>
    <step>C</step>      -- letter name
    <alter>1</alter>    -- semitone adjustment (+1=sharp, -1=flat)
    <octave>4</octave>  -- scientific octave (4 = middle C octave)
  </pitch>
  <duration>480</duration>  -- in divisions
  <type>quarter</type>      -- visual note head type
  <accidental>sharp</accidental>  -- printed accidental
  <notations>
    <tied type="start"/>
    <slur number="1" type="start"/>
    <articulations><staccato/></articulations>
  </notations>
</note>
```

The distinction between `<alter>` (the actual pitch) and `<accidental>` (what's printed) is important: a note can have `alter=1` (sounds sharp) but no `<accidental>` (because the key signature already applies it).

### Chords

MusicXML represents chords by placing multiple `<note>` elements at the same time position. All notes after the first get a `<chord/>` tag:

```xml
<note><pitch>C</pitch><duration>480</duration></note>
<note><chord/><pitch>E</pitch><duration>480</duration></note>
<note><chord/><pitch>G</pitch><duration>480</duration></note>
```

### Time navigation

The `<backup>` and `<forward>` elements move the time cursor within a measure. Because MusicXML processes notes sequentially, multiple voices in a single staff require backing up:

```xml
<!-- Voice 1: quarter C -->
<note><pitch>C</pitch><duration>480</duration><voice>1</voice></note>
<!-- Back up to start of measure -->
<backup><duration>480</duration></backup>
<!-- Voice 2: quarter E at same time -->
<note><pitch>E</pitch><duration>480</duration><voice>2</voice></note>
```

---

## Equivalence Table: ABC Interpreter Semantic Elements to MusicXML

Based on the `abcjs-ast.ts` types and MusicXML elements:

### File/Score Level

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `Tune` | `<score-partwise>` | Root container |
| `MetaText.title` | `<work><work-title>` or `<identification><creator type="title">` | MusicXML has two places for title |
| `MetaText.composer` | `<identification><creator type="composer">` | Direct mapping |
| `MetaText.rhythm` | No direct equivalent | MusicXML has no rhythm field |
| `MetaText.origin` | No direct equivalent | Could use `<miscellaneous>` |
| `MetaText.tempo` | `<direction><sound tempo="N">` | Tempo is per-measure in MusicXML |
| `TuneFormatting` properties | `<defaults>` | Page layout, scaling |

### Structure

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `StaffSystem` | Implicit in measure organization | MusicXML doesn't explicitly mark system breaks |
| `Staff` | `<part>` + `<attributes><staves>` | One part can have multiple staves |
| Voice (within staff) | `<voice>` element within notes | Voice number, not separate container |
| `BarElement` | `<barline>` | Bar styles, repeats |
| `BarType.BarLeftRepeat` | `<barline><repeat direction="forward">` | Repeat start |
| `BarType.BarRightRepeat` | `<barline><repeat direction="backward">` | Repeat end |
| `startEnding` / `endEnding` | `<barline><ending number="N" type="start/stop">` | Volta brackets |

### Attributes (at measure start)

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `KeyElement` / `KeySignature` | `<attributes><key>` | Key uses `<fifths>` (circle of fifths position) |
| `KeyRoot` + `KeyAccidental` | `<key><fifths>N</fifths><mode>major</mode>` | ABC's `K:G` = fifths=1 |
| `Mode` | `<key><mode>` | major, minor, dorian, etc. |
| `MeterElement` / `Meter` | `<attributes><time>` | Time signature |
| `MeterType.CommonTime` | `<time symbol="common">` | C symbol |
| `MeterType.CutTime` | `<time symbol="cut">` | Cut time symbol |
| `ClefElement` / `ClefProperties` | `<attributes><clef>` | Clef specification |
| `ClefType.Treble` | `<clef><sign>G</sign><line>2</line>` | Treble clef |
| `ClefType.Bass` | `<clef><sign>F</sign><line>4</line>` | Bass clef |
| `ClefType.TreblePlus8` | `<clef><sign>G</sign><line>2</line><clef-octave-change>1</clef-octave-change>` | Octave transposition |

### Notes and Pitches

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `NoteElement` | `<note>` | Main note container |
| `Pitch.pitch` (vertical pos) | `<pitch><step>` + `<octave>` | ABC uses relative, MusicXML uses absolute |
| `Pitch.accidental` | `<pitch><alter>` + `<accidental>` | MusicXML separates sound from display |
| `AccidentalType.Sharp` | `<alter>1</alter><accidental>sharp</accidental>` | |
| `AccidentalType.Flat` | `<alter>-1</alter><accidental>flat</accidental>` | |
| `AccidentalType.Natural` | `<alter>0</alter><accidental>natural</accidental>` | Explicit natural |
| `AccidentalType.DblSharp` | `<alter>2</alter><accidental>double-sharp</accidental>` | |
| `AccidentalType.QuarterSharp` | `<alter>0.5</alter><accidental>quarter-sharp</accidental>` | Microtonal |
| `NoteElement.duration` (IRational) | `<duration>` (integer) | Different systems |
| `RestProperties` | `<note><rest/>` | Rest instead of pitch |
| `RestType.Whole` | `<note><rest/><type>whole</type>` | Whole rest |
| `RestType.Multimeasure` | `<attributes><measure-style><multiple-rest>N</multiple-rest>` | Multi-measure rest |
| `RestType.Invisible` | `<note><rest/><type>...` | MusicXML has no invisible rest concept |

### Rhythm and Beaming

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `NoteElement.duration` | `<duration>` + `<type>` | MusicXML needs both |
| Dotted notes | `<dot/>` element | ABC represents via duration fraction |
| `startBeam` / `endBeam` | `<beam number="1">begin/end</beam>` | Explicit beam markers |
| `startTriplet` / `endTriplet` | `<time-modification>` + `<notations><tuplet>` | Tuplet representation |
| Broken rhythm (< >) | No equivalent | Must convert to actual durations |

### Ties and Slurs

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `Pitch.startTie` / `endTie` | `<notations><tied type="start/stop">` | Per-pitch ties |
| `Pitch.startSlur` / `endSlur` | `<notations><slur number="N" type="start/stop">` | Numbered for nesting |
| `SlurStyle.Dotted` | `<slur line-type="dotted">` | Slur styling |

### Decorations and Articulations

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `Decorations.Staccato` | `<articulations><staccato/>` | |
| `Decorations.Accent` | `<articulations><accent/>` | |
| `Decorations.Tenuto` | `<articulations><tenuto/>` | |
| `Decorations.Marcato` | `<articulations><strong-accent/>` | Different name |
| `Decorations.Fermata` | `<notations><fermata>` | |
| `Decorations.Trill` | `<ornaments><trill-mark/>` | |
| `Decorations.Mordent` | `<ornaments><mordent/>` | |
| `Decorations.Turn` | `<ornaments><turn/>` | |
| `Decorations.Upbow` | `<technical><up-bow/>` | String techniques |
| `Decorations.Downbow` | `<technical><down-bow/>` | |
| `Decorations.P/PP/F/FF/etc.` | `<direction><dynamics><p/></dynamics>` | Dynamics are directions, not note decorations |
| `Decorations.CrescendoStart/End` | `<direction><wedge type="crescendo/stop">` | Hairpins |
| `Decorations.Segno/Coda/DS/DC` | `<direction><sound segno="...">` + `<direction-type><segno/>` | Navigation markers |
| `Decorations.Arpeggio` | `<notations><arpeggiate/>` | |
| Fingerings (1,2,3,4,5) | `<technical><fingering>N</fingering>` | |

### Grace Notes

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `GraceNote` | `<note><grace/>` | Grace note marker |
| `GraceNote.acciaccatura` | `<note><grace slash="yes"/>` | Slashed grace note |

### Chord Symbols

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `ChordProperties` | `<harmony>` | Guitar chord annotations |
| `chord.root` | `<harmony><root><root-step>C</root-step>` | |
| `chord.type` | `<harmony><kind>major</kind>` | Chord quality |

### Lyrics

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `LyricProperties` | `<note><lyric>` | Attached to notes |
| `syllable` | `<lyric><text>` | Lyric text |
| `LyricDivider.Hyphen` | `<lyric><syllabic>begin/middle/end</syllabic>` | Word continuation |

### Voice Properties

| ABC Semantic Element | MusicXML Element | Notes |
|---------------------|------------------|-------|
| `VoiceProperties.name` | `<part-name>` or `<part-abbreviation>` | |
| `VoiceProperties.transpose` | `<attributes><transpose>` | |
| `VoiceProperties.perc` | `<score-part><midi-instrument>` with channel 10 | Percussion flag |
| `VoiceProperties.stems` | `<stem>up/down</stem>` on notes | Stem direction |
| `StemDirection` | `<stem>` | |

---

## ABC Constructs Missing from MusicXML

These ABC features have no direct MusicXML equivalent:

| ABC Feature | Description | Workaround |
|-------------|-------------|------------|
| `L:` (unit note length) | Base duration for unadorned notes | Compute actual durations |
| Broken rhythm (< >) | Dotted pairs shorthand | Convert to actual durations |
| Invisible rests (`x`, `y`) | Spacing without rest symbol | MusicXML rests are always visible (or use `<forward>`) |
| `%%` directives | Formatting commands | Some map to `<defaults>`, most are lost |
| `!shortphrase!` / `!mediumphrase!` / `!longphrase!` | Phrase marks | No direct equivalent |
| `!slide!` | Glissando into note | Partial support via `<glissando>` |
| `!irishroll!` | Irish ornament | No equivalent |
| Multi-tune files | Multiple tunes in one file | MusicXML is one score per file |
| Inline fields `[K:...]` | Mid-line key changes | MusicXML handles this but differently |
| Voice overlay `&` | Multiple voices on one staff line | Must use `<backup>` |
| `%%score` / `%%staves` | Staff grouping directives | Maps to `<part-group>` but less flexible |
| `Q:` field text | Tempo text like "Allegro" | Maps to `<direction><words>` separately from tempo number |
| `R:` rhythm field | Tune type (jig, reel) | No equivalent |
| `P:` parts field | AABB form notation | No direct equivalent |
| Decoration aliases | Custom decoration definitions | Not supported |
| `U:` user-defined symbols | Macro definitions | Not supported |
| `m:` macro definitions | Text substitution macros | Not supported |
| ABC text annotations | `"^text"`, `"_text"` positioning | Limited via `<direction><offset>` |

---

## MusicXML Constructs Missing from ABC

These MusicXML features have no ABC equivalent:

| MusicXML Feature | Description | ABC Gap |
|------------------|-------------|---------|
| `<figured-bass>` | Baroque figured bass notation | No ABC support |
| `<frame>` | Chord diagrams (guitar fretboard) | No ABC support |
| `<tablature>` (detailed) | Full tab notation with bends, slides | ABC has basic tab via `%%` |
| `<print>` layout | Explicit page/system breaks with positions | ABC has `%%newpage` but less control |
| `<sound>` MIDI details | Fine-grained MIDI control per note | ABC MIDI is more limited |
| `<instrument-change>` | Mid-piece instrument switch | No ABC equivalent |
| `<measure-numbering>` | Custom measure number display | No ABC control |
| `<appearance>` | Line widths, note sizes | Limited ABC formatting |
| `<encoding>` metadata | Software, date, encoder info | ABC has limited header |
| `<work>` / `<opus>` | Catalog information | Not in ABC |
| `<grouping>` | Analytic groupings | Not in ABC |
| `<lyric-font>` / `<lyric-language>` | Per-lyric styling | ABC lyrics are plain text |
| Complex tuplets | Nested tuplets like 5:4 within 3:2 | ABC handles but awkwardly |
| `<cue>` notes | Cue-sized notes | No ABC equivalent |
| `<slash>` notation | Rhythm slashes | `%%` can do this in some implementations |
| `<other-notation>` | Custom symbols | Not in ABC |
| Multi-rest display style | How to show 4-bar rest | ABC just uses `Z4` |
| `<level>` for difficulty | Editorial annotations | Not in ABC |
| `<footnote>` | Musical footnotes | Not in ABC |

---

## Summary of Conversion Feasibility

### ABC to MusicXML

- Core notation (notes, rhythms, keys, meters, articulations, dynamics) maps well
- Broken rhythms, unit lengths, voice overlays need pre-processing
- Many `%%` directives will be lost
- Multi-tune files need splitting

### MusicXML to ABC

- Core notation maps well
- Complex layouts, figured bass, detailed MIDI, cue notes will be lost
- Nested tuplets may not round-trip perfectly
- Editorial/analytic markup disappears
