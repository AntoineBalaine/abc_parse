# Kakoune Live Browser Preview Implementation

## Table of Contents

1. [Outline](#outline)
2. [Phase 1: Extract preview server to shared module](#phase-1-extract-preview-server-to-shared-module)
3. [Phase 2: Add base64 protocol support to the server](#phase-2-add-base64-protocol-support-to-the-server)
4. [Phase 3: Update monorepo build configuration](#phase-3-update-monorepo-build-configuration)
5. [Phase 4: Implement Kakoune plugin preview functionality](#phase-4-implement-kakoune-plugin-preview-functionality)

## Outline

### Goal

Enable live browser preview of ABC scores in the Kakoune editor, with automatic browser opening when an ABC file is opened, live content sync on edit, and cursor position sync.

### Architecture

The editor communicates with a preview server via a FIFO (named pipe). The server broadcasts updates to connected browser clients via WebSocket.

```
Kakoune  ---FIFO--->  Preview Server  <---WebSocket--->  Browser
```

### Protocol

The Kakoune plugin uses a line-based base64 protocol:
```
content:<filepath>:<base64 of full buffer>
cursor:<character offset>
cleanup:<filepath>
```

The server auto-detects the protocol format (JSON for nvim, base64 for kak) by checking if the line starts with `{`.

### Phases

#### Phase 1: Extract preview server to shared module

Move the preview server from `abc-lsp.nvim/preview-server/` to `abc_parse/preview-server/` as a standalone workspace module in the monorepo.

#### Phase 2: Add base64 protocol support to the server

Modify the server to detect and parse both JSON (nvim) and base64 line (kak) protocols, maintaining backwards compatibility.

#### Phase 3: Update monorepo build configuration

Add the new `preview-server` module to the monorepo's build and test configuration.

#### Phase 4: Implement Kakoune plugin preview functionality

Implement the complete preview functionality in `abc-kak/rc/abc-preview.kak`:
- FIFO creation and lifecycle management
- Server spawning with stdin redirected from FIFO
- Content updates via base64 encoding
- Cursor position sync
- Auto-open on ABC file open

## Phase 1: Extract preview server to shared module

### Goal

Copy the preview server from `abc-lsp.nvim/preview-server/` to `abc_parse/preview-server/` as a standalone workspace module in the monorepo. The existing `abc_parse/neovim-extension/preview-server/` directory (which only contains compiled files) will be removed.

### Files to create

Create the directory `abc_parse/preview-server/` with the following structure:

```
preview-server/
  src/
    server.ts      (copy from abc-lsp.nvim/preview-server/src/server.ts)
    types.ts       (copy from abc-lsp.nvim/preview-server/src/types.ts)
  templates/
    viewer.html    (copy from abc-lsp.nvim/preview-server/templates/viewer.html)
    export.html    (copy from abc-lsp.nvim/preview-server/templates/export.html)
    print.html     (copy from abc-lsp.nvim/preview-server/templates/print.html)
  package.json     (new)
  tsconfig.json    (copy from abc-lsp.nvim/preview-server/tsconfig.json)
```

### `package.json` content

```json
{
  "name": "abc-preview-server",
  "version": "1.0.0",
  "description": "Preview server for ABC music notation",
  "main": "dist/server.js",
  "scripts": {
    "build": "tsc",
    "start": "node dist/server.js",
    "dev": "nodemon --watch 'src/**/*.ts' --exec 'ts-node' src/server.ts"
  },
  "dependencies": {
    "abc-parser": "file:../parse",
    "express": "^4.18.2",
    "ws": "^8.13.0"
  },
  "devDependencies": {
    "@types/express": "^4.17.17",
    "@types/node": "^18.15.11",
    "@types/ws": "^8.5.4",
    "nodemon": "^3.1.9",
    "ts-node": "^10.9.1",
    "typescript": "^5.0.4"
  },
  "license": "MIT"
}
```

### To do

- Remove `abc_parse/neovim-extension/` directory (contains only stale compiled files)
- Create `abc_parse/preview-server/` directory structure
- Copy `src/server.ts` and `src/types.ts` from `abc-lsp.nvim/preview-server/`
- Copy `templates/` directory from `abc-lsp.nvim/preview-server/`
- Copy `tsconfig.json` from `abc-lsp.nvim/preview-server/`
- Create new `package.json` with relative path dependency on `abc-parser`
- Run `npm install` in the new module to verify dependencies resolve
- Run `npm run build` in the new module to verify compilation succeeds
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

## Phase 2: Add base64 protocol support to the server

### Goal

Modify the server to detect and parse both JSON (nvim) and base64 line (kak) protocols, maintaining backwards compatibility with the existing nvim plugin.

### Protocol format

The base64 line protocol uses the format:
```
content:<filepath>:<base64-encoded-content>
cursor:<character-offset>
cleanup:<filepath>
```

### Detection logic

Since JSON messages always start with `{` and base64 protocol messages start with a word like `content:`, detection is straightforward:

```typescript
if (line.startsWith('{')) {
  parseJsonMessage(line)
} else {
  parseBase64Message(line)
}
```

### Files to modify

`preview-server/src/server.ts`

### Changes to `server.ts`

1. Add a new function `parseBase64Message(line: string)` that:
   - Splits the line by `:` to extract the message type
   - For `content` messages: extracts filepath and base64 content, decodes content
   - For `cursor` messages: extracts the character offset
   - For `cleanup` messages: extracts the filepath

2. Modify the stdin handler to detect protocol format and dispatch to the appropriate parser

### Code changes

In the stdin `data` handler, replace:

```typescript
const message = JSON.parse(trimmed) as ServerMessage;
if (message.type === "content") { ... }
```

With:

```typescript
if (trimmed.startsWith('{')) {
  // JSON protocol (nvim)
  const message = JSON.parse(trimmed) as ServerMessage;
  handleMessage(message);
} else {
  // Base64 line protocol (kak)
  const message = parseBase64Line(trimmed);
  if (message) {
    handleMessage(message);
  }
}
```

Add the new parsing function:

```typescript
function parseBase64Line(line: string): ServerMessage | null {
  const colonIndex = line.indexOf(':');
  if (colonIndex === -1) return null;

  const type = line.substring(0, colonIndex);
  const rest = line.substring(colonIndex + 1);

  if (type === 'content') {
    const secondColon = rest.indexOf(':');
    if (secondColon === -1) return null;
    const filepath = rest.substring(0, secondColon);
    const base64Content = rest.substring(secondColon + 1);
    const content = Buffer.from(base64Content, 'base64').toString('utf8');
    return { type: 'content', path: filepath, content };
  } else if (type === 'cursor') {
    return { type: 'cursorMove', position: parseInt(rest, 10) };
  } else if (type === 'cleanup') {
    return { type: 'cleanup', path: rest };
  }

  return null;
}
```

Refactor the existing message handling code into a `handleMessage(message: ServerMessage)` function to avoid duplication.

### Testing

Since this is server-side code without existing tests, we will verify manually:
- Start the server
- Send JSON messages via stdin (verify nvim protocol still works)
- Send base64 messages via stdin (verify kak protocol works)

Example manual test:
```bash
echo '{"type":"content","path":"/test.abc","content":"X:1\nT:Test"}' | node dist/server.js
echo 'content:/test.abc:WDoxClQ6VGVzdA==' | node dist/server.js
```

### To do

- Add `parseBase64Line()` function to `server.ts`
- Refactor message handling into `handleMessage()` function
- Update stdin handler to detect and dispatch to appropriate parser
- Manual verification: JSON protocol still works
- Manual verification: base64 protocol works
- Run `npm run build` to verify compilation succeeds
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

## Phase 3: Update monorepo build configuration

### Goal

Add the new `preview-server` module to the monorepo's workspace and build configuration so that it builds alongside the other modules.

### Files to modify

`abc_parse/package.json`

### Changes to root `package.json`

1. Add `preview-server` to the workspaces array:

```json
"workspaces": [
  "parse",
  "native",
  "abc-lsp-server",
  "abc-cli",
  "vscode-extension",
  "editor",
  "preview-server"
]
```

2. Add build script for preview-server:

```json
"build:preview": "npm run build -w abc-preview-server",
```

3. Update the main `build` script to include the preview server:

```json
"build": "npm run build:parse && npm run build:editor && npm run build:native && npm run build:lsp && npm run build:cli && npm run build:vscode && npm run build:preview",
```

### To do

- Add `preview-server` to workspaces array in root `package.json`
- Add `build:preview` script
- Update `build` script to include `build:preview`
- Run `npm install` from root to link the new workspace
- Run `npm run build` from root to verify full build succeeds
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

## Phase 4: Implement Kakoune plugin preview functionality

### Goal

Implement the complete preview functionality in `abc-kak/rc/abc-preview.kak`:
- FIFO creation and lifecycle management
- Server spawning with stdin redirected from FIFO
- Content updates via base64 encoding
- Cursor position sync
- Auto-open on ABC file open

### Files to modify

`abc_parse/abc-kak/rc/abc-preview.kak`

### Configuration options

Update the existing configuration:

```kak
# Path to the preview server
declare-option -docstring "Path to the ABC preview server" \
    str abc_preview_server_path ""

# Preview server port
declare-option -docstring "Port for the ABC preview server" \
    int abc_preview_port 8088

# Session-specific FIFO path
declare-option -hidden str abc_preview_fifo ""

# Session-specific PID file
declare-option -hidden str abc_preview_pidfile ""
```

### `abc-preview-open` command

Replace the current implementation:

```kak
define-command abc-preview-open \
    -docstring "Start the ABC preview server and open in browser" %{
    evaluate-commands %sh{
        # Create session-specific paths
        fifo="/tmp/abc-preview-$kak_session.fifo"
        pidfile="/tmp/abc-preview-$kak_session.pid"

        # Clean up any existing FIFO
        rm -f "$fifo"

        # Create new FIFO
        mkfifo "$fifo"

        # Start server with stdin from FIFO
        # Use tail -f to keep FIFO open (prevents EOF when writer closes)
        tail -f "$fifo" | "$kak_opt_abc_preview_server_path" --port="$kak_opt_abc_preview_port" &
        echo $! > "$pidfile"
        disown

        # Wait briefly for server to start
        sleep 0.5

        # Store paths in options
        printf '%s\n' "set-option global abc_preview_fifo '$fifo'"
        printf '%s\n' "set-option global abc_preview_pidfile '$pidfile'"

        # Open browser
        url="http://localhost:$kak_opt_abc_preview_port/${kak_bufname##*/}"
        if command -v xdg-open >/dev/null 2>&1; then
            xdg-open "$url" &
        elif command -v open >/dev/null 2>&1; then
            open "$url" &
        fi

        printf '%s\n' "echo -markup '{Information}Preview server started on port $kak_opt_abc_preview_port'"
    }

    # Send initial content
    abc-preview-update
}
```

### `abc-preview-update` command

Replace the current placeholder:

```kak
define-command -hidden abc-preview-update %{
    evaluate-commands %sh{
        fifo="$kak_opt_abc_preview_fifo"

        # Only update if FIFO exists
        if [ -p "$fifo" ]; then
            # Get buffer content and encode as base64
            content_base64=$(printf '%s' "$kak_selection" | base64 | tr -d '\n')

            # Get absolute path of buffer
            filepath="$kak_buffile"

            # Send content message to FIFO
            printf 'content:%s:%s\n' "$filepath" "$content_base64" > "$fifo"
        fi
    }
}
```

Note: We need to select the entire buffer before calling this. We will wrap the hook to do `execute-keys '%'` first.

### `abc-preview-cursor` command

Add cursor position sync:

```kak
define-command -hidden abc-preview-cursor %{
    evaluate-commands %sh{
        fifo="$kak_opt_abc_preview_fifo"

        if [ -p "$fifo" ]; then
            # Calculate character offset from cursor position
            # kak_cursor_byte_offset gives the byte offset
            printf 'cursor:%s\n' "$kak_cursor_byte_offset" > "$fifo"
        fi
    }
}
```

### `abc-preview-close` command

Update to clean up FIFO:

```kak
define-command abc-preview-close \
    -docstring "Stop the ABC preview server" %{
    evaluate-commands %sh{
        pidfile="$kak_opt_abc_preview_pidfile"
        fifo="$kak_opt_abc_preview_fifo"

        # Kill server process
        if [ -f "$pidfile" ]; then
            pid=$(cat "$pidfile")
            if kill -0 "$pid" 2>/dev/null; then
                kill "$pid"
            fi
            rm -f "$pidfile"
        fi

        # Remove FIFO
        rm -f "$fifo"

        printf '%s\n' "set-option global abc_preview_fifo ''"
        printf '%s\n' "set-option global abc_preview_pidfile ''"
        printf '%s\n' "echo -markup '{Information}Preview server stopped'"
    }
}
```

### Hooks for live updates

Update the hooks to properly send content and cursor:

```kak
hook global WinSetOption filetype=abc %{
    # Content sync on idle
    hook buffer NormalIdle .* %{
        evaluate-commands -draft %{
            execute-keys '%'
            abc-preview-update
        }
    }
    hook buffer InsertIdle .* %{
        evaluate-commands -draft %{
            execute-keys '%'
            abc-preview-update
        }
    }

    # Cursor sync on movement
    hook buffer NormalIdle .* %{ abc-preview-cursor }
    hook buffer InsertIdle .* %{ abc-preview-cursor }
}
```

### Auto-open hook

Add automatic preview opening when an ABC file is opened:

```kak
hook global WinSetOption filetype=abc %{
    # Auto-open preview if server path is configured and not already running
    evaluate-commands %sh{
        if [ -n "$kak_opt_abc_preview_server_path" ] && [ ! -p "$kak_opt_abc_preview_fifo" ]; then
            printf '%s\n' "abc-preview-open"
        fi
    }
}
```

### Testing

#### Running Kakoune commands from the shell (CI/testing)

Because `kak -ui dummy` does not support `execute-keys` (it hangs), we must use a real headless daemon session instead:

```sh
# Start a real headless daemon
kak -d -s "$session" &
sleep 0.3

# Send commands via kak -p
kak -p "$session" << 'CMDS'
edit /path/to/file.kak
evaluate-commands -buffer /path/to/file.kak %{
    execute-keys '...'
    nop %sh{ echo "$kak_selection" > /tmp/output }
}
quit!
CMDS

# Read output from file (kak -p is one-way, no stdout)
cat /tmp/output
```

Key points:
- `kak -d -s session` starts a real daemon (not `-ui dummy`)
- `evaluate-commands -buffer <file>` provides the context needed for `execute-keys`
- Output must be written to a file because `kak -p` cannot return data

#### Manual test cases

1. FIFO creation test:
   - Start Kakoune daemon: `kak -d -s test-preview`
   - Send: `edit /tmp/test.abc` then `abc-preview-open`
   - Verify FIFO exists: `test -p /tmp/abc-preview-test-preview.fifo && echo "FIFO exists"`
   - Verify PID file exists and process is running: `kill -0 $(cat /tmp/abc-preview-test-preview.pid)`

2. Content update test:
   - With daemon running and preview open
   - Send: `execute-keys 'iX:1<ret>T:Test<esc>'` to insert content
   - Wait for NormalIdle to trigger
   - Verify server received content by checking browser shows "Test" as title

3. Browser opening test:
   - Start fresh daemon and open ABC file
   - Verify browser opens to `http://localhost:8088/<filename>`
   - Verify the rendered score appears in the browser

4. Cursor sync test:
   - With preview open and content loaded
   - Move cursor to different positions in the ABC file
   - Verify the corresponding element highlights in the browser preview

5. Cleanup test:
   - With preview running, send `abc-preview-close`
   - Verify FIFO is removed: `test ! -p /tmp/abc-preview-test-preview.fifo && echo "FIFO removed"`
   - Verify server process is terminated: `! kill -0 $(cat /tmp/abc-preview-test-preview.pid 2>/dev/null) 2>/dev/null && echo "Process stopped"`

6. Auto-open test:
   - Configure `abc_preview_server_path` option
   - Open a new ABC file
   - Verify preview automatically opens without explicit `abc-preview-open` command

### To do

- Update configuration options (add `abc_preview_fifo`)
- Implement `abc-preview-open` with FIFO creation and server spawning
- Implement `abc-preview-update` with base64 encoding
- Implement `abc-preview-cursor` for cursor sync
- Update `abc-preview-close` to clean up FIFO
- Update hooks to select full buffer before sending content
- Add auto-open hook for ABC files
- Run manual test case 1: FIFO creation
- Run manual test case 2: content update
- Run manual test case 3: browser opening
- Run manual test case 4: cursor sync
- Run manual test case 5: cleanup
- Run manual test case 6: auto-open
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.
