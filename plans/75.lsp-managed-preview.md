# LSP-Managed Preview Server Integration

## Table of Contents

1. [Outline](#outline)
2. [Phase 1: Refactor preview server to content router](#phase-1-refactor-preview-server-to-content-router)
3. [Phase 2: Add preview management to LSP server](#phase-2-add-preview-management-to-lsp-server)
4. [Phase 3: Update Kakoune plugin](#phase-3-update-kakoune-plugin)

## Outline

### Goal

Rework the preview architecture so the LSP server owns the preview server lifecycle and pushes transformed content on `didChange` events, eliminating race conditions and simplifying the Kakoune plugin.

### Architecture

```
kak-lsp  --didChange-->  LSP Server  --stdin-->  Preview Server  <--WebSocket-->  Browser
                              |
                         socket commands
                              |
                          Kakoune
                    (start/stop/cursor)
```

### Phases

#### Phase 1: Refactor preview server to content router

Remove parsing/transformation logic from the preview server. It receives pre-transformed content from the LSP and routes it to WebSocket clients.

- Remove ABCx conversion code
- Simplify input protocol: `{ type: "content", uri: string, content: string }`
- Keep WebSocket broadcast and HTML serving logic
- Keep cursor position handling

## Phase 1: Refactor preview server to content router

### Goal

Remove parsing/transformation logic from the preview server. It receives pre-transformed content from the LSP and routes it to WebSocket clients.

### Files to modify

`preview-server/src/server.ts`

### Changes

1. Remove ABCx conversion code:
   - Remove import: `import { ABCContext, convertAbcxToAbc } from "abc-parser";` (line 7)
   - Remove `isAbcxFile()` function (lines 10-12)
   - Remove `processContent()` function (lines 14-25)
   - In `handleMessage()`, replace `processContent(filePath, contentMsg.content)` with `contentMsg.content` directly (line 288)

2. Update `package.json`:
   - Remove `abc-parser` dependency (no longer needed)

3. Keep unchanged:
   - WebSocket broadcast logic
   - HTTP serving (viewer.html, export.html, print.html)
   - Slug generation and path mapping
   - Cursor position handling (`cursorMove` message type)
   - Base64 protocol support (for backwards compatibility during transition)
   - Export functionality

### Protocol

The input protocol remains unchanged:
```typescript
{ type: "content", path: string, content: string }  // content is now pre-transformed
{ type: "cursorMove", position: number }
{ type: "cleanup", path: string }
{ type: "config", ... }
```

### Testing

Example-based tests:
- Send content message, verify WebSocket clients receive it unchanged
- Send cursorMove message, verify it broadcasts to clients
- Send cleanup message, verify score is removed from maps

Manual verification:
- Start server, connect browser, send content via stdin, verify it displays

### To do

- Remove `abc-parser` import from `server.ts`
- Remove `isAbcxFile()` function
- Remove `processContent()` function
- Update `handleMessage()` to use content directly
- Remove `abc-parser` from `package.json` dependencies
- Verify build succeeds: `npm run build:preview`
- Run tests (if any exist for preview server)
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

#### Phase 2: Add preview management to LSP server

The LSP spawns and manages the preview server, tracks preview-enabled documents, and pushes content on `didChange`.

- Add child process management for preview server
- Add `Set<URI>` for tracking preview-enabled documents
- On `didChange`: if URI is preview-enabled, transform content and push to server
- Add socket commands: `abc.startPreview`, `abc.stopPreview`, `abc.previewCursor`

## Phase 2: Add preview management to LSP server

### Goal

The LSP spawns and manages the preview server, tracks preview-enabled documents, and pushes content on `didChange`.

### Files to create

`abc-lsp-server/src/PreviewManager.ts` - new module for preview management

### Files to modify

- `abc-lsp-server/src/AbcLspServer.ts` - integrate preview push on `didChange`
- `abc-lsp-server/src/socketHandler.ts` - add new socket commands
- `abc-lsp-server/src/server.ts` - wire up PreviewManager

### New module: PreviewManager

```typescript
// abc-lsp-server/src/PreviewManager.ts

import { ChildProcess, spawn } from "child_process";
import path from "path";
import { ABCContext, AbcErrorReporter, filterVoicesInAbc } from "abc-parser";

export class PreviewManager {
  previewEnabledUris: Set<string> = new Set();
  serverProcess: ChildProcess | null = null;
  port: number = 8088;

  constructor(
    private getPreviewContent: (uri: string) => string
  ) {}

  // Resolve preview server path using require.resolve
  private getServerPath(): string {
    const packagePath = require.resolve("abc-preview-server/package.json");
    return path.join(path.dirname(packagePath), "dist", "server.js");
  }

  // Start preview for a URI, spawn server if not running
  startPreview(uri: string): { port: number; slug: string }

  // Stop preview for a URI, kill server if no more previews
  stopPreview(uri: string): void

  // Push content update for a URI (called from onDidChangeContent)
  pushContentUpdate(uri: string): void

  // Forward cursor positions to preview server
  pushCursorUpdate(uri: string, positions: number[]): void

  // Check if URI has preview enabled
  isPreviewEnabled(uri: string): boolean

  // Shutdown: kill server process
  shutdown(): void
}
```

### Changes to AbcLspServer

In `onDidChangeContent()`, after `abcDocument.analyze()`:

```typescript
// If preview is enabled for this URI, push content update
if (this.previewManager?.isPreviewEnabled(uri)) {
  this.previewManager.pushContentUpdate(uri);
}
```

Add `previewManager` property and setter.

### Changes to socketHandler

Add three new method handlers:

1. `abc.startPreview`:
   - Params: `{ uri: string }`
   - Calls `previewManager.startPreview(uri)`
   - Returns: `{ port: number, slug: string, url: string }`

2. `abc.stopPreview`:
   - Params: `{ uri: string }`
   - Calls `previewManager.stopPreview(uri)`
   - Returns: `{ success: boolean }`

3. `abc.previewCursor`:
   - Params: `{ uri: string, positions: number[] }` (byte offsets for all cursors)
   - Calls `previewManager.pushCursorUpdate(uri, positions)`
   - Returns: `{ success: boolean }`

### Voice filtering

`pushContentUpdate()` applies voice filtering after getting preview content:

```typescript
pushContentUpdate(uri: string): void {
  let content = this.getPreviewContent(uri);

  // Apply voice filter if %%abcls show/hide directive present
  if (/%%abcls\s+(show|hide)/.test(content)) {
    const errorReporter = new AbcErrorReporter();
    const ctx = new ABCContext(errorReporter);
    content = filterVoicesInAbc(content, ctx);
  }

  // Send to preview server via stdin
  this.sendToServer({ type: "content", path: uriToPath(uri), content });
}
```

### Communication with preview server

The LSP writes JSON messages to the preview server's stdin:

```typescript
sendToServer(message: object): void {
  if (this.serverProcess?.stdin) {
    this.serverProcess.stdin.write(JSON.stringify(message) + "\n");
  }
}
```

### Testing

Example-based tests:
- `startPreview` spawns server on first call, returns port/slug
- `startPreview` for second URI reuses existing server
- `stopPreview` removes URI from set
- `stopPreview` for last URI kills server
- `pushContentUpdate` sends transformed content to server stdin
- `pushCursorUpdate` sends cursor positions to server stdin

Property-based tests:
- Any sequence of start/stop calls leaves consistent state
- Server process is running iff at least one URI is preview-enabled

### To do

- Create `PreviewManager.ts` with class skeleton
- Implement `getServerPath()` using `require.resolve`
- Implement `startPreview()` with child process spawning
- Implement `stopPreview()` with cleanup logic
- Implement `pushContentUpdate()` with voice filtering
- Implement `pushCursorUpdate()`
- Implement `shutdown()` for cleanup
- Add `previewManager` to `AbcLspServer`
- Update `onDidChangeContent()` to push preview updates
- Add validation functions for new socket params in `socketHandler.ts`
- Add handlers for `abc.startPreview`, `abc.stopPreview`, `abc.previewCursor`
- Wire up PreviewManager in `server.ts`
- Write tests for PreviewManager
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.

#### Phase 3: Update Kakoune plugin

Simplify the plugin to use socket commands instead of managing FIFO/server.

- Remove FIFO creation and server spawning
- Implement `abc-preview-open` using `abc.startPreview` socket command
- Implement `abc-preview-close` using `abc.stopPreview` socket command
- Simplify hooks: keep NormalIdle/InsertIdle for cursor position sync only (no content sync)
- Cursor sync sends complete list of cursor positions via `abc.previewCursor` socket command

## Phase 3: Update Kakoune plugin

### Goal

Simplify the plugin to use socket commands instead of managing FIFO/server.

### Files to modify

- `abc-kak/rc/abc-preview.kak` - rewrite to use socket commands
- `abc-kak/bin/abc-kak-client.js` - add support for generic method calls

### New implementation

```kak
# Start preview via socket command
define-command abc-preview-open \
    -docstring "Start the ABC preview and open in browser" %{
    evaluate-commands %sh{
        url=$(node "$kak_opt_abc_client_path" \
            --socket="$kak_opt_abc_socket_path" \
            --method="abc.startPreview" \
            --uri="file://$kak_buffile" 2>&1)

        if [ $? -ne 0 ]; then
            printf '%s\n' "echo -markup '{Error}$url'"
            exit 0
        fi

        # Open browser with returned URL
        if command -v xdg-open >/dev/null 2>&1; then
            xdg-open "$url" > /dev/null 2>&1 &
        elif command -v open >/dev/null 2>&1; then
            open "$url" > /dev/null 2>&1 &
        fi
    }
}

# Stop preview via socket command
define-command abc-preview-close \
    -docstring "Stop the ABC preview" %{
    evaluate-commands %sh{
        node "$kak_opt_abc_client_path" \
            --socket="$kak_opt_abc_socket_path" \
            --method="abc.stopPreview" \
            --uri="file://$kak_buffile" 2>/dev/null
    }
}

# Cursor sync via socket command
define-command -hidden abc-preview-cursor %{
    evaluate-commands %sh{
        node "$kak_opt_abc_client_path" \
            --socket="$kak_opt_abc_socket_path" \
            --method="abc.previewCursor" \
            --uri="file://$kak_buffile" \
            --positions="$kak_selections_byte_offsets" 2>/dev/null
    }
}

# Hooks for cursor sync only
hook global WinSetOption filetype=abc %{
    hook buffer NormalIdle .* %{ abc-preview-cursor }
    hook buffer InsertIdle .* %{ abc-preview-cursor }
}
```

### Changes to abc-kak-client.js

Add support for generic method calls:
- New option: `--method=<method>` for arbitrary socket methods
- New option: `--positions=...` for cursor positions
- Output for `abc.startPreview`: the URL string (to stdout)
- Output for other methods: none

### Removed code

- All configuration options (port, fifo, pidfile, slug, server_path)
- FIFO creation/management
- Server spawning logic
- Base64 encoding
- PID file management
- Content sync hooks
- Status command

### Testing

Manual test cases:
1. Open ABC file, run `abc-preview-open`, verify browser opens
2. Edit file, verify preview updates
3. Move cursor, verify highlighting syncs
4. Multiple selections, verify all cursors sync
5. Run `abc-preview-close`

### To do

- Update `abc-kak-client.js` to support `--method` for generic calls
- Rewrite `abc-preview.kak` with socket-based commands
- Remove all FIFO/server/state management code
- Update hooks to only sync cursor
- Test manual cases
- Final verification: build and tests both pass
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.
