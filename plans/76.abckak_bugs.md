Abc-kak bugs:

- X rests (invisible multi-measure rests) arent selected by hz (rest selector)
- tunes aren't selected by hx (tune selector)
- measures selector doesn't seem to work across every line of every system - some selections are incomplete, some single-bar lines aren't selected at all.
- voices selector with prompt: `1:2: 'abc-select-voices': 2:5: 'abc-select-impl': wrong argument count`
- numbered selectors (nth from top):I get error: `Invalid JSON in --args`

---

# Analysis

## Bug 1: X rests not selected by `hz` (rest selector)

The `isRest()` function in `editor/src/csTree/types.ts:86-88` only checks for `TAGS.Rest`:

```typescript
export function isRest(node: CSNode): boolean {
  return node.tag === TAGS.Rest;
}
```

It does not include `TAGS.MultiMeasureRest`. The `measureSelector.ts:32` correctly includes `MultiMeasureRest` in its `isMusicElement()` check, so the pattern exists elsewhere in the codebase.

## Bug 2: Tunes not selected by `hx` (tune selector)

In `structureSelectors.ts`, the `selectTune()` function has a logic issue. At line 14:

```typescript
if (nowInScope && current.tag === TAGS.Tune) {
```

The condition requires both `nowInScope` AND the node being a Tune. Because the walk starts with `inScope=false` at the root, and `nowInScope` is only true when `ctx.cursor.has(current.id)`, Tune nodes will only be selected if the cursor already points to the Tune node itself, not if the cursor points to something inside the tune.

The intended behavior: if the cursor is on any descendant of a Tune, we should select that Tune.

## Bug 3: Measures selector incomplete on some lines

The `measureSelector.ts` logic appears correct - it recurses into `System` and `Music_code` nodes. The bug likely stems from how the CSTree structures multi-line content. We need a concrete example to determine whether the tree structure is the issue or whether there is a scoping problem in `isInScope()` checks.

## Bug 4: Voices selector - "wrong argument count"

In `abc-selectors.kak:136`:
```kak
abc-select-impl selectVoices "[\"$1\"]"
```

The shell quoting passes `["voice-ids"]` to `--args`. The error "wrong argument count" suggests the issue is in the LSP server's `validateApplySelectorParams()` or in how `selectVoices` expects its arguments.

## Bug 5: Numbered selectors - "Invalid JSON in --args"

In `abc-selectors.kak:155`:
```kak
abc-select-impl selectNthFromTop "[$1]"
```

When this gets to the shell at line 44:
```sh
--args="$args" \
```

The `$args` variable becomes `[1]`. The JSON parsing at `abc-kak-client.ts:145` fails. The shell quoting may be mangling the JSON when `$args` contains brackets.
