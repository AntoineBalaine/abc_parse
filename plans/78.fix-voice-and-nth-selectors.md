# Fix Voice and Nth-from-top Selectors (Bugs 4 and 5)

## Table of Contents

- Outline
- Phase 1: Fix voice selector argument quoting
- Phase 2: Fix nth-from-top selector JSON parsing

---

## Outline

### Phase 1: Fix voice selector "wrong argument count" error

The error `1:2: 'abc-select-voices': 2:5: 'abc-select-impl': wrong argument count` is a Kakoune error, not a Node.js error. The issue is in `abc-kak/rc/abc-modes.kak` line 60:

```kak
map global abc-select v ':prompt "Voice IDs: " %{ abc-select-voices %val{text} }<ret>'
```

When the user enters a value with spaces (e.g., `1 2` for multiple voices), `%val{text}` is not quoted. Kakoune splits it into multiple arguments, but `abc-select-voices` is defined with `-params 1` (expects exactly 1 argument).

Changes:
- Quote `%val{text}` in the prompt mapping: `"%val{text}"`

Testing:
- Manual test via Kakoune headless: enter voice IDs with spaces, verify no argument count error
- Manual test: enter single voice ID, verify it still works

### Phase 2: Fix nth-from-top selector "Invalid JSON" error

The error `Invalid JSON in --args` comes from `abc-kak/src/abc-kak-client.ts` line 147. The issue is likely with shell quoting when passing the JSON array through multiple layers.

In `abc-kak/rc/abc-selectors.kak` line 155:
```kak
abc-select-impl selectNthFromTop "[$1]"
```

The `"[$1]"` creates a Kakoune string that, when passed through the shell block, may lose or gain characters depending on shell interpretation.

Possible causes:
- Shell word splitting or glob expansion on `[]` characters
- Quoting inconsistencies between Kakoune and shell

Changes:
- Investigate the exact value received by the client (add debug logging)
- Ensure proper escaping of the JSON array through all layers
- May need to escape brackets or use single quotes in the shell block

Testing:
- Manual test via Kakoune headless: select nth note from chord, verify no JSON error
- Test with various index values (1, 2, 9)

---

Copy this plan file into the plans directory. After each phase:
- Final verification: build and tests both pass.
- Call the code review agent. Address any feedback.
- Commit once the build passes and all tests pass.
