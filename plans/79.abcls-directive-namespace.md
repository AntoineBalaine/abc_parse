# Rename ABCLS Directives to Use Consistent Namespace

## Table of Contents

1. [Overview](#overview)
2. [Outline](#outline)
3. [Phase 1: Rename `%%abcls` to `%%abcls-voices`](#phase-1)
4. [Phase 2: Rename `%%linear` to `%%abcls-parse linear`](#phase-2)

---

## Overview

This plan renames the ABCLS-specific directives to use a consistent hyphenated namespace:

| Current Syntax | New Syntax | Purpose |
|----------------|------------|---------|
| `%%abcls show V1 V2` | `%%abcls-voices show V1 V2` | Voice filtering for preview |
| `%%abcls hide Bass` | `%%abcls-voices hide Bass` | Voice filtering for preview |
| `%%linear true` | `%%abcls-parse linear` | Enable linear (interleaved) parsing mode |
| `%%linear false` | (removed) | Default is non-linear; directive absence means false |
| `%%linear 1` | `%%abcls-parse linear` | Enable linear mode |
| `%%linear 0` | (removed) | Default is non-linear |

The existing `%%abcls-fmt` directive remains unchanged.

No backwards compatibility is maintained.

---

## Outline

### Phase 1: Rename `%%abcls` to `%%abcls-voices`

Update all components that reference the `%%abcls` directive to use `%%abcls-voices`.

Components to update:
- `directive-specs.ts`: Rename spec entry and type
- `directive-analyzer.ts`: Update switch case and function name
- `VoiceFilterVisitor.ts`: Update directive key checks
- `AbcRenderer.ts`: Update string/regex checks
- `PreviewManager.ts`: Update regex check
- Test files: `abcls_directive.spec.ts`, `VoiceFilterVisitor.spec.ts`
- Generators: `scn_infoln_generators.ts`, `prs_pbt.generators.spec.ts`

Testing:
- Example-based: Verify scanner tokenizes `%%abcls-voices show V1` correctly, parser creates correct AST, analyzer extracts correct semantic data
- Property-based: Generated `%%abcls-voices` directives parse and analyze correctly

### Phase 2: Rename `%%linear` to `%%abcls-parse linear`

Replace the boolean-parameter `%%linear` directive with a flag-style `%%abcls-parse linear` directive.

Because `%%abcls-parse` is handled as a special case in the parser (like `%%linear` currently is), we only update:
- `parseDirective.ts`: Rename `checkLinearDirective` to `checkParseDirective`, update logic to check for `abcls-parse` key with `linear` value (case-insensitive)
- `directive-specs.ts`: Remove the `linear` entry (no longer needed)
- `directive-analyzer.ts`: Remove the `case "linear":` switch case (no longer needed)
- Test file: Rename `linear-directive.spec.ts` to `abcls-parse-directive.spec.ts`, update all test cases

Testing:
- Example-based: Verify `%%abcls-parse linear` sets file/tune linear flag to true, absence means false, invalid options report errors
- Property-based: File structure and tune linear flags are correctly set based on directive presence

---

## Design Decisions

1. `%%abcls-parse` only supports `linear` for now. Future options can be added later.

2. `%%abcls-parse linear` is case-insensitive (accepts `LINEAR`, `Linear`, etc.).

3. `%%abcls-parse` is handled as a special case in the parser only (like `%%linear` currently is). We do not add it to `DIRECTIVE_SPECS` or `directive-analyzer.ts`.

---

## Phase 1: Rename `%%abcls` to `%%abcls-voices`

### Goal

Rename the voice filtering directive from `%%abcls show/hide` to `%%abcls-voices show/hide` across all components.

### Files to Modify

#### 1. `parse/types/directive-specs.ts`

Location: Lines 267-272, 516

Changes:
- Rename the `DIRECTIVE_SPECS` entry from `abcls` to `abcls-voices`
- Rename the `AbclsDirectiveData` interface to `AbclsVoicesDirectiveData`
- Update the `DirectiveSemanticData` union type entry from `{ type: "abcls"; data: AbclsDirectiveData }` to `{ type: "abcls-voices"; data: AbclsVoicesDirectiveData }`

#### 2. `parse/analyzers/directive-analyzer.ts`

Location: Lines 4, 213-214, 1895-1944

Changes:
- Update import: `AbclsDirectiveData` to `AbclsVoicesDirectiveData`
- Update switch case from `case "abcls":` to `case "abcls-voices":`
- Rename function from `parseAbclsDirective` to `parseAbclsVoicesDirective`
- Update all error messages from `"abcls directive..."` to `"abcls-voices directive..."`
- Update the return type field from `type: "abcls"` to `type: "abcls-voices"`

#### 3. `parse/Visitors/VoiceFilterVisitor.ts`

Location: Lines 4, 8, 121-128, 135, 254-256, 280-285, 396-423

Changes:
- Update all string comparisons from `"abcls"` to `"abcls-voices"`
- Update all comments from `%%abcls` to `%%abcls-voices`
- Update the type check from `result.type === "abcls"` to `result.type === "abcls-voices"`

#### 4. `vscode-extension/src/renderer/AbcRenderer.ts`

Location: Lines 253, 262, 267-268

Changes:
- Update comment from `%%abcls directive` to `%%abcls-voices directive`
- Update regex/string check from `"%%abcls"` to `"%%abcls-voices"`

#### 5. `abc-lsp-server/src/PreviewManager.ts`

Location: Lines 169-170

Changes:
- Update comment from `%%abcls show/hide directive` to `%%abcls-voices show/hide directive`
- Update regex from `/%%abcls\s+(show|hide)/` to `/%%abcls-voices\s+(show|hide)/`

#### 6. `parse/tests/abcls_directive.spec.ts`

Rename file to `abcls-voices_directive.spec.ts`.

Changes:
- Update all test descriptions from `%%abcls` to `%%abcls-voices`
- Update all test input strings from `%%abcls` to `%%abcls-voices`
- Update all token lexeme assertions from `"abcls"` to `"abcls-voices"`
- Update all semantic type assertions from `"abcls"` to `"abcls-voices"`

#### 7. `parse/tests/VoiceFilterVisitor.spec.ts`

Changes:
- Update all test input strings from `%%abcls` to `%%abcls-voices`
- Update all assertion strings checking for directive removal

#### 8. `parse/tests/scn_infoln_generators.ts`

Location: Lines 615-630

Changes:
- Update generator comment from `%%abcls directive` to `%%abcls-voices directive`
- Update the generated directive name from `"abcls"` to `"abcls-voices"`

#### 9. `parse/tests/prs_pbt.generators.spec.ts`

Location: Lines 397, 510-519

Changes:
- Update comment from `%%abcls show/hide directive` to `%%abcls-voices show/hide directive`
- Update the generated directive key from `"abcls"` to `"abcls-voices"`

### Testing

#### Example-based Tests (in `abcls-voices_directive.spec.ts`)

Scanner tests:
- `%%abcls-voices show V1 V2` tokenizes as `[STYLESHEET_DIRECTIVE, IDENTIFIER("abcls-voices"), WS, IDENTIFIER("show"), WS, IDENTIFIER("V1"), WS, IDENTIFIER("V2")]`
- `%%abcls-voices hide Melody` tokenizes correctly

Parser tests:
- `%%abcls-voices show V1 V2` creates `Directive` AST with `key.lexeme === "abcls-voices"`
- Values array contains mode and voice ID tokens

Analyzer tests:
- `%%abcls-voices show V1 V2` produces `{ type: "abcls-voices", data: { mode: "show", voiceIds: ["V1", "V2"] } }`
- `%%abcls-voices hide Bass` produces `{ type: "abcls-voices", data: { mode: "hide", voiceIds: ["Bass"] } }`
- Missing mode reports error
- Invalid mode reports error

#### Property-based Tests

Properties to verify:
- All generated `%%abcls-voices` directives parse into valid `Directive` AST nodes with `key.lexeme === "abcls-voices"`
- All generated `%%abcls-voices` directives produce valid semantic data with `type === "abcls-voices"`
- The number of voice IDs in semantic data matches the number of voice ID tokens in the directive

### To Do List

1. Rename `parse/tests/abcls_directive.spec.ts` to `parse/tests/abcls-voices_directive.spec.ts`
2. Update `parse/types/directive-specs.ts`: rename spec entry, interface, and type union entry
3. Update `parse/analyzers/directive-analyzer.ts`: switch case, function name, error messages, return type
4. Update `parse/Visitors/VoiceFilterVisitor.ts`: all string comparisons and comments
5. Update `vscode-extension/src/renderer/AbcRenderer.ts`: comment and string check
6. Update `abc-lsp-server/src/PreviewManager.ts`: comment and regex
7. Update `parse/tests/abcls-voices_directive.spec.ts`: all test descriptions, inputs, and assertions
8. Update `parse/tests/VoiceFilterVisitor.spec.ts`: all test input strings
9. Update `parse/tests/scn_infoln_generators.ts`: generator comment and directive name
10. Update `parse/tests/prs_pbt.generators.spec.ts`: comment and directive key
11. Final verification: build and tests both pass
12. Call the code review agent. Address any feedback.
13. Commit once the build passes and all tests pass.

---

## Phase 2: Rename `%%linear` to `%%abcls-parse linear`

### Goal

Replace the boolean-parameter `%%linear` directive with a flag-style `%%abcls-parse linear` directive. Because `%%abcls-parse` is handled as a special case in the parser (like `%%linear` currently is), we do not add it to `DIRECTIVE_SPECS` or `directive-analyzer.ts`.

### Syntax Change

| Old | New |
|-----|-----|
| `%%linear true` | `%%abcls-parse linear` |
| `%%linear false` | (removed - absence means false) |
| `%%linear 1` | `%%abcls-parse linear` |
| `%%linear 0` | (removed - absence means false) |

### Files to Modify

#### 1. `parse/parsers/infoLines/parseDirective.ts`

Lines 74-110

Changes:
- Rename function `checkLinearDirective` to `checkParseDirective`
- Update the key check from `directive.key.lexeme.toLowerCase() !== "linear"` to `directive.key.lexeme.toLowerCase() !== "abcls-parse"`
- Change the value parsing logic:
  - Instead of checking for `true/false/1/0`, check that the first value is the identifier `linear` (case-insensitive)
  - If `linear` is present, set the boolean to `true`
  - If the value is missing or not `linear`, return early (invalid directive, semantic analyzer can report error if needed)

Current logic:
```
if key !== "linear": return
if no values: return
if value is "true" or "1": boolValue = true
if value is "false" or "0": boolValue = false
set context flag
```

New logic:
```
if key !== "abcls-parse": return
if no values: return
if first value is identifier "linear" (case-insensitive):
  set context flag to true
```

#### 2. `parse/types/directive-specs.ts`

Lines 151, 466

Changes:
- Remove the `linear: { params: [{ type: "boolean" }] }` entry from `DIRECTIVE_SPECS`
- Remove the `{ type: "linear"; data: boolean }` entry from `DirectiveSemanticData` union

#### 3. `parse/analyzers/directive-analyzer.ts`

Lines 113-119

Changes:
- Remove `case "linear":` from the switch statement (it currently calls `parseBooleanValue`)

#### 4. `parse/tests/linear-directive.spec.ts`

Rename file to `parse/tests/abcls-parse-directive.spec.ts`.

Changes:
- Update all test descriptions from `%%linear` to `%%abcls-parse linear`
- Update all test input strings:
  - `%%linear true` becomes `%%abcls-parse linear`
  - `%%linear false` tests removed (or test that absence means false)
  - `%%linear 1` becomes `%%abcls-parse linear`
  - `%%linear 0` tests removed
- Update test logic:
  - Tests for `true/1` become tests for presence of `%%abcls-parse linear`
  - Tests for `false/0` become tests for absence of the directive
  - Tests for invalid values (e.g., `%%linear foo`) become tests for invalid options (e.g., `%%abcls-parse foo`)
- Remove the `DIRECTIVE_SPECS` tests since `abcls-parse` is not in the specs
- Remove the analyzer tests since `abcls-parse` is not handled by the analyzer

### Testing

#### Example-based Tests

File-level directive:
- `%%abcls-parse linear\n\nX:1\nK:C\nCDEF|` sets `fileStructure.linear` to `true`
- `%%abcls-parse LINEAR\n\nX:1\nK:C\nCDEF|` sets `fileStructure.linear` to `true` (case-insensitive)
- `X:1\nK:C\nCDEF|` (no directive) keeps `fileStructure.linear` as `false`

Tune-level directive:
- `X:1\n%%abcls-parse linear\nK:C\nCDEF|` sets `tune.linear` to `true`
- Tune inherits file-level value when no tune-level directive present

Override behavior:
- File `%%abcls-parse linear` + tune without directive: tune.linear is `true`
- File without directive + tune `%%abcls-parse linear`: tune.linear is `true`, file.linear is `false`

Invalid options:
- `%%abcls-parse foo` keeps default `false` (invalid option ignored)
- `%%abcls-parse` (no option) keeps default `false`

#### Property-based Tests

- File structure linear flag is `true` if and only if `%%abcls-parse linear` appears in file header
- Tune linear flag is `true` if `%%abcls-parse linear` appears in tune header, or inherits from file if not present

### To Do List

1. Rename `parse/tests/linear-directive.spec.ts` to `parse/tests/abcls-parse-directive.spec.ts`
2. Update `parse/parsers/infoLines/parseDirective.ts`: rename function, update key check, change value parsing logic
3. Update `parse/types/directive-specs.ts`: remove `linear` entry from specs and type union
4. Update `parse/analyzers/directive-analyzer.ts`: remove `case "linear":` switch case
5. Update `parse/tests/abcls-parse-directive.spec.ts`: all test descriptions, inputs, and assertions
6. Final verification: build and tests both pass
7. Call the code review agent. Address any feedback.
8. Commit once the build passes and all tests pass.
